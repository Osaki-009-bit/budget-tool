<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>轻记账｜客观统计工具</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#f6f7fb;}
    .wrap{max-width:980px;margin:0 auto;padding:16px;}
    .layout{display:flex;gap:12px;align-items:flex-start;}
    .sidebar{
      width:210px;flex:0 0 210px;
      position:sticky;top:12px;
      background:#fff;border-radius:16px;padding:12px;
      box-shadow:0 6px 18px rgba(0,0,0,.06);
    }
    .side-title{font-weight:800;font-size:14px;margin:2px 0 10px;}
    .muted{color:#666;font-size:13px;line-height:1.5;margin-top:12px;}
    .main{flex:1;min-width:0;}
    .card{background:#fff;border-radius:16px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.06);}
    h1{font-size:18px;margin:0 0 6px;}
    .sub{color:#666;font-size:13px;margin:0 0 14px;line-height:1.5;}
    label{display:block;font-size:14px;margin:12px 0 6px;}
    input{width:100%;font-size:16px;padding:12px;border:1px solid #ddd;border-radius:12px;box-sizing:border-box;color:#111;}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;align-items:center;}
    .btn{font-size:14px;padding:10px 12px;border:0;border-radius:12px;background:#eef0f7;cursor:pointer;}
    .btn-primary{background:#111;color:#fff;flex:1;min-width:160px;}
    .btn-mini{font-size:12px;padding:6px 10px;border-radius:10px;}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px;}
    .chip{padding:8px 10px;border-radius:999px;border:1px solid #ddd;background:#fff;font-size:13px;cursor:pointer;}
    .chip.on{background:#111;color:#fff;border-color:#111;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px;}
    .box{background:#fafbff;border:1px solid #eef0ff;border-radius:12px;padding:10px;}
    .k{color:#666;font-size:13px;}
    .v{font-size:18px;font-weight:800;margin-top:2px;}
    details{margin-top:14px;}
    summary{cursor:pointer;font-size:14px;}

    /* ===== 左侧：账本（隔离单元） ===== */
    .book-box{
      border:1px solid #e6e6e6;border-radius:16px;padding:12px;margin-bottom:12px;background:#fff;
    }
    .book-label{font-size:12px;color:#666;margin-bottom:8px;}
    .book-select{
      width:100%;
      font-size:18px;
      font-weight:900;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid #ddd;
      cursor:pointer;
      background:#fff;
      box-sizing:border-box;
    }
    .book-actions{display:flex;gap:8px;margin-top:10px;}
    .book-actions .btn{flex:1;padding:10px 10px;font-size:13px;border-radius:12px;}
    .book-hint{font-size:12px;color:#666;margin-top:8px;line-height:1.4;}

    /* ===== 大币种选择 ===== */
    .currency-box{
      border:1px solid #e6e6e6;border-radius:16px;padding:12px;margin-bottom:12px;background:#fff;
    }
    .currency-label{font-size:12px;color:#666;margin-bottom:8px;}
    .currency-select{
      width:100%;
      font-size:22px;
      font-weight:900;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid #ddd;
      cursor:pointer;
      background:#fff;
      box-sizing:border-box;
    }
    .currency-hint{font-size:12px;color:#666;margin-top:8px;line-height:1.4;}

    /* ===== 语言选择 ===== */
    .lang-box{
      border:1px solid #e6e6e6;border-radius:16px;padding:12px;margin-bottom:12px;background:#fff;
    }
    .lang-label{font-size:12px;color:#666;margin-bottom:8px;}
    .lang-select{
      width:100%;
      font-size:16px;
      font-weight:800;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid #ddd;
      cursor:pointer;
      background:#fff;
      box-sizing:border-box;
    }
    .lang-hint{font-size:12px;color:#666;margin-top:8px;line-height:1.4;}

    /* ===== 月份列表 ===== */
    .month-nav{display:flex;flex-direction:column;gap:6px;}
    .month-item{
      border:1px solid #e6e6e6;background:#fff;border-radius:12px;
      padding:10px 10px;cursor:pointer;text-align:left;
      display:flex;justify-content:space-between;align-items:center;gap:8px;
      font-size:14px;
    }
    .month-item small{color:#666;font-size:12px;}
    .month-item.active{border-color:#111;background:#111;color:#fff;}
    .month-item.active small{color:#ddd;}

    /* ====== 本月状态日历（今天蓝 / 修改红 / 有记录绿 / 未记录白） ====== */
    #monthCalendar{
      margin-top:8px;
      display:grid;
      grid-template-columns:repeat(7, 1fr);
      gap:6px;
    }
    .day-cell{
      padding:8px 0;
      text-align:center;
      border-radius:10px;
      font-size:13px;
      cursor:pointer;
      border:1px solid #ddd;
      user-select:none;
      position:relative;
    }
    .day-today{ background:#1976d2; color:#fff; font-weight:800; border-color:#1976d2; }
    .day-edited{ background:#fdecea; color:#c62828; font-weight:800; }
    .day-recorded{ background:#e8f5e9; color:#2e7d32; font-weight:800; }
    .day-empty{ background:#ffffff; color:#333; }
    .day-pad{ visibility:hidden; }

    /* 当前选中日期蓝描边（不改底色） */
    .day-selected{
      box-shadow:0 0 0 2px #1976d2 inset;
      border-color:#1976d2;
    }
    .day-today.day-selected{
      box-shadow:0 0 0 2px rgba(255,255,255,.85) inset;
    }

    /* 左侧颜色说明 */
    .legend{ margin-top:12px; border-top:1px solid #f0f0f0; padding-top:10px; }
    .legend-title{font-weight:800;font-size:13px;margin:0 0 8px;}
    .legend-item{display:flex;align-items:center;gap:8px;margin:6px 0;font-size:13px;color:#333;}
    .legend-swatch{width:14px;height:14px;border-radius:4px;border:1px solid #ddd;flex:0 0 14px;}
    .sw-blue{background:#1976d2;border-color:#1976d2;}
    .sw-red{background:#fdecea;border-color:#c62828;}
    .sw-green{background:#e8f5e9;border-color:#2e7d32;}
    .sw-white{background:#ffffff;border-color:#ddd;}

    /* ===== 确认修改：默认灰禁用，变更后黑可点 ===== */
    .btn-confirm{
      font-size:14px;
      padding:10px 14px;
      border:0;border-radius:12px;
      background:#111;color:#fff;
      cursor:pointer;
      min-width:140px;
      flex:0 0 auto;
    }
    .btn-confirm:disabled{
      background:#e0e0e0;
      color:#888;
      cursor:not-allowed;
    }
    .btn-cancel{
      font-size:14px;
      padding:10px 14px;
      border:0;border-radius:12px;
      background:#f0f0f0;
      cursor:pointer;
      min-width:140px;
      flex:0 0 auto;
    }

    /* 计算器弹窗 / 通用弹窗 */
    .modal-mask{
      position:fixed; inset:0;
      background:rgba(0,0,0,.35);
      display:none; align-items:center; justify-content:center;
      padding:16px;
      z-index:999;
    }
    .modal{
      width:min(520px, 100%);
      background:#fff;
      border-radius:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.18);
      padding:14px;
    }
    .modal-hd{display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .modal-title{font-weight:800;}
    .modal-close{border:0;background:#eef0f7;border-radius:12px;padding:8px 10px;cursor:pointer;}

    .calc-screen{
      margin-top:10px;
      border:1px solid #ddd;
      border-radius:12px;
      padding:10px;
      background:#fafafa;
    }
    .calc-expr{font-size:14px; color:#666; min-height:18px; word-break:break-all;}
    .calc-val{font-size:22px; font-weight:900; margin-top:4px; min-height:28px;}
    .calc-grid{
      margin-top:10px;
      display:grid;
      grid-template-columns:repeat(4, 1fr);
      gap:8px;
    }
    .calc-btn{
      border:0; border-radius:12px;
      padding:14px 10px;
      background:#eef0f7;
      font-size:16px;
      cursor:pointer;
    }
    .calc-btn.op{background:#111;color:#fff;}
    .calc-btn.warn{background:#ffe9e9;}
    .calc-actions{display:flex; gap:10px; margin-top:10px;}
    .calc-actions .btn-primary{flex:1;}

    /* ===== 首次：输入账本名称弹窗 ===== */
    .gate-mask{
      position:fixed; inset:0;
      background:rgba(0,0,0,.40);
      display:none; align-items:center; justify-content:center;
      padding:16px;
      z-index:1000;
    }
    .gate{
      width:min(520px, 100%);
      background:#fff;
      border-radius:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.18);
      padding:16px;
    }
    .gate h2{margin:0 0 6px;font-size:18px;}
    .gate p{margin:0 0 12px;color:#666;font-size:13px;line-height:1.5;}
    .gate input{
      width:100%;
      font-size:18px;
      padding:12px;
      border:1px solid #ddd;border-radius:12px;
      box-sizing:border-box;
    }
    .gate .row{margin-top:12px;}
    .gate small{display:block;margin-top:8px;color:#666;line-height:1.4;}

    /* 保存提示 */
    .btn-primary.saved{ background:#2e7d32 !important; }

    /* ====== 税务提醒：按钮 + 倒计时（更明显） ====== */
    .tax-card{
      border:1px solid #e6e6e6;
      background:#fff;
      border-radius:16px;
      padding:12px;
      margin:10px 0 12px;
    }
    .tax-bar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .tax-btn{
      border:0;
      border-radius:12px;
      background:#111;
      color:#fff;
      padding:10px 12px;
      cursor:pointer;
      font-weight:900;
      font-size:14px;
      flex:0 0 auto;
      min-width:120px;
    }
    .tax-countdown{
      flex:1;
      text-align:right;
      font-weight:900;
      font-size:14px;
      color:#111;
      padding:10px 12px;
      border-radius:12px;
      background:#f6f7fb;
      border:1px solid #e6e6e6;
    }
    .tax-panel{
      margin-top:10px;
      padding-top:10px;
      border-top:1px dashed #e6e6e6;
    }
    .tax-title{font-weight:900;margin:0 0 6px;}
    .tax-lines{color:#333;font-size:13px;line-height:1.7;}
    .tax-note{margin-top:8px;color:#666;font-size:12px;line-height:1.5;}
    .tax-row{display:flex;gap:16px;flex-wrap:wrap;align-items:center;margin-top:8px;}
    .tax-row label{margin:0;font-size:13px;display:flex;align-items:center;gap:6px;}

    /* ===== 月份标题：可点击打开月份选择器 ===== */
    .months-title-btn{
      width:100%;
      text-align:left;
      border:0;
      background:transparent;
      padding:0;
      font-weight:800;
      font-size:14px;
      margin:2px 0 10px;
      cursor:pointer;
    }

    @media (max-width: 820px){
      .wrap{max-width:720px;}
      .layout{flex-direction:column;}
      .sidebar{width:100%;flex:0 0 auto;position:static;}
      .month-nav{flex-direction:row;overflow:auto;gap:8px;padding-bottom:2px;}
      .month-item{white-space:nowrap;min-width:140px;}
      .legend{border-top:none;padding-top:0;margin-top:8px;}
      .currency-box,.book-box,.lang-box{margin-bottom:10px;}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="layout">

      <aside class="sidebar">

        <!-- 语言选择 -->
        <div class="lang-box">
          <div class="lang-label" data-i18n="lang_label">语言</div>
          <select id="langSelect" class="lang-select">
            <option value="zh">中文</option>
            <option value="en">English</option>
            <option value="ja">日本語</option>
            <option value="ko">한국어</option>
            <option value="vi">Tiếng Việt</option>
            <option value="hi">हिन्दी</option>
          </select>
          <div class="lang-hint" data-i18n="lang_hint">切换语言仅影响界面文字，不影响你已保存的数据。</div>
        </div>

        <!-- 账本选择（数据隔离核心） -->
        <div class="book-box">
          <div class="book-label" data-i18n="book_current">当前账本</div>
          <select id="bookSelect" class="book-select"></select>
          <div class="book-actions">
            <button class="btn" id="bookNewBtn" type="button" data-i18n="book_new">新建</button>
            <button class="btn" id="bookDelBtn" type="button" data-i18n="book_delete">删除</button>
          </div>
          <div class="book-hint" data-i18n="book_hint">每个账本的数据独立存储，不会互相串联。</div>
        </div>

        <!-- 大币种下拉 -->
        <div class="currency-box">
          <div class="currency-label" data-i18n="currency_current">当前币种</div>
          <select id="currencySelect" class="currency-select">
            <option value="CAD">CAD</option>
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
            <option value="GBP">GBP</option>
            <option value="JPY">JPY</option>
            <option value="CNY">CNY</option>
          </select>
          <div class="currency-hint" data-i18n="currency_hint">切换后仅改变显示单位，不做汇率换算。</div>
        </div>

        <!-- 月份：标题可点击打开“月份选择器” -->
        <button class="months-title-btn" id="openMonthPickerBtn" type="button" data-i18n="months_title">月份</button>
        <div class="month-nav" id="monthNav"></div>

        <div class="muted" style="margin-top:10px;" data-i18n="months_tip">
          仅显示“有记录的过往月份”和“当前月”。点击月份可回看/修改该月数据。
        </div>

        <div class="legend">
          <div class="legend-title" data-i18n="legend_title">颜色说明</div>
          <div class="legend-item"><span class="legend-swatch sw-green"></span><span data-i18n="legend_green">绿色框 = 已填写</span></div>
          <div class="legend-item"><span class="legend-swatch sw-red"></span><span data-i18n="legend_red">红色框 = 有修改</span></div>
          <div class="legend-item"><span class="legend-swatch sw-blue"></span><span data-i18n="legend_blue">蓝色框 = 今日</span></div>
          <div class="legend-item"><span class="legend-swatch sw-white"></span><span data-i18n="legend_white">白色框 = 未填写</span></div>
        </div>
      </aside>

      <main class="main">
        <div class="card">
          <h1 data-i18n="app_title">轻记账（客观统计）</h1>
          <p class="sub" id="dateLine">—</p>

          <!-- 税务提醒：按钮 + 倒计时 -->
          <section class="tax-card" id="taxReminderCard">
            <div class="tax-bar">
              <button class="tax-btn" id="taxToggleBtn" type="button">税务提醒</button>
              <span class="tax-countdown" id="taxCountdown">—</span>
            </div>

            <div class="tax-panel" id="taxPanel" style="display:none;">
              <div class="tax-title" data-i18n="tax_title">加拿大报税/补税提醒</div>
              <div class="tax-lines" id="taxReminderText"></div>

              <div class="tax-row">
                <label>
                  <input type="checkbox" id="isSelfEmployedToggle" />
                  <span data-i18n="tax_self_employed">自雇（Self-employed）</span>
                </label>
              </div>

              <div class="tax-note" data-i18n="tax_note">注：这是时间点提醒，不提供报税建议；以 CRA 官方更新为准。</div>
            </div>
          </section>

          <label data-i18n="plan_label">本月计划花销总数</label>
          <input id="planInput" type="number" inputmode="decimal" data-i18n-placeholder="plan_ph" placeholder="例如 1000" />
          <div class="row">
            <button class="btn btn-mini" id="planEditBtn" type="button" data-i18n="edit_calc">修改（计算器）</button>
            <button class="btn btn-mini" id="planUndoBtn" type="button" data-i18n="undo">撤销</button>
          </div>

          <label data-i18n="edit_date_label">编辑日期（回改某一天）</label>
          <input id="datePicker" type="date" />
          <div class="sub" id="pickerHint" style="margin:6px 0 0;" data-i18n="picker_hint">
            只能编辑到今天（不能写未来）。修改需点“确认修改”才生效。
          </div>

          <label data-i18n="month_calendar_label">本月日历</label>
          <div id="monthCalendar" aria-label="本月日历"></div>

          <label data-i18n="today_total_label">今日消费总数</label>
          <input id="dayInput" type="number" inputmode="decimal" data-i18n-placeholder="day_ph" placeholder="例如 35" />
          <div class="sub" id="dayLine" style="margin:6px 0 0;">—</div>

          <div class="row">
            <button class="btn-confirm" id="confirmBtn" type="button" disabled data-i18n="confirm_edit">确认修改</button>
            <button class="btn-cancel" id="cancelBtn" type="button" data-i18n="cancel_edit">取消修改</button>
            <button class="btn btn-mini" id="dayEditBtn" type="button" data-i18n="edit_calc">修改（计算器）</button>
            <button class="btn btn-mini" id="dayUndoBtn" type="button" data-i18n="undo">撤销</button>
          </div>

          <label data-i18n="tags_label">当日花销内容标签（可多选）</label>
          <div class="chips" id="tagChips">
            <button class="chip" type="button" data-tag="parking" data-i18n="tag_parking">停车费</button>
            <button class="chip" type="button" data-tag="grocery" data-i18n="tag_grocery">超市购物</button>
            <button class="chip" type="button" data-tag="dining" data-i18n="tag_dining">外出吃饭</button>
            <button class="chip" type="button" data-tag="gift" data-i18n="tag_gift">礼物</button>
            <button class="chip" type="button" data-tag="transport" data-i18n="tag_transport">油费/交通</button>
            <button class="chip" type="button" data-tag="household" data-i18n="tag_household">生活用品</button>
            <button class="chip" type="button" data-tag="bills" data-i18n="tag_bills">账单/订阅</button>
            <button class="chip" type="button" data-tag="medical" data-i18n="tag_medical">医疗/药品</button>
            <button class="chip" type="button" data-tag="entertainment" data-i18n="tag_entertainment">娱乐/休闲</button>
            <button class="chip" type="button" data-tag="other" data-i18n="tag_other">其他</button>
          </div>

          <div class="row" style="margin-top:12px;">
            <button class="btn btn-primary" id="recordBtn" type="button" data-i18n="save_day">保存这天</button>
          </div>

          <div class="grid">
            <div class="box">
              <div class="k" id="spentLabel">—</div>
              <div class="v" id="spentVal">—</div>
            </div>
            <div class="box">
              <div class="k" data-i18n="avg_actual">日均实际（S ÷ d）</div>
              <div class="v" id="avgVal">—</div>
            </div>
            <div class="box">
              <div class="k" data-i18n="month_remaining">本月剩余</div>
              <div class="v" id="balanceVal">—</div>
            </div>
            <div class="box">
              <div class="k" id="needLabel">—</div>
              <div class="v" id="needVal">—</div>
            </div>
          </div>

          <details open>
            <summary data-i18n="month_list_title">本月每日列表（红色=曾修改）</summary>
            <div class="muted" id="monthList" data-i18n="no_records">（暂无记录）</div>
          </details>

          <p class="muted" data-i18n="footer_note">
            说明：切换币种只改变显示单位，不做汇率换算。每个账本独立存储。输入框改动不会立刻写入；只有产生修改行为时，“确认修改”才会变为可点击。
          </p>
        </div>
      </main>

    </div>
  </div>

  <!-- 账本名称引导（首次/新建时） -->
  <div class="gate-mask" id="gateMask" aria-hidden="true">
    <div class="gate" role="dialog" aria-modal="true" aria-labelledby="gateTitle">
      <h2 id="gateTitle" data-i18n="gate_title">请输入账本名称</h2>
      <p data-i18n="gate_desc">例如：a / 家庭 / Yang / 2025。每个账本的数据完全独立，不会互相串联。</p>
      <input id="gateInput" data-i18n-placeholder="gate_ph" placeholder="账本名称（必填）" />
      <div class="row">
        <button class="btn btn-primary" id="gateOkBtn" type="button" data-i18n="gate_enter">进入</button>
        <button class="btn" id="gateCancelBtn" type="button" data-i18n="gate_cancel">取消</button>
      </div>
      <small data-i18n="gate_tip">提示：账本名称仅存本地，不联网。如果你和别人共用同一台电脑同一浏览器，记得用不同账本名称。</small>
    </div>
  </div>

  <!-- 计算器弹窗 -->
  <div class="modal-mask" id="calcMask" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="calcTitle">
      <div class="modal-hd">
        <div class="modal-title" id="calcTitle" data-i18n="calc_title">计算器修改</div>
        <button class="modal-close" id="calcClose" type="button" data-i18n="close">关闭</button>
      </div>

      <div class="calc-screen">
        <div class="calc-expr" id="calcExpr">—</div>
        <div class="calc-val" id="calcVal">—</div>
      </div>

      <div class="calc-grid">
        <button class="calc-btn warn" data-k="C" type="button" data-i18n="calc_clear">清零</button>
        <button class="calc-btn warn" data-k="BS" type="button" data-i18n="calc_back">退格</button>
        <button class="calc-btn op" data-k="/" type="button">÷</button>
        <button class="calc-btn op" data-k="*" type="button">×</button>

        <button class="calc-btn" data-k="7" type="button">7</button>
        <button class="calc-btn" data-k="8" type="button">8</button>
        <button class="calc-btn" data-k="9" type="button">9</button>
        <button class="calc-btn op" data-k="-" type="button">−</button>

        <button class="calc-btn" data-k="4" type="button">4</button>
        <button class="calc-btn" data-k="5" type="button">5</button>
        <button class="calc-btn" data-k="6" type="button">6</button>
        <button class="calc-btn op" data-k="+" type="button">+</button>

        <button class="calc-btn" data-k="1" type="button">1</button>
        <button class="calc-btn" data-k="2" type="button">2</button>
        <button class="calc-btn" data-k="3" type="button">3</button>
        <button class="calc-btn" data-k="." type="button">.</button>

        <button class="calc-btn" data-k="0" type="button">0</button>
        <button class="calc-btn" data-k="00" type="button">00</button>
        <button class="calc-btn op" data-k="=" type="button">=</button>
        <button class="calc-btn op" id="calcOk" type="button" data-i18n="confirm">确认</button>
      </div>

      <div class="calc-actions">
        <button class="btn" id="calcCancel" type="button" data-i18n="cancel">取消</button>
        <button class="btn btn-primary" id="calcUse" type="button" data-i18n="write_back">把结果写回</button>
      </div>
    </div>
  </div>

  <!-- 月份选择器弹窗（回看历史记录） -->
  <div class="modal-mask" id="monthPickerMask" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="monthPickerTitle">
      <div class="modal-hd">
        <div class="modal-title" id="monthPickerTitle">选择月份</div>
        <button class="modal-close" id="monthPickerClose" type="button">关闭</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="btn" id="monthPrevBtn" type="button">上个月</button>
        <button class="btn" id="monthNextBtn" type="button">下个月</button>
      </div>

      <div class="muted" style="margin-top:8px;">
        你也可以直接点下面的“有记录月份”快速跳转。
      </div>
      <div id="monthPickerList" style="margin-top:10px;display:flex;flex-direction:column;gap:8px;"></div>
    </div>
  </div>

  <!-- 删除账本确认弹窗（居中 + 10秒倒计时） -->
  <div class="modal-mask" id="deleteBookMask" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="deleteBookTitle">
      <div class="modal-hd">
        <div class="modal-title" id="deleteBookTitle">删除账本</div>
        <button class="modal-close" id="deleteBookClose" type="button">关闭</button>
      </div>

      <div id="deleteBookText" style="margin-top:10px;line-height:1.6;"></div>

      <div class="row" style="margin-top:12px;">
        <button class="btn" id="deleteBookCancelBtn" type="button">取消</button>
        <button class="btn btn-primary" id="deleteBookConfirmBtn" type="button" disabled>确认删除（10）</button>
      </div>

      <div class="muted" style="margin-top:10px;">
        为避免误删，确认按钮需要等待 10 秒。
      </div>
    </div>
  </div>

  <script>
  /***********************
   * i18n（沿用你原来的字典，保持不动）
   ***********************/
  const I18N = {
    zh: {
      lang_label: "语言",
      lang_hint: "切换语言仅影响界面文字，不影响你已保存的数据。",

      book_current: "当前账本",
      book_new: "新建",
      book_delete: "删除",
      book_hint: "每个账本的数据独立存储，不会互相串联。",

      currency_current: "当前币种",
      currency_hint: "切换后仅改变显示单位，不做汇率换算。",

      months_title: "月份",
      months_tip: "仅显示“有记录的过往月份”和“当前月”。点击月份可回看/修改该月数据。",

      legend_title: "颜色说明",
      legend_green: "绿色框 = 已填写",
      legend_red: "红色框 = 有修改",
      legend_blue: "蓝色框 = 今日",
      legend_white: "白色框 = 未填写",

      app_title: "轻记账（客观统计）",

      tax_title: "加拿大报税/补税提醒",
      tax_self_employed: "自雇（Self-employed）",
      tax_note: "注：这是时间点提醒，不提供报税建议；以 CRA 官方更新为准。",
      tax_line_1: "• 报税季通常：2 月下旬起可电子报税（NETFILE）。",
      tax_line_2: "• 普通个人：{apr30} 前完成报税；如需补税，{apr30} 前交清。",
      tax_line_3: "• 自雇人士：报税截止 {jun15}，但若需要补税仍是 {apr30} 前交清。",
      tax_line_4: "• 报税后留意 CRA 的 Notice of Assessment（评税通知）。",

      plan_label: "本月计划花销总数",
      plan_ph: "例如 1000",
      edit_calc: "修改（计算器）",
      undo: "撤销",

      edit_date_label: "编辑日期（回改某一天）",
      picker_hint: "只能编辑到今天（不能写未来）。修改需点“确认修改”才生效。",

      month_calendar_label: "本月日历",

      today_total_label: "今日消费总数",
      day_ph: "例如 35",

      confirm_edit: "确认修改",
      cancel_edit: "取消修改",

      tags_label: "当日花销内容标签（可多选）",

      tag_parking: "停车费",
      tag_grocery: "超市购物",
      tag_dining: "外出吃饭",
      tag_gift: "礼物",
      tag_transport: "油费/交通",
      tag_household: "生活用品",
      tag_bills: "账单/订阅",
      tag_medical: "医疗/药品",
      tag_entertainment: "娱乐/休闲",
      tag_other: "其他",

      save_day: "保存这天",
      saved: "已保存",

      avg_actual: "日均实际（S ÷ d）",
      month_remaining: "本月剩余",

      month_list_title: "本月每日列表（红色=曾修改）",
      no_records: "（暂无记录）",

      footer_note: "说明：切换币种只改变显示单位，不做汇率换算。每个账本独立存储。输入框改动不会立刻写入；只有产生修改行为时，“确认修改”才会变为可点击。",

      gate_title: "请输入账本名称",
      gate_desc: "例如：a / 家庭 / Yang / 2025。每个账本的数据完全独立，不会互相串联。",
      gate_ph: "账本名称（必填）",
      gate_enter: "进入",
      gate_cancel: "取消",
      gate_tip: "提示：账本名称仅存本地，不联网。如果你和别人共用同一台电脑同一浏览器，记得用不同账本名称。",

      calc_title: "计算器修改",
      close: "关闭",
      calc_clear: "清零",
      calc_back: "退格",
      confirm: "确认",
      cancel: "取消",
      write_back: "把结果写回",

      month_prefix: "月份：{ym}",
      spent_until: "截至目前已花",
      spent_month: "本月已花",
      need_today: "为不超支：从明天起后续日均需 ≤",
      need_ended: "该月已结束",
      edit_prefix: "编辑：{ymd}（{wk}）",

      cannot_future: "不能填写未来日期（例如明天）。",
      cannot_future_month: "未来月份不可编辑。",

      input_book_name: "请输入账本名称",
      must_create_book: "请先创建一个账本名称",
      expr_invalid: "表达式无效",
      expr_invalid_alert: "表达式无效，请修改后再确认",
      cannot_future_short: "不能填写未来日期。"
    },

    /* 下面其他语言你原来就有，省略不改（保持兼容） */
    en: (window.I18N && window.I18N.en) ? window.I18N.en : {},
    ja: (window.I18N && window.I18N.ja) ? window.I18N.ja : {},
    ko: (window.I18N && window.I18N.ko) ? window.I18N.ko : {},
    vi: (window.I18N && window.I18N.vi) ? window.I18N.vi : {},
    hi: (window.I18N && window.I18N.hi) ? window.I18N.hi : {}
  };

  function getSavedLang(){ return localStorage.getItem("budgetTool_lang") || "zh"; }
  function setSavedLang(lang){ localStorage.setItem("budgetTool_lang", lang); }
  function t(key, vars = {}){
    const lang = getSavedLang();
    const dict = I18N[lang] || I18N.zh;
    let s = (dict[key] ?? I18N.zh[key] ?? key);
    for (const [k, v] of Object.entries(vars)) s = s.replaceAll(`{${k}}`, String(v));
    return s;
  }
  function applyI18n(){
    document.documentElement.lang = getSavedLang();
    document.querySelectorAll("[data-i18n]").forEach(el=>{
      const key = el.getAttribute("data-i18n");
      el.textContent = t(key);
    });
    document.querySelectorAll("[data-i18n-placeholder]").forEach(el=>{
      const key = el.getAttribute("data-i18n-placeholder");
      el.setAttribute("placeholder", t(key));
    });
    renderTopLines();
    renderEditLine();
    renderTaxReminder();
    renderTaxCountdown();
  }
  function initI18n(){
    const sel = document.getElementById("langSelect");
    if (!sel) return;
    sel.value = getSavedLang();
    sel.addEventListener("change", ()=>{
      setSavedLang(sel.value);
      applyI18n();
      renderStatsAndList();
      renderMonthCalendar();
      buildMonthList();
    });
    applyI18n();
  }

  /***********************
   * 日期工具
   ***********************/
  const weekMapZh = ['周日','周一','周二','周三','周四','周五','周六'];
  const weekMapEn = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  function pad2(n){ return String(n).padStart(2,'0'); }
  function parseYm(ymStr){ const [y,m] = ymStr.split('-').map(Number); return { y, m }; }
  function daysInMonthOf(ymStr){ const { y, m } = parseYm(ymStr); return new Date(y, m, 0).getDate(); }
  function parseYmd(ymdStr){ const [y,m,d] = ymdStr.split('-').map(Number); return new Date(y, (m||1)-1, d||1); }
  function weekdayOf(ymdStr){
    const idx = parseYmd(ymdStr).getDay();
    const lang = getSavedLang();
    return (lang === 'zh') ? weekMapZh[idx] : weekMapEn[idx];
  }
  function monthEndYmd(ymStr){ return `${ymStr}-${pad2(daysInMonthOf(ymStr))}`; }

  const now = new Date();
  const currentYm = `${now.getFullYear()}-${pad2(now.getMonth()+1)}`;
  const todayYmd = `${now.getFullYear()}-${pad2(now.getMonth()+1)}-${pad2(now.getDate())}`;
  const currentDayIndex = now.getDate();
  function isFutureDate(ymdStr){ return ymdStr > todayYmd; }

  /***********************
   * Tax Reminder（按钮 + 倒计时）
   ***********************/
  function ymdOf(year, month, day){
    const mm = String(month).padStart(2,"0");
    const dd = String(day).padStart(2,"0");
    return `${year}-${mm}-${dd}`;
  }
  function diffDays(fromYmd, toYmd){
    const a = parseYmd(fromYmd);
    const b = parseYmd(toYmd);
    const ms = b.getTime() - a.getTime();
    return Math.ceil(ms / 86400000);
  }

  function renderTaxReminder(){
    const text = document.getElementById("taxReminderText");
    const selfToggle = document.getElementById("isSelfEmployedToggle");
    if (!text || !selfToggle) return;

    const y = new Date().getFullYear();
    const apr30 = ymdOf(y, 4, 30);
    const jun15 = ymdOf(y, 6, 15);

    const lines = [
      t("tax_line_1"),
      t("tax_line_2", { apr30 }),
      t("tax_line_3", { jun15, apr30 }),
      t("tax_line_4")
    ];
    const isSE = !!selfToggle.checked;

    text.innerHTML = `
      <div>${lines[0]}</div>
      <div>${lines[1]}</div>
      <div style="${isSE ? "font-weight:900;" : ""}">${lines[2]}</div>
      <div>${lines[3]}</div>
    `;
  }

  function renderTaxCountdown(){
    const cd = document.getElementById("taxCountdown");
    const selfToggle = document.getElementById("isSelfEmployedToggle");
    if (!cd || !selfToggle) return;

    const y = new Date().getFullYear();
    const seasonStart = ymdOf(y, 2, 24);     // 近似：2月下旬
    const apr30 = ymdOf(y, 4, 30);
    const jun15 = ymdOf(y, 6, 15);
    const filingDeadline = selfToggle.checked ? jun15 : apr30;

    if (todayYmd < seasonStart) {
      const d = diffDays(todayYmd, seasonStart);
      cd.textContent = `距离报税开始还有 ${d} 天`;
      return;
    }
    if (todayYmd <= filingDeadline) {
      const d = diffDays(todayYmd, filingDeadline);
      cd.textContent = `距离报税截止还有 ${d} 天`;
      return;
    }
    cd.textContent = `本年度报税截止日已过`;
  }

  function initTaxReminder(){
    const selfToggle = document.getElementById("isSelfEmployedToggle");
    const taxBtn = document.getElementById("taxToggleBtn");
    const panel = document.getElementById("taxPanel");
    if (!selfToggle || !taxBtn || !panel) return;

    taxBtn.addEventListener("click", ()=>{
      panel.style.display = (panel.style.display === "none") ? "block" : "none";
    });

    selfToggle.addEventListener("change", ()=>{
      renderTaxReminder();
      renderTaxCountdown();
    });

    renderTaxReminder();
    renderTaxCountdown();
  }

  /***********************
   * 账本（用户）隔离层
   ***********************/
  const META_KEY = 'budgetTool:meta:v1';
  const BOOK_PREFIX = 'budgetTool:book:'; // 实际存储 key = budgetTool:book:<name>:v1
  function bookDataKey(name){ return `${BOOK_PREFIX}${name}:v1`; }

  function safeJsonParse(s, fallback){
    try { return JSON.parse(s); } catch { return fallback; }
  }
  function loadMeta(){
    const m = safeJsonParse(localStorage.getItem(META_KEY) || '', null);
    if (m && Array.isArray(m.books)) return m;
    return { books: [], currentBook: null };
  }
  function saveMeta(meta){ localStorage.setItem(META_KEY, JSON.stringify(meta)); }
  function normalizeBookName(name){
    const n = String(name || '').trim();
    const cleaned = n.replace(/[:]/g, ' ').replace(/\s+/g,' ').trim();
    if (!cleaned) return '';
    return cleaned.slice(0, 24);
  }
  function createEmptyBookData(){
    return { months: {}, settings: { currency: 'CAD' } };
  }
  function loadBookData(bookName){
    const key = bookDataKey(bookName);
    const data = safeJsonParse(localStorage.getItem(key) || '', null);
    if (data && typeof data === 'object') {
      data.months = data.months || {};
      data.settings = data.settings || { currency: 'CAD' };
      return data;
    }
    const fresh = createEmptyBookData();
    localStorage.setItem(key, JSON.stringify(fresh));
    return fresh;
  }
  function saveBookData(bookName, data){
    localStorage.setItem(bookDataKey(bookName), JSON.stringify(data));
  }
  function ensureBook(meta, bookName){
    const bn = normalizeBookName(bookName);
    if (!bn) return null;
    if (!meta.books.includes(bn)) meta.books.push(bn);
    meta.currentBook = bn;
    saveMeta(meta);
    loadBookData(bn);
    return bn;
  }

  /***********************
   * Tags
   ***********************/
  const TAG_KEYS = ["parking","grocery","dining","gift","transport","household","bills","medical","entertainment","other"];
  const TAG_LABEL_KEY = {
    parking: "tag_parking", grocery: "tag_grocery", dining: "tag_dining", gift: "tag_gift",
    transport: "tag_transport", household: "tag_household", bills: "tag_bills", medical: "tag_medical",
    entertainment: "tag_entertainment", other: "tag_other"
  };
  const LEGACY_ZH_TO_KEY = {
    "停车费":"parking","超市购物":"grocery","外出吃饭":"dining","礼物":"gift","油费/交通":"transport",
    "生活用品":"household","账单/订阅":"bills","医疗/药品":"medical","娱乐/休闲":"entertainment","其他":"other"
  };
  function normalizeTagsToKeys(tags){
    if (!Array.isArray(tags)) return [];
    const out = [];
    for (const x of tags) {
      if (!x) continue;
      const s = String(x).trim();
      if (TAG_KEYS.includes(s)) out.push(s);
      else if (LEGACY_ZH_TO_KEY[s]) out.push(LEGACY_ZH_TO_KEY[s]);
      else out.push(s);
    }
    return Array.from(new Set(out));
  }
  function tagLabel(tag){
    if (TAG_LABEL_KEY[tag]) return t(TAG_LABEL_KEY[tag]);
    return String(tag);
  }

  /***********************
   * UI：账本弹窗与侧边栏
   ***********************/
  const gateMask = document.getElementById('gateMask');
  const gateInput = document.getElementById('gateInput');
  const gateOkBtn = document.getElementById('gateOkBtn');
  const gateCancelBtn = document.getElementById('gateCancelBtn');

  const bookSelect = document.getElementById('bookSelect');
  const bookNewBtn = document.getElementById('bookNewBtn');
  const bookDelBtn = document.getElementById('bookDelBtn');

  let meta = loadMeta();
  let currentBook = meta.currentBook;

  function openGate(defaultValue=''){
    gateInput.value = defaultValue;
    gateMask.style.display = 'flex';
    gateMask.setAttribute('aria-hidden', 'false');
    setTimeout(()=> gateInput.focus(), 50);
  }
  function closeGate(){
    gateMask.style.display = 'none';
    gateMask.setAttribute('aria-hidden', 'true');
    gateInput.value = '';
  }
  gateMask.addEventListener('click', (e)=>{ if (e.target === gateMask) closeGate(); });

  function rebuildBookSelect(){
    meta = loadMeta();
    bookSelect.innerHTML = meta.books.map(b=>{
      const sel = (b === meta.currentBook) ? 'selected' : '';
      return `<option value="${b}" ${sel}>${b}</option>`;
    }).join('');
  }
  function requireBookOnStart(){
    meta = loadMeta();
    if (!meta.books.length || !meta.currentBook) openGate('');
  }

  gateOkBtn.addEventListener('click', ()=>{
    const name = normalizeBookName(gateInput.value);
    if (!name) { alert(t('input_book_name')); return; }
    meta = loadMeta();
    const bn = ensureBook(meta, name);
    if (!bn) return;
    closeGate();
    rebuildBookSelect();
    switchBook(bn);
  });
  gateCancelBtn.addEventListener('click', ()=>{
    meta = loadMeta();
    if (!meta.books.length) { alert(t('must_create_book')); return; }
    closeGate();
  });

  bookNewBtn.addEventListener('click', ()=> openGate(''));
  bookSelect.addEventListener('change', ()=>{
    const name = normalizeBookName(bookSelect.value);
    if (!name) return;
    meta = loadMeta();
    meta.currentBook = name;
    saveMeta(meta);
    switchBook(name);
  });

  /***********************
   * 删除账本：居中弹窗 + 10秒倒计时
   ***********************/
  const deleteBookMask = document.getElementById('deleteBookMask');
  const deleteBookClose = document.getElementById('deleteBookClose');
  const deleteBookText = document.getElementById('deleteBookText');
  const deleteBookCancelBtn = document.getElementById('deleteBookCancelBtn');
  const deleteBookConfirmBtn = document.getElementById('deleteBookConfirmBtn');

  let deleteCountdownTimer = null;
  let deleteCountdownLeft = 10;
  let pendingDeleteBookName = null;

  function openDeleteBookModal(bookName){
    pendingDeleteBookName = bookName;
    deleteBookText.innerHTML = `
      <div style="font-weight:900;margin-bottom:6px;">确定删除账本「${bookName}」吗？</div>
      <div style="color:#c62828;font-weight:800;">删除后该账本的本地数据将被移除，无法恢复。</div>
    `;

    deleteCountdownLeft = 10;
    deleteBookConfirmBtn.disabled = true;
    deleteBookConfirmBtn.textContent = `确认删除（${deleteCountdownLeft}）`;

    if (deleteCountdownTimer) clearInterval(deleteCountdownTimer);
    deleteCountdownTimer = setInterval(()=>{
      deleteCountdownLeft -= 1;
      if (deleteCountdownLeft <= 0) {
        clearInterval(deleteCountdownTimer);
        deleteCountdownTimer = null;
        deleteBookConfirmBtn.disabled = false;
        deleteBookConfirmBtn.textContent = '确认删除';
        return;
      }
      deleteBookConfirmBtn.textContent = `确认删除（${deleteCountdownLeft}）`;
    }, 1000);

    deleteBookMask.style.display = 'flex';
    deleteBookMask.setAttribute('aria-hidden','false');
  }
  function closeDeleteBookModal(){
    deleteBookMask.style.display = 'none';
    deleteBookMask.setAttribute('aria-hidden','true');
    if (deleteCountdownTimer) { clearInterval(deleteCountdownTimer); deleteCountdownTimer = null; }
    pendingDeleteBookName = null;
  }
  deleteBookMask.addEventListener('click', (e)=>{ if (e.target === deleteBookMask) closeDeleteBookModal(); });
  deleteBookClose.addEventListener('click', closeDeleteBookModal);
  deleteBookCancelBtn.addEventListener('click', closeDeleteBookModal);

  deleteBookConfirmBtn.addEventListener('click', ()=>{
    if (deleteBookConfirmBtn.disabled) return;
    if (!pendingDeleteBookName) return;

    const cur = pendingDeleteBookName;
    closeDeleteBookModal();

    localStorage.removeItem(bookDataKey(cur));
    meta = loadMeta();
    meta.books = meta.books.filter(b => b !== cur);
    meta.currentBook = meta.books.length ? meta.books[0] : null;
    saveMeta(meta);

    rebuildBookSelect();
    if (meta.currentBook) switchBook(meta.currentBook);
    else requireBookOnStart();
  });

  bookDelBtn.addEventListener('click', ()=>{
    meta = loadMeta();
    const cur = meta.currentBook;
    if (!cur) return;
    openDeleteBookModal(cur);
  });

  /***********************
   * 本页业务状态
   ***********************/
  const monthNav = document.getElementById('monthNav');
  const dateLine = document.getElementById('dateLine');
  const spentLabel = document.getElementById('spentLabel');
  const needLabel = document.getElementById('needLabel');

  const datePicker = document.getElementById('datePicker');
  const dayLine = document.getElementById('dayLine');

  const planInput = document.getElementById('planInput');
  const dayInput = document.getElementById('dayInput');

  const planUndoBtn = document.getElementById('planUndoBtn');
  const dayUndoBtn = document.getElementById('dayUndoBtn');
  const recordBtn = document.getElementById('recordBtn');
  const confirmBtn = document.getElementById('confirmBtn');
  const cancelBtn = document.getElementById('cancelBtn');

  const spentVal = document.getElementById('spentVal');
  const avgVal = document.getElementById('avgVal');
  const balanceVal = document.getElementById('balanceVal');
  const needVal = document.getElementById('needVal');

  const monthList = document.getElementById('monthList');
  const chipButtons = Array.from(document.querySelectorAll('.chip'));
  const monthCalendar = document.getElementById('monthCalendar');

  const currencySelect = document.getElementById('currencySelect');
  const CURRENCY_DECIMALS = { JPY: 0, KRW: 0, VND: 0, CNY: 2, USD: 2, CAD: 2, EUR: 2, GBP: 2 };
  function normalizeCurrency(code){
    const c = String(code || 'CAD').toUpperCase();
    return Object.prototype.hasOwnProperty.call(CURRENCY_DECIMALS, c) ? c : 'CAD';
  }
  function decimalsForCurrency(code){
    return CURRENCY_DECIMALS[normalizeCurrency(code)] ?? 2;
  }

  let bookData = null;
  let activeCurrency = 'CAD';

  let activeYm = currentYm;
  let monthData = null;

  let editYmd = todayYmd;
  let draft = { total: null, tags: [] };
  let dirty = false;

  let savedToastTimer = null;

  function ensureMonth(data, ym){
    data.months = data.months || {};
    if (!data.months[ym]) {
      data.months[ym] = { plan:null, days:{}, undo:{ plan:[], day:[] }, startFrom:null, started:false };
    } else {
      data.months[ym].undo = data.months[ym].undo || { plan:[], day:[] };
      data.months[ym].undo.plan = data.months[ym].undo.plan || [];
      data.months[ym].undo.day = data.months[ym].undo.day || [];
      data.months[ym].startFrom = data.months[ym].startFrom || null;
      data.months[ym].started = data.months[ym].started || false;
    }
    return data.months[ym];
  }

  function normalizeRecord(rec){
    if (!rec) return { total: null, tags: [], createdAt: null, updatedAt: null, edited: false };
    return {
      total: (typeof rec.total === 'number') ? rec.total : (rec.total ?? null),
      tags: normalizeTagsToKeys(Array.isArray(rec.tags) ? rec.tags : []),
      createdAt: rec.createdAt ?? null,
      updatedAt: rec.updatedAt ?? null,
      edited: !!rec.edited
    };
  }
  function getDayRecord(dateStr){ return normalizeRecord(monthData.days[dateStr]); }

  function fmtMoney(n){
    if (n === null || n === undefined || Number.isNaN(n)) return '—';
    const dp = decimalsForCurrency(activeCurrency);
    const v = Math.round(n * Math.pow(10, dp)) / Math.pow(10, dp);
    return `${v.toFixed(dp)} ${activeCurrency}`;
  }

  function saveCurrentBook(){
    if (!currentBook || !bookData) return;
    saveBookData(currentBook, bookData);
  }

  function setCurrency(code){
    activeCurrency = normalizeCurrency(code);
    bookData.settings = bookData.settings || {};
    bookData.settings.currency = activeCurrency;
    saveCurrentBook();

    currencySelect.value = activeCurrency;
    renderStatsAndList();
    renderMonthCalendar();
    renderTopLines();
    if (calcMask.style.display === 'flex') renderCalc();
  }

  function setConfirmState(isDirty){
    dirty = isDirty;
    confirmBtn.disabled = !dirty;
    confirmBtn.textContent = t('confirm_edit');
  }

  function markSavedOnRecordBtn(){
    if (savedToastTimer) { clearTimeout(savedToastTimer); savedToastTimer = null; }
    recordBtn.classList.add('saved');
    recordBtn.textContent = t('saved');
    savedToastTimer = setTimeout(()=>{
      recordBtn.classList.remove('saved');
      recordBtn.textContent = t('save_day');
    }, 1200);
  }

  function getSelectedTags(){
    return chipButtons
      .filter(b => b.classList.contains('on'))
      .map(b => b.getAttribute('data-tag'))
      .filter(Boolean);
  }
  function setSelectedTags(tags){
    const set = new Set(normalizeTagsToKeys(tags || []));
    chipButtons.forEach(b => {
      const k = b.getAttribute('data-tag');
      b.classList.toggle('on', !!k && set.has(k));
    });
  }

  function updateDatePickerRange(){
    datePicker.min = '2000-01-01';
    datePicker.max = todayYmd;
  }

  function renderTopLines(){
    if (!dateLine || !spentLabel || !needLabel) return;
    dateLine.textContent = t('month_prefix', { ym: activeYm });
    if (activeYm === currentYm) {
      spentLabel.textContent = t('spent_until');
      needLabel.textContent = t('need_today');
    } else {
      spentLabel.textContent = t('spent_month');
      needLabel.textContent = t('need_ended');
    }
  }

  function renderEditLine(){
    if (!dayLine) return;
    dayLine.textContent = t('edit_prefix', { ymd: editYmd, wk: weekdayOf(editYmd) });
  }

  function loadDraftFromRecord(){
    const rec = getDayRecord(editYmd);
    draft.total = (typeof rec.total === 'number') ? rec.total : null;
    draft.tags = normalizeTagsToKeys(rec.tags || []).slice();
    dayInput.value = (draft.total === null) ? '' : String(draft.total);
    setSelectedTags(draft.tags);
    setConfirmState(false);
  }
  function onDraftChanged(){ setConfirmState(true); }

  function cutoffYmdForActiveMonth(){
    return (activeYm === currentYm) ? todayYmd : monthEndYmd(activeYm);
  }

  function calcSpentAndRecordedDays(){
    let sum = 0, days = 0;
    const start = monthData.startFrom || `${activeYm}-01`;
    const cutoff = cutoffYmdForActiveMonth();

    for (const [dateStr, rec0] of Object.entries(monthData.days)) {
      if (!dateStr.startsWith(activeYm + '-')) continue;
      if (dateStr < start) continue;
      if (dateStr > cutoff) continue;

      const rec = normalizeRecord(rec0);
      if (typeof rec.total === 'number') { sum += rec.total; days += 1; }
    }
    return { sum, days };
  }

  function setBalanceDisplay(balance){
    if (balance === null) { balanceVal.textContent = '—'; balanceVal.style.color = '#111'; return; }
    const abs = Math.abs(balance);
    const dp = decimalsForCurrency(activeCurrency);
    if (balance > 0) { balanceVal.textContent = `${abs.toFixed(dp)} ${activeCurrency}  ` + (getSavedLang()==='zh' ? '剩余' : 'left'); balanceVal.style.color = '#2e7d32'; }
    else if (balance < 0) { balanceVal.textContent = `${abs.toFixed(dp)} ${activeCurrency}  ` + (getSavedLang()==='zh' ? '超支' : 'over'); balanceVal.style.color = '#c62828'; }
    else { balanceVal.textContent = `0 ${activeCurrency}`; balanceVal.style.color = '#111'; }
  }

  function renderStatsAndList(){
    const P = (typeof monthData.plan === 'number') ? monthData.plan : null;
    const { sum: S, days: d } = calcSpentAndRecordedDays();
    const A = (d > 0) ? (S / d) : null;
    const B = (P === null) ? null : (P - S);

    spentVal.textContent = fmtMoney(S);
    avgVal.textContent = fmtMoney(A);
    setBalanceDisplay(B);

    if (activeYm === currentYm) {
      const remainingDays = daysInMonthOf(activeYm) - currentDayIndex;
      const R = (P === null || remainingDays <= 0) ? null : Math.max(0, (P - S) / remainingDays);
      needVal.textContent = (R === null) ? '—' : fmtMoney(R);
    } else {
      needVal.textContent = '—';
    }

    const keys = Object.keys(monthData.days).filter(k => k.startsWith(activeYm+'-')).sort();
    if (!keys.length) { monthList.textContent = t('no_records'); renderMonthCalendar(); return; }

    monthList.innerHTML = keys.map(k => {
      const rec = normalizeRecord(monthData.days[k]);
      const money = (typeof rec.total === 'number') ? fmtMoney(rec.total) : '—';
      const tags = (rec.tags && rec.tags.length)
        ? rec.tags.map(tagLabel).join(' / ')
        : (getSavedLang()==='zh' ? '（无标签）' : '(No tags)');
      const dateHtml = rec.edited
        ? `<span style="color:#c62828;font-weight:700;">${k}</span>`
        : `<span>${k}</span>`;
      const editedBadge = rec.edited ? ` <span style="color:#c62828;">(${getSavedLang()==='zh' ? '已改' : 'edited'})</span>` : '';
      return `<div style="padding:6px 0;border-bottom:1px dashed #eee;">
                <strong>${dateHtml}</strong>${editedBadge} ｜ ${money}<br/>
                <span style="color:#666;font-size:13px;">${tags}</span>
              </div>`;
    }).join('');

    renderMonthCalendar();
  }

  function renderMonthCalendar(){
    const { y, m } = parseYm(activeYm);
    const days = daysInMonthOf(activeYm);
    const firstDay = new Date(y, m - 1, 1).getDay();

    let html = '';
    for (let i = 0; i < firstDay; i++) html += `<div class="day-cell day-pad"></div>`;

    for (let d = 1; d <= days; d++){
      const ymd = `${activeYm}-${pad2(d)}`;
      const rec = normalizeRecord(monthData.days[ymd]);

      let cls = 'day-empty';
      if (ymd === todayYmd) cls = 'day-today';
      else if (rec.edited) cls = 'day-edited';
      else if (typeof rec.total === 'number') cls = 'day-recorded';

      const selectedCls = (ymd === editYmd) ? ' day-selected' : '';
      html += `<div class="day-cell ${cls}${selectedCls}" data-date="${ymd}">${d}</div>`;
    }

    monthCalendar.innerHTML = html;

    monthCalendar.querySelectorAll('.day-cell[data-date]').forEach(el=>{
      el.addEventListener('click', ()=>{
        const d = el.dataset.date;
        if (!d) return;
        if (isFutureDate(d)) return;
        switchEditDate(d);
      });
    });
  }

  function commitPlan(newVal){
    const prev = monthData.plan;
    monthData.undo.plan.push(prev);
    if (monthData.undo.plan.length > 30) monthData.undo.plan.shift();
    monthData.plan = newVal;
    saveCurrentBook();
    renderStatsAndList();
    buildMonthList();
  }

  function commitDay(dateStr, newTotal, newTags, asConfirmedEdit){
    if (isFutureDate(dateStr)) { alert(t('cannot_future')); return; }

    const existing0 = monthData.days[dateStr];
    const existing = normalizeRecord(existing0);

    monthData.undo.day.push({ date: dateStr, prev: { ...existing, tags: (existing.tags || []).slice() } });
    if (monthData.undo.day.length > 120) monthData.undo.day.shift();

    const nowTs = Date.now();
    const isFirstWrite = !existing0 || existing.createdAt === null;
    const editedFlag = (asConfirmedEdit && !isFirstWrite) ? true : false;

    monthData.days[dateStr] = {
      total: newTotal,
      tags: normalizeTagsToKeys(newTags),
      createdAt: isFirstWrite ? nowTs : existing.createdAt,
      updatedAt: nowTs,
      edited: existing.edited || editedFlag
    };

    monthData.started = true;
    if (!monthData.startFrom || dateStr < monthData.startFrom) monthData.startFrom = dateStr;

    saveCurrentBook();
    renderStatsAndList();
    renderEditLine();
    buildMonthList();
  }

  function popUndoForDate(dateStr){
    for (let i = monthData.undo.day.length - 1; i >= 0; i--) {
      if (monthData.undo.day[i].date === dateStr) {
        return monthData.undo.day.splice(i, 1)[0];
      }
    }
    return null;
  }

  function switchEditDate(newYmd){
    if (!newYmd) { datePicker.value = editYmd; return; }
    if (isFutureDate(newYmd)) { alert(t('cannot_future')); datePicker.value = editY_
<!-- =========================
最终版 · 第 2 / 3 段
内容：i18n(10种语言) + 税务提醒(按钮+倒计时+可恢复) + 历史日历弹窗(可翻月/点日跳转)
========================= -->
/***********************
 * i18n（10种语言）
 ***********************/
const I18N = {
  zh: {
    lang_label:"语言",
    lang_hint:"切换语言仅影响界面文字，不影响你已保存的数据。",

    book_current:"当前账本", book_new:"新建", book_delete:"删除",
    book_hint:"每个账本的数据独立存储，不会互相串联。",

    currency_current:"当前币种",
    currency_hint:"切换后仅改变显示单位，不做汇率换算。",

    months_title:"月份",
    months_tip:"仅显示“有记录的过往月份”和“当前月”。点击月份可回看/修改该月数据。",

    legend_title:"颜色说明",
    legend_green:"绿色框 = 已填写",
    legend_red:"红色框 = 有修改",
    legend_blue:"蓝色框 = 今日",
    legend_white:"白色框 = 未填写",

    app_title:"轻记账（客观统计）",

    history_title:"历史日历",
    history_tip_short:"查找过去任意日期的记录",
    history_open:"打开",
    history_note:"点击某一天会直接跳转到那一天，并自动切换到对应月份（用于查看/修改）。",
    prev_month:"上月",
    next_month:"下月",
    go_today:"回到今天",

    tax_btn:"税务提醒",
    tax_title:"税务提醒（加拿大）",
    tax_self_employed:"自雇（Self-employed）",
    tax_hide_this_year:"本年度不再提醒",
    tax_restore:"恢复提醒",
    tax_note:"注：这是时间点提醒，不提供报税建议；以 CRA 官方更新为准。",

    tax_line_1:"• 报税季通常：2 月下旬起可电子报税（NETFILE）。",
    tax_line_2:"• 普通个人：{apr30} 前完成报税；如需补税，{apr30} 前交清。",
    tax_line_3:"• 自雇人士：报税截止 {jun15}，但若需要补税仍是 {apr30} 前交清。",
    tax_line_4:"• 报税后留意 CRA 的 Notice of Assessment（评税通知）。",
    tax_countdown_before:"距离报税截止还有 {n} 天",
    tax_countdown_window:"距离纳税结束还有 {n} 天",
    tax_countdown_done:"本年度税务关键期限已过",

    plan_label:"本月计划花销总数",
    plan_ph:"例如 1000",
    edit_calc:"修改（计算器）",
    undo:"撤销",

    edit_date_label:"编辑日期（回改某一天）",
    picker_hint:"只能编辑到今天（不能写未来）。修改需点“确认修改”才生效。",

    month_calendar_label:"本月日历",

    today_total_label:"今日消费总数",
    day_ph:"例如 35",

    confirm_edit:"确认修改",
    cancel_edit:"取消修改",

    tags_label:"当日花销内容标签（可多选）",
    tag_parking:"停车费",
    tag_grocery:"超市购物",
    tag_dining:"外出吃饭",
    tag_gift:"礼物",
    tag_transport:"油费/交通",
    tag_household:"生活用品",
    tag_bills:"账单/订阅",
    tag_medical:"医疗/药品",
    tag_entertainment:"娱乐/休闲",
    tag_other:"其他",

    save_day:"保存这天",
    saved:"已保存",

    avg_actual:"日均实际（S ÷ d）",
    month_remaining:"本月剩余",
    month_list_title:"本月每日列表（红色=曾修改）",
    no_records:"（暂无记录）",

    footer_note:"说明：切换币种只改变显示单位，不做汇率换算。每个账本独立存储。输入框改动不会立刻写入；只有产生修改行为时，“确认修改”才会变为可点击。",

    gate_title:"请输入账本名称",
    gate_desc:"例如：a / 家庭 / Yang / 2025。每个账本的数据完全独立，不会互相串联。",
    gate_ph:"账本名称（必填）",
    gate_enter:"进入",
    gate_cancel:"取消",
    gate_tip:"提示：账本名称仅存本地，不联网。如果你和别人共用同一台电脑同一浏览器，记得用不同账本名称。",

    calc_title:"计算器修改",
    close:"关闭",
    calc_clear:"清零",
    calc_back:"退格",
    confirm:"确认",
    cancel:"取消",
    write_back:"把结果写回",

    month_prefix:"月份：{ym}",
    spent_until:"截至目前已花",
    spent_month:"本月已花",
    need_today:"为不超支：从明天起后续日均需 ≤",
    need_ended:"该月已结束",
    edit_prefix:"编辑：{ymd}（{wk}）",

    cannot_future:"不能填写未来日期（例如明天）。",
    cannot_future_month:"未来月份不可编辑。",

    delete_title:"删除账本",
    delete_note:"为防误删，确认按钮需要等待 10 秒。",
    delete_confirm_prefix:"确认删除（{n}s）",
    delete_confirm_ready:"确认删除",
    delete_text:"确定删除账本「{name}」吗？删除后该账本的本地数据将被移除，无法恢复。",

    input_book_name:"请输入账本名称",
    must_create_book:"请先创建一个账本名称",
    expr_invalid:"表达式无效",
    expr_invalid_alert:"表达式无效，请修改后再确认",
    cannot_future_short:"不能填写未来日期。",

    week_sun:"日", week_mon:"一", week_tue:"二", week_wed:"三", week_thu:"四", week_fri:"五", week_sat:"六"
  },

  en: {
    lang_label:"Language",
    lang_hint:"Language changes UI text only; your saved data stays the same.",

    book_current:"Current book", book_new:"New", book_delete:"Delete",
    book_hint:"Each book is stored separately; data will not mix.",

    currency_current:"Currency",
    currency_hint:"Changes display only (no FX conversion).",

    months_title:"Months",
    months_tip:"Shows months with records and the current month. Click to view/edit.",

    legend_title:"Legend",
    legend_green:"Green = filled",
    legend_red:"Red = edited",
    legend_blue:"Blue = today",
    legend_white:"White = empty",

    app_title:"Budget Tool (Simple Stats)",

    history_title:"History Calendar",
    history_tip_short:"Find any past date record",
    history_open:"Open",
    history_note:"Click a day to jump to that date and switch to its month (view/edit).",
    prev_month:"Prev",
    next_month:"Next",
    go_today:"Today",

    tax_btn:"Tax Reminder",
    tax_title:"Tax Reminder (Canada)",
    tax_self_employed:"Self-employed",
    tax_hide_this_year:"Hide for this year",
    tax_restore:"Restore",
    tax_note:"Note: Deadline reminder only. Please follow CRA updates.",

    tax_line_1:"• Tax season typically starts in late Feb (NETFILE).",
    tax_line_2:"• Individuals: file by {apr30}; if you owe, pay by {apr30}.",
    tax_line_3:"• Self-employed: filing due {jun15}, but payment (if owing) is still due {apr30}.",
    tax_line_4:"• After filing, check your CRA Notice of Assessment.",
    tax_countdown_before:"{n} days until filing deadline",
    tax_countdown_window:"{n} days until payment window ends",
    tax_countdown_done:"This year's key tax deadlines have passed",

    plan_label:"Monthly budget plan",
    plan_ph:"e.g., 1000",
    edit_calc:"Edit (Calculator)",
    undo:"Undo",

    edit_date_label:"Edit date (backfill)",
    picker_hint:"You can only edit up to today (no future dates). Changes take effect after “Confirm”.",

    month_calendar_label:"Month calendar",

    today_total_label:"Daily spending",
    day_ph:"e.g., 35",

    confirm_edit:"Confirm",
    cancel_edit:"Cancel",

    tags_label:"Tags (multi-select)",
    tag_parking:"Parking",
    tag_grocery:"Groceries",
    tag_dining:"Dining out",
    tag_gift:"Gifts",
    tag_transport:"Gas/Transport",
    tag_household:"Household",
    tag_bills:"Bills/Subscriptions",
    tag_medical:"Medical",
    tag_entertainment:"Leisure",
    tag_other:"Other",

    save_day:"Save day",
    saved:"Saved",

    avg_actual:"Daily avg (S ÷ d)",
    month_remaining:"Remaining",

    month_list_title:"Daily list (red = edited)",
    no_records:"(No records)",

    footer_note:"Note: Currency changes display only (no FX conversion). Each book is stored separately. Inputs don’t write immediately; “Confirm” becomes clickable only after changes.",

    gate_title:"Enter a book name",
    gate_desc:"Examples: a / Family / Yang / 2025. Each book is fully isolated.",
    gate_ph:"Book name (required)",
    gate_enter:"Enter",
    gate_cancel:"Cancel",
    gate_tip:"Tip: Book name is stored locally (no internet). If sharing a device/browser, use different book names.",

    calc_title:"Calculator",
    close:"Close",
    calc_clear:"Clear",
    calc_back:"Backspace",
    confirm:"OK",
    cancel:"Cancel",
    write_back:"Write back",

    month_prefix:"Month: {ym}",
    spent_until:"Spent so far",
    spent_month:"Spent in month",
    need_today:"To avoid overspending: required daily avg from tomorrow ≤",
    need_ended:"Month ended",
    edit_prefix:"Editing: {ymd} ({wk})",

    cannot_future:"You cannot enter future dates (e.g., tomorrow).",
    cannot_future_month:"Future months cannot be edited.",

    delete_title:"Delete book",
    delete_note:"To prevent mistakes, the confirm button is enabled after 10 seconds.",
    delete_confirm_prefix:"Delete ({n}s)",
    delete_confirm_ready:"Delete now",
    delete_text:"Delete book “{name}”? Local data will be removed and cannot be recovered.",

    input_book_name:"Please enter a book name.",
    must_create_book:"Please create a book name first.",
    expr_invalid:"Invalid expression",
    expr_invalid_alert:"Invalid expression. Please fix it before confirming.",
    cannot_future_short:"Future dates are not allowed.",

    week_sun:"Sun", week_mon:"Mon", week_tue:"Tue", week_wed:"Wed", week_thu:"Thu", week_fri:"Fri", week_sat:"Sat"
  },

  ja: {
    lang_label:"言語",
    lang_hint:"言語は表示だけ変更します。保存データはそのままです。",

    book_current:"現在の帳簿", book_new:"新規", book_delete:"削除",
    book_hint:"帳簿ごとにデータは独立し、混ざりません。",

    currency_current:"通貨",
    currency_hint:"表示単位のみ変更（為替換算なし）。",

    months_title:"月",
    months_tip:"記録がある過去月と当月のみ表示。クリックで閲覧/編集。",

    legend_title:"凡例",
    legend_green:"緑＝入力済み",
    legend_red:"赤＝修正あり",
    legend_blue:"青＝今日",
    legend_white:"白＝未入力",

    app_title:"簡単家計簿（統計）",

    history_title:"履歴カレンダー",
    history_tip_short:"過去の任意日を検索",
    history_open:"開く",
    history_note:"日付をクリックすると、その日にジャンプし該当月へ切替（閲覧/編集）。",
    prev_month:"前月",
    next_month:"翌月",
    go_today:"今日へ",

    tax_btn:"税務リマインダー",
    tax_title:"税務リマインダー（カナダ）",
    tax_self_employed:"自営業（Self-employed）",
    tax_hide_this_year:"今年は表示しない",
    tax_restore:"表示を戻す",
    tax_note:"注：期限のリマインドのみ。最新情報はCRAをご確認ください。",

    tax_line_1:"• 申告シーズン：通常 2月下旬 から電子申告可能（NETFILE）。",
    tax_line_2:"• 一般：{apr30} までに申告。追加納税も {apr30} まで。",
    tax_line_3:"• 自営業：申告期限 {jun15}、ただし納税（追加納税がある場合）は {apr30} まで。",
    tax_line_4:"• 申告後、CRA の Notice of Assessment を確認。",
    tax_countdown_before:"申告期限まであと {n} 日",
    tax_countdown_window:"納税期限終了まであと {n} 日",
    tax_countdown_done:"今年の主要期限は終了しました",

    plan_label:"今月の予算（計画）",
    plan_ph:"例：1000",
    edit_calc:"計算機で修正",
    undo:"元に戻す",

    edit_date_label:"日付を編集（過去入力）",
    picker_hint:"今日まで編集可能（未来不可）。反映には「確定」が必要。",

    month_calendar_label:"今月カレンダー",

    today_total_label:"当日の支出",
    day_ph:"例：35",

    confirm_edit:"確定",
    cancel_edit:"キャンセル",

    tags_label:"タグ（複数選択可）",
    tag_parking:"駐車",
    tag_grocery:"スーパー",
    tag_dining:"外食",
    tag_gift:"ギフト",
    tag_transport:"交通/ガス",
    tag_household:"日用品",
    tag_bills:"請求/サブスク",
    tag_medical:"医療",
    tag_entertainment:"娯楽",
    tag_other:"その他",

    save_day:"保存",
    saved:"保存済み",

    avg_actual:"日平均（S ÷ d）",
    month_remaining:"残り",

    month_list_title:"日別一覧（赤＝修正）",
    no_records:"（記録なし）",

    footer_note:"注：通貨は表示のみ変更（換算なし）。帳簿は独立保存。入力は即保存されず、変更後に「確定」で反映。",

    gate_title:"帳簿名を入力",
    gate_desc:"例：a / 家族 / Yang / 2025。帳簿ごとに完全に独立します。",
    gate_ph:"帳簿名（必須）",
    gate_enter:"入る",
    gate_cancel:"キャンセル",
    gate_tip:"ヒント：帳簿名はローカル保存（ネットなし）。共有PC/ブラウザでは別名を使ってください。",

    calc_title:"計算機",
    close:"閉じる",
    calc_clear:"クリア",
    calc_back:"戻す",
    confirm:"確定",
    cancel:"キャンセル",
    write_back:"反映する",

    month_prefix:"月：{ym}",
    spent_until:"現在までの支出",
    spent_month:"月の支出",
    need_today:"超過しないため：明日以降の必要日平均 ≤",
    need_ended:"月は終了",
    edit_prefix:"編集中：{ymd}（{wk}）",

    cannot_future:"未来日は入力できません（例：明日）。",
    cannot_future_month:"未来の月は編集できません。",

    delete_title:"帳簿の削除",
    delete_note:"誤削除防止のため、確認ボタンは10秒後に有効になります。",
    delete_confirm_prefix:"削除（{n}s）",
    delete_confirm_ready:"今すぐ削除",
    delete_text:"帳簿「{name}」を削除しますか？ローカルデータは削除され復元できません。",

    input_book_name:"帳簿名を入力してください。",
    must_create_book:"先に帳簿名を作成してください。",
    expr_invalid:"式が無効です",
    expr_invalid_alert:"式が無効です。修正してから確定してください。",
    cannot_future_short:"未来日は入力できません。",

    week_sun:"日", week_mon:"月", week_tue:"火", week_wed:"水", week_thu:"木", week_fri:"金", week_sat:"土"
  },

  ko: {
    lang_label:"언어",
    lang_hint:"언어는 화면 문구만 변경하며, 저장된 데이터는 그대로입니다.",

    book_current:"현재 장부", book_new:"새로 만들기", book_delete:"삭제",
    book_hint:"장부별로 데이터가 분리되어 서로 섞이지 않습니다.",

    currency_current:"통화",
    currency_hint:"표시 단위만 변경(환율 변환 없음).",

    months_title:"월",
    months_tip:"기록이 있는 과거 월과 현재 월만 표시됩니다. 클릭하여 보기/수정.",

    legend_title:"색상 설명",
    legend_green:"초록 = 입력됨",
    legend_red:"빨강 = 수정됨",
    legend_blue:"파랑 = 오늘",
    legend_white:"흰색 = 비어 있음",

    app_title:"간단 가계부(통계)",

    history_title:"기록 달력",
    history_tip_short:"과거 임의 날짜 검색",
    history_open:"열기",
    history_note:"날짜를 누르면 해당 날짜로 이동하고 월도 자동 전환(보기/수정).",
    prev_month:"이전",
    next_month:"다음",
    go_today:"오늘",

    tax_btn:"세금 알림",
    tax_title:"세금 알림(캐나다)",
    tax_self_employed:"자영업(Self-employed)",
    tax_hide_this_year:"올해는 숨기기",
    tax_restore:"복원",
    tax_note:"참고: 기한 알림용입니다. 최신 정보는 CRA 공지를 확인하세요.",

    tax_line_1:"• 신고 시즌: 보통 2월 하순부터 전자 신고(NETFILE) 가능.",
    tax_line_2:"• 개인: {apr30}까지 신고, 추가 납부가 있으면 {apr30}까지 납부.",
    tax_line_3:"• 자영업: 신고 마감 {jun15}, 단 추가 납부가 있으면 {apr30}까지 납부.",
    tax_line_4:"• 신고 후 CRA Notice of Assessment를 확인하세요.",
    tax_countdown_before:"신고 마감까지 {n}일",
    tax_countdown_window:"납부 종료까지 {n}일",
    tax_countdown_done:"올해 주요 기한이 지났습니다",

    plan_label:"이번 달 예산(계획)",
    plan_ph:"예: 1000",
    edit_calc:"수정(계산기)",
    undo:"되돌리기",

    edit_date_label:"날짜 편집(과거 수정)",
    picker_hint:"오늘까지 편집 가능(미래 불가). '확인'을 눌러야 반영됩니다.",

    month_calendar_label:"월간 달력",

    today_total_label:"오늘 지출",
    day_ph:"예: 35",

    confirm_edit:"확인",
    cancel_edit:"취소",

    tags_label:"태그(복수 선택)",
    tag_parking:"주차",
    tag_grocery:"마트",
    tag_dining:"외식",
    tag_gift:"선물",
    tag_transport:"교통/주유",
    tag_household:"생활용품",
    tag_bills:"청구/구독",
    tag_medical:"의료",
    tag_entertainment:"여가",
    tag_other:"기타",

    save_day:"저장",
    saved:"저장됨",

    avg_actual:"일평균(S ÷ d)",
    month_remaining:"남은 금액",

    month_list_title:"일별 목록(빨강=수정)",
    no_records:"(기록 없음)",

    footer_note:"참고: 통화는 표시만 변경(환율 변환 없음). 장부는 분리 저장. 입력은 즉시 저장되지 않으며 변경 후 '확인' 시 반영됩니다.",

    gate_title:"장부 이름 입력",
    gate_desc:"예: a / 가족 / Yang / 2025. 장부별 데이터는 완전히 분리됩니다.",
    gate_ph:"장부 이름(필수)",
    gate_enter:"입장",
    gate_cancel:"취소",
    gate_tip:"팁: 장부 이름은 로컬 저장(인터넷 없음). 같은 PC/브라우저 공유 시 다른 이름을 사용하세요.",

    calc_title:"계산기",
    close:"닫기",
    calc_clear:"초기화",
    calc_back:"지우기",
    confirm:"확인",
    cancel:"취소",
    write_back:"값 반영",

    month_prefix:"월: {ym}",
    spent_until:"현재까지 지출",
    spent_month:"월 지출",
    need_today:"초과 방지: 내일부터 필요한 일평균 ≤",
    need_ended:"월 종료",
    edit_prefix:"편집: {ymd}({wk})",

    cannot_future:"미래 날짜는 입력할 수 없습니다(예: 내일).",
    cannot_future_month:"미래 월은 편집할 수 없습니다.",

    delete_title:"장부 삭제",
    delete_note:"실수 방지를 위해 확인 버튼은 10초 후 활성화됩니다.",
    delete_confirm_prefix:"삭제({n}s)",
    delete_confirm_ready:"지금 삭제",
    delete_text:"장부 “{name}”을(를) 삭제할까요? 로컬 데이터는 삭제되며 복구할 수 없습니다.",

    input_book_name:"장부 이름을 입력하세요.",
    must_create_book:"먼저 장부 이름을 만들어 주세요.",
    expr_invalid:"식이 올바르지 않습니다",
    expr_invalid_alert:"식이 올바르지 않습니다. 수정 후 확인하세요.",
    cannot_future_short:"미래 날짜는 불가합니다.",

    week_sun:"일", week_mon:"월", week_tue:"화", week_wed:"수", week_thu:"목", week_fri:"금", week_sat:"토"
  },

  es: {
    lang_label:"Idioma",
    lang_hint:"Cambiar el idioma solo afecta a la interfaz; tus datos guardados no cambian.",

    book_current:"Libro actual", book_new:"Nuevo", book_delete:"Eliminar",
    book_hint:"Cada libro se guarda por separado; los datos no se mezclan.",

    currency_current:"Moneda",
    currency_hint:"Cambia solo la visualización (sin conversión).",

    months_title:"Meses",
    months_tip:"Muestra meses con registros y el mes actual. Haz clic para ver/editar.",

    legend_title:"Leyenda",
    legend_green:"Verde = con datos",
    legend_red:"Rojo = editado",
    legend_blue:"Azul = hoy",
    legend_white:"Blanco = vacío",

    app_title:"Gastos (estadísticas simples)",

    history_title:"Calendario histórico",
    history_tip_short:"Buscar registros por fecha",
    history_open:"Abrir",
    history_note:"Haz clic en un día para saltar a esa fecha y cambiar al mes correspondiente (ver/editar).",
    prev_month:"Mes ant.",
    next_month:"Mes sig.",
    go_today:"Hoy",

    tax_btn:"Recordatorio fiscal",
    tax_title:"Recordatorio fiscal (Canadá)",
    tax_self_employed:"Autónomo",
    tax_hide_this_year:"Ocultar este año",
    tax_restore:"Restaurar",
    tax_note:"Nota: solo recordatorio de fechas. Sigue las actualizaciones de la CRA.",

    tax_line_1:"• La temporada suele iniciar a finales de febrero (NETFILE).",
    tax_line_2:"• Personas: declarar antes de {apr30}; si debes, pagar antes de {apr30}.",
    tax_line_3:"• Autónomos: declarar antes de {jun15}, pero el pago (si se debe) sigue siendo {apr30}.",
    tax_line_4:"• Tras declarar, revisa el Notice of Assessment de la CRA.",
    tax_countdown_before:"Faltan {n} días para la fecha límite",
    tax_countdown_window:"Quedan {n} días para que termine el pago",
    tax_countdown_done:"Las fechas clave de este año ya pasaron",

    plan_label:"Presupuesto mensual (plan)",
    plan_ph:"p. ej., 1000",
    edit_calc:"Editar (Calculadora)",
    undo:"Deshacer",

    edit_date_label:"Editar fecha",
    picker_hint:"Solo puedes editar hasta hoy (sin fechas futuras). Aplica con “Confirmar”.",

    month_calendar_label:"Calendario mensual",

    today_total_label:"Gasto del día",
    day_ph:"p. ej., 35",

    confirm_edit:"Confirmar",
    cancel_edit:"Cancelar",

    tags_label:"Etiquetas (múltiple)",
    tag_parking:"Parking",
    tag_grocery:"Supermercado",
    tag_dining:"Comer fuera",
    tag_gift:"Regalos",
    tag_transport:"Transporte",
    tag_household:"Hogar",
    tag_bills:"Facturas/Suscripciones",
    tag_medical:"Salud",
    tag_entertainment:"Ocio",
    tag_other:"Otro",

    save_day:"Guardar día",
    saved:"Guardado",

    avg_actual:"Promedio diario (S ÷ d)",
    month_remaining:"Restante",

    month_list_title:"Lista diaria (rojo = editado)",
    no_records:"(Sin registros)",

    footer_note:"Nota: La moneda solo cambia la visualización (sin conversión). Cada libro se guarda separado. Los cambios se aplican al confirmar.",

    gate_title:"Introduce un nombre de libro",
    gate_desc:"Ejemplos: a / Familia / Yang / 2025. Cada libro está aislado.",
    gate_ph:"Nombre del libro (obligatorio)",
    gate_enter:"Entrar",
    gate_cancel:"Cancelar",
    gate_tip:"Consejo: se guarda localmente (sin internet). En un dispositivo compartido, usa nombres distintos.",

    calc_title:"Calculadora",
    close:"Cerrar",
    calc_clear:"Borrar",
    calc_back:"Retroceso",
    confirm:"OK",
    cancel:"Cancelar",
    write_back:"Escribir resultado",

    month_prefix:"Mes: {ym}",
    spent_until:"Gastado hasta ahora",
    spent_month:"Gastado en el mes",
    need_today:"Para no exceder: promedio diario desde mañana ≤",
    need_ended:"Mes finalizado",
    edit_prefix:"Editando: {ymd} ({wk})",

    cannot_future:"No se permiten fechas futuras (p. ej., mañana).",
    cannot_future_month:"No se puede editar meses futuros.",

    delete_title:"Eliminar libro",
    delete_note:"Para evitar errores, el botón se habilita tras 10 segundos.",
    delete_confirm_prefix:"Eliminar ({n}s)",
    delete_confirm_ready:"Eliminar ahora",
    delete_text:"¿Eliminar el libro “{name}”? Los datos locales se borrarán y no se podrán recuperar.",

    input_book_name:"Introduce un nombre de libro.",
    must_create_book:"Primero crea un nombre de libro.",
    expr_invalid:"Expresión inválida",
    expr_invalid_alert:"Expresión inválida. Corrígela antes de confirmar.",
    cannot_future_short:"No se permiten fechas futuras.",

    week_sun:"Dom", week_mon:"Lun", week_tue:"Mar", week_wed:"Mié", week_thu:"Jue", week_fri:"Vie", week_sat:"Sáb"
  },

  fr: {
    lang_label:"Langue",
    lang_hint:"Le changement de langue n’affecte que l’interface ; vos données restent inchangées.",

    book_current:"Carnet actuel", book_new:"Nouveau", book_delete:"Supprimer",
    book_hint:"Chaque carnet est stocké séparément ; les données ne se mélangent pas.",

    currency_current:"Devise",
    currency_hint:"Change l’affichage uniquement (sans conversion).",

    months_title:"Mois",
    months_tip:"Affiche les mois avec enregistrements et le mois en cours. Cliquez pour voir/modifier.",

    legend_title:"Légende",
    legend_green:"Vert = rempli",
    legend_red:"Rouge = modifié",
    legend_blue:"Bleu = aujourd’hui",
    legend_white:"Blanc = vide",

    app_title:"Dépenses (stats simples)",

    history_title:"Calendrier historique",
    history_tip_short:"Rechercher une date passée",
    history_open:"Ouvrir",
    history_note:"Cliquez sur un jour pour aller à cette date et basculer sur le mois correspondant (voir/modifier).",
    prev_month:"Mois préc.",
    next_month:"Mois suiv.",
    go_today:"Aujourd’hui",

    tax_btn:"Rappel fiscal",
    tax_title:"Rappel fiscal (Canada)",
    tax_self_employed:"Travailleur autonome",
    tax_hide_this_year:"Masquer cette année",
    tax_restore:"Restaurer",
    tax_note:"Note : rappel de dates uniquement. Suivez les mises à jour de l’ARC.",

    tax_line_1:"• La saison commence généralement fin février (NETFILE).",
    tax_line_2:"• Particuliers : déclarer avant {apr30} ; si dû, payer avant {apr30}.",
    tax_line_3:"• Autonomes : déclarer avant {jun15}, mais le paiement (si dû) reste {apr30}.",
    tax_line_4:"• Après la déclaration, vérifiez le Notice of Assessment.",
    tax_countdown_before:"{n} jours avant la date limite",
    tax_countdown_window:"{n} jours avant la fin du paiement",
    tax_countdown_done:"Les dates clés de cette année sont passées",

    plan_label:"Budget mensuel (plan)",
    plan_ph:"ex. 1000",
    edit_calc:"Modifier (Calculatrice)",
    undo:"Annuler",

    edit_date_label:"Modifier la date",
    picker_hint:"Modification possible jusqu’à aujourd’hui (pas de dates futures). Appliquer avec « Confirmer ».",

    month_calendar_label:"Calendrier du mois",

    today_total_label:"Dépense du jour",
    day_ph:"ex. 35",

    confirm_edit:"Confirmer",
    cancel_edit:"Annuler",

    tags_label:"Tags (multi)",
    tag_parking:"Parking",
    tag_grocery:"Courses",
    tag_dining:"Restaurant",
    tag_gift:"Cadeaux",
    tag_transport:"Transport",
    tag_household:"Maison",
    tag_bills:"Factures/Abonn.",
    tag_medical:"Médical",
    tag_entertainment:"Loisirs",
    tag_other:"Autre",

    save_day:"Enregistrer",
    saved:"Enregistré",

    avg_actual:"Moyenne/jour (S ÷ d)",
    month_remaining:"Reste",

    month_list_title:"Liste quotidienne (rouge = modifié)",
    no_records:"(Aucun enregistrement)",

    footer_note:"Note : la devise ne change que l’affichage (sans conversion). Chaque carnet est séparé. Les changements s’appliquent après confirmation.",

    gate_title:"Saisir un nom de carnet",
    gate_desc:"Exemples : a / Famille / Yang / 2025. Chaque carnet est isolé.",
    gate_ph:"Nom du carnet (obligatoire)",
    gate_enter:"Entrer",
    gate_cancel:"Annuler",
    gate_tip:"Astuce : stocké localement (sans internet). Sur un appareil partagé, utilisez des noms différents.",

    calc_title:"Calculatrice",
    close:"Fermer",
    calc_clear:"Effacer",
    calc_back:"Retour",
    confirm:"OK",
    cancel:"Annuler",
    write_back:"Reporter le résultat",

    month_prefix:"Mois : {ym}",
    spent_until:"Dépensé à ce jour",
    spent_month:"Dépensé dans le mois",
    need_today:"Pour ne pas dépasser : moyenne/jour dès demain ≤",
    need_ended:"Mois terminé",
    edit_prefix:"Édition : {ymd} ({wk})",

    cannot_future:"Dates futures non autorisées (ex. demain).",
    cannot_future_month:"Mois futurs non modifiables.",

    delete_title:"Supprimer le carnet",
    delete_note:"Pour éviter les erreurs, le bouton s’active après 10 secondes.",
    delete_confirm_prefix:"Supprimer ({n}s)",
    delete_confirm_ready:"Supprimer maintenant",
    delete_text:"Supprimer le carnet « {name} » ? Les données locales seront effacées et irrécupérables.",

    input_book_name:"Veuillez saisir un nom de carnet.",
    must_create_book:"Veuillez d’abord créer un carnet.",
    expr_invalid:"Expression invalide",
    expr_invalid_alert:"Expression invalide. Corrigez avant de confirmer.",
    cannot_future_short:"Dates futures non autorisées.",

    week_sun:"Dim", week_mon:"Lun", week_tue:"Mar", week_wed:"Mer", week_thu:"Jeu", week_fri:"Ven", week_sat:"Sam"
  },

  de: {
    lang_label:"Sprache",
    lang_hint:"Die Sprache ändert nur die Oberfläche; gespeicherte Daten bleiben erhalten.",

    book_current:"Aktuelles Buch", book_new:"Neu", book_delete:"Löschen",
    book_hint:"Jedes Buch wird separat gespeichert; Daten werden nicht vermischt.",

    currency_current:"Währung",
    currency_hint:"Nur Anzeige (keine Umrechnung).",

    months_title:"Monate",
    months_tip:"Zeigt Monate mit Einträgen und den текущий Monat. Klicken zum Anzeigen/Bearbeiten.",

    legend_title:"Legende",
    legend_green:"Grün = ausgefüllt",
    legend_red:"Rot = bearbeitet",
    legend_blue:"Blau = heute",
    legend_white:"Weiß = leer",

    app_title:"Ausgaben (einfache Statistik)",

    history_title:"Historischer Kalender",
    history_tip_short:"Beliebiges Datum suchen",
    history_open:"Öffnen",
    history_note:"Klicken Sie auf einen Tag, um zu diesem Datum zu springen und den Monat umzuschalten (anzeigen/bearbeiten).",
    prev_month:"Zurück",
    next_month:"Weiter",
    go_today:"Heute",

    tax_btn:"Steuer-Erinnerung",
    tax_title:"Steuer-Erinnerung (Kanada)",
    tax_self_employed:"Selbstständig",
    tax_hide_this_year:"Dieses Jahr ausblenden",
    tax_restore:"Wiederherstellen",
    tax_note:"Hinweis: Nur Frist-Erinnerung. Bitte CRA-Updates beachten.",

    tax_line_1:"• Die Saison startet meist Ende Februar (NETFILE).",
    tax_line_2:"• Privat: bis {apr30} einreichen; falls fällig, bis {apr30} zahlen.",
    tax_line_3:"• Selbstständig: Einreichung {jun15}, Zahlung (falls fällig) weiterhin {apr30}.",
    tax_line_4:"• Danach CRA Notice of Assessment prüfen.",
    tax_countdown_before:"Noch {n} Tage bis zur Frist",
    tax_countdown_window:"Noch {n} Tage bis Zahlungsende",
    tax_countdown_done:"Die wichtigen Fristen dieses Jahres sind vorbei",

    plan_label:"Monatsbudget (Plan)",
    plan_ph:"z. B. 1000",
    edit_calc:"Bearbeiten (Rechner)",
    undo:"Rückgängig",

    edit_date_label:"Datum bearbeiten",
    picker_hint:"Nur bis heute bearbeiten (keine Zukunft). Mit „Bestätigen“ anwenden.",

    month_calendar_label:"Monatskalender",

    today_total_label:"Tagesausgaben",
    day_ph:"z. B. 35",

    confirm_edit:"Bestätigen",
    cancel_edit:"Abbrechen",

    tags_label:"Tags (mehrfach)",
    tag_parking:"Parken",
    tag_grocery:"Einkauf",
    tag_dining:"Essen gehen",
    tag_gift:"Geschenke",
    tag_transport:"Transport",
    tag_household:"Haushalt",
    tag_bills:"Rechnungen/Abos",
    tag_medical:"Medizin",
    tag_entertainment:"Freizeit",
    tag_other:"Sonstiges",

    save_day:"Tag speichern",
    saved:"Gespeichert",

    avg_actual:"Tagesdurchschnitt (S ÷ d)",
    month_remaining:"Rest",

    month_list_title:"Tagesliste (rot = bearbeitet)",
    no_records:"(Keine Einträge)",

    footer_note:"Hinweis: Währung ändert nur die Anzeige (keine Umrechnung). Jedes Buch separat. Änderungen gelten nach Bestätigung.",

    gate_title:"Buchnamen eingeben",
    gate_desc:"Beispiele: a / Familie / Yang / 2025. Jedes Buch ist isoliert.",
    gate_ph:"Buchname (Pflicht)",
    gate_enter:"Start",
    gate_cancel:"Abbrechen",
    gate_tip:"Tipp: Lokal gespeichert (kein Internet). Auf gemeinsam genutzten Geräten unterschiedliche Namen verwenden.",

    calc_title:"Rechner",
    close:"Schließen",
    calc_clear:"Löschen",
    calc_back:"Zurück",
    confirm:"OK",
    cancel:"Abbrechen",
    write_back:"Ergebnis übernehmen",

    month_prefix:"Monat: {ym}",
    spent_until:"Bisher ausgegeben",
    spent_month:"Im Monat ausgegeben",
    need_today:"Nicht überziehen: benötigter Tagesdurchschnitt ab morgen ≤",
    need_ended:"Monat beendet",
    edit_prefix:"Bearbeitung: {ymd} ({wk})",

    cannot_future:"Zukünftige Daten sind nicht erlaubt (z. B. morgen).",
    cannot_future_month:"Zukünftige Monate können nicht bearbeitet werden.",

    delete_title:"Buch löschen",
    delete_note:"Zur Sicherheit wird die Bestätigung nach 10 Sekunden aktiviert.",
    delete_confirm_prefix:"Löschen ({n}s)",
    delete_confirm_ready:"Jetzt löschen",
    delete_text:"Buch „{name}“ löschen? Lokale Daten werden entfernt und können nicht wiederhergestellt werden.",

    input_book_name:"Bitte einen Buchnamen eingeben.",
    must_create_book:"Bitte zuerst ein Buch erstellen.",
    expr_invalid:"Ungültiger Ausdruck",
    expr_invalid_alert:"Ungültiger Ausdruck. Bitte vor dem Bestätigen korrigieren.",
    cannot_future_short:"Keine zukünftigen Daten.",

    week_sun:"So", week_mon:"Mo", week_tue:"Di", week_wed:"Mi", week_thu:"Do", week_fri:"Fr", week_sat:"Sa"
  },

  pt: {
    lang_label:"Idioma",
    lang_hint:"A troca de idioma muda apenas a interface; seus dados permanecem.",

    book_current:"Livro atual", book_new:"Novo", book_delete:"Excluir",
    book_hint:"Cada livro é armazenado separadamente; os dados não se misturam.",

    currency_current:"Moeda",
    currency_hint:"Apenas muda a exibição (sem conversão).",

    months_title:"Meses",
    months_tip:"Mostra meses com registros e o mês atual. Clique para ver/editar.",

    legend_title:"Legenda",
    legend_green:"Verde = preenchido",
    legend_red:"Vermelho = editado",
    legend_blue:"Azul = hoje",
    legend_white:"Branco = vazio",

    app_title:"Gastos (estatísticas simples)",

    history_title:"Calendário histórico",
    history_tip_short:"Encontrar registros por data",
    history_open:"Abrir",
    history_note:"Clique em um dia para ir à data e trocar para o mês correspondente (ver/editar).",
    prev_month:"Mês ant.",
    next_month:"Mês seg.",
    go_today:"Hoje",

    tax_btn:"Lembrete fiscal",
    tax_title:"Lembrete fiscal (Canadá)",
    tax_self_employed:"Autônomo",
    tax_hide_this_year:"Ocultar este ano",
    tax_restore:"Restaurar",
    tax_note:"Nota: apenas lembrete de prazos. Siga as atualizações da CRA.",

    tax_line_1:"• A temporada geralmente começa no fim de fevereiro (NETFILE).",
    tax_line_2:"• Pessoas: declarar até {apr30}; se houver saldo, pagar até {apr30}.",
    tax_line_3:"• Autônomos: declarar até {jun15}, mas o pagamento (se devido) ainda é {apr30}.",
    tax_line_4:"• Após declarar, verifique o Notice of Assessment da CRA.",
    tax_countdown_before:"Faltam {n} dias para o prazo",
    tax_countdown_window:"Restam {n} dias para o fim do pagamento",
    tax_countdown_done:"Os principais prazos deste ano já passaram",

    plan_label:"Orçamento mensal (plano)",
    plan_ph:"ex.: 1000",
    edit_calc:"Editar (Calculadora)",
    undo:"Desfazer",

    edit_date_label:"Editar data",
    picker_hint:"Você só pode editar até hoje (sem datas futuras). Aplique com “Confirmar”.",

    month_calendar_label:"Calendário do mês",

    today_total_label:"Gasto do dia",
    day_ph:"ex.: 35",

    confirm_edit:"Confirmar",
    cancel_edit:"Cancelar",

    tags_label:"Etiquetas (multi)",
    tag_parking:"Estacionamento",
    tag_grocery:"Mercado",
    tag_dining:"Refeição fora",
    tag_gift:"Presentes",
    tag_transport:"Transporte",
    tag_household:"Casa",
    tag_bills:"Contas/Assinaturas",
    tag_medical:"Médico",
    tag_entertainment:"Lazer",
    tag_other:"Outro",

    save_day:"Salvar dia",
    saved:"Salvo",

    avg_actual:"Média diária (S ÷ d)",
    month_remaining:"Restante",

    month_list_title:"Lista diária (vermelho = editado)",
    no_records:"(Sem registros)",

    footer_note:"Nota: a moeda muda apenas a exibição (sem conversão). Cada livro separado. Mudanças valem após confirmar.",

    gate_title:"Digite um nome de livro",
    gate_desc:"Exemplos: a / Família / Yang / 2025. Cada livro é isolado.",
    gate_ph:"Nome do livro (obrigatório)",
    gate_enter:"Entrar",
    gate_cancel:"Cancelar",
    gate_tip:"Dica: salvo localmente (sem internet). Em dispositivos compartilhados, use nomes diferentes.",

    calc_title:"Calculadora",
    close:"Fechar",
    calc_clear:"Limpar",
    calc_back:"Apagar",
    confirm:"OK",
    cancel:"Cancelar",
    write_back:"Aplicar resultado",

    month_prefix:"Mês: {ym}",
    spent_until:"Gasto até agora",
    spent_month:"Gasto no mês",
    need_today:"Para não exceder: média diária a partir de amanhã ≤",
    need_ended:"Mês encerrado",
    edit_prefix:"Editando: {ymd} ({wk})",

    cannot_future:"Datas futuras não são permitidas (ex.: amanhã).",
    cannot_future_month:"Meses futuros não podem ser editados.",

    delete_title:"Excluir livro",
    delete_note:"Para evitar erros, o botão ativa após 10 segundos.",
    delete_confirm_prefix:"Excluir ({n}s)",
    delete_confirm_ready:"Excluir agora",
    delete_text:"Excluir o livro “{name}”? Os dados locais serão removidos e não poderão ser recuperados.",

    input_book_name:"Digite um nome de livro.",
    must_create_book:"Crie um livro primeiro.",
    expr_invalid:"Expressão inválida",
    expr_invalid_alert:"Expressão inválida. Corrija antes de confirmar.",
    cannot_future_short:"Datas futuras não são permitidas.",

    week_sun:"Dom", week_mon:"Seg", week_tue:"Ter", week_wed:"Qua", week_thu:"Qui", week_fri:"Sex", week_sat:"Sáb"
  },

  ru: {
    lang_label:"Язык",
    lang_hint:"Смена языка влияет только на интерфейс; ваши данные не меняются.",

    book_current:"Текущая книга", book_new:"Новая", book_delete:"Удалить",
    book_hint:"Каждая книга хранится отдельно; данные не смешиваются.",

    currency_current:"Валюта",
    currency_hint:"Меняет только отображение (без конвертации).",

    months_title:"Месяцы",
    months_tip:"Показывает месяцы с записями и текущий месяц. Нажмите для просмотра/редактирования.",

    legend_title:"Легенда",
    legend_green:"Зелёный = заполнено",
    legend_red:"Красный = изменено",
    legend_blue:"Синий = сегодня",
    legend_white:"Белый = пусто",

    app_title:"Расходы (простая статистика)",

    history_title:"Исторический календарь",
    history_tip_short:"Найти запись по дате",
    history_open:"Открыть",
    history_note:"Нажмите на день, чтобы перейти к дате и переключить месяц (просмотр/редактирование).",
    prev_month:"Пред.",
    next_month:"След.",
    go_today:"Сегодня",

    tax_btn:"Налоговое напоминание",
    tax_title:"Налоговое напоминание (Канада)",
    tax_self_employed:"Самозанятый",
    tax_hide_this_year:"Скрыть на этот год",
    tax_restore:"Восстановить",
    tax_note:"Примечание: только напоминание о сроках. Следуйте обновлениям CRA.",

    tax_line_1:"• Сезон обычно начинается в конце февраля (NETFILE).",
    tax_line_2:"• Физлица: подать до {apr30}; если нужно доплатить — до {apr30}.",
    tax_line_3:"• Самозанятые: подача до {jun15}, но оплата (если есть) всё равно до {apr30}.",
    tax_line_4:"• После подачи проверьте Notice of Assessment.",
    tax_countdown_before:"До срока осталось {n} дн.",
    tax_countdown_window:"До конца оплаты осталось {n} дн.",
    tax_countdown_done:"Ключевые сроки этого года уже прошли",

    plan_label:"План на месяц",
    plan_ph:"напр., 1000",
    edit_calc:"Изменить (калькулятор)",
    undo:"Отменить",

    edit_date_label:"Редактировать дату",
    picker_hint:"Можно редактировать только до сегодняшнего дня (без будущих дат). Примените «Подтвердить».",

    month_calendar_label:"Календарь месяца",

    today_total_label:"Расход за день",
    day_ph:"напр., 35",

    confirm_edit:"Подтвердить",
    cancel_edit:"Отмена",

    tags_label:"Теги (несколько)",
    tag_parking:"Парковка",
    tag_grocery:"Покупки",
    tag_dining:"Еда вне дома",
    tag_gift:"Подарки",
    tag_transport:"Транспорт",
    tag_household:"Дом",
    tag_bills:"Счета/подписки",
    tag_medical:"Медицина",
    tag_entertainment:"Досуг",
    tag_other:"Другое",

    save_day:"Сохранить",
    saved:"Сохранено",

    avg_actual:"Средн./день (S ÷ d)",
    month_remaining:"Остаток",

    month_list_title:"Список по дням (красный = изменено)",
    no_records:"(Нет записей)",

    footer_note:"Примечание: валюта меняет только отображение (без конвертации). Каждая книга отдельно. Изменения применяются после подтверждения.",

    gate_title:"Введите имя книги",
    gate_desc:"Примеры: a / Family / Yang / 2025. Каждая книга изолирована.",
    gate_ph:"Имя книги (обязательно)",
    gate_enter:"Войти",
    gate_cancel:"Отмена",
    gate_tip:"Подсказка: хранится локально (без интернета). На общем устройстве используйте разные имена.",

    calc_title:"Калькулятор",
    close:"Закрыть",
    calc_clear:"Очистить",
    calc_back:"Назад",
    confirm:"OK",
    cancel:"Отмена",
    write_back:"Записать результат",

    month_prefix:"Месяц: {ym}",
    spent_until:"Потрачено",
    spent_month:"Потрачено в месяце",
    need_today:"Чтобы не превысить: среднее с завтра ≤",
    need_ended:"Месяц завершён",
    edit_prefix:"Редактирование: {ymd} ({wk})",

    cannot_future:"Будущие даты запрещены (например, завтра).",
    cannot_future_month:"Будущие месяцы нельзя редактировать.",

    delete_title:"Удалить книгу",
    delete_note:"Чтобы избежать ошибок, кнопка активируется через 10 секунд.",
    delete_confirm_prefix:"Удалить ({n}с)",
    delete_confirm_ready:"Удалить сейчас",
    delete_text:"Удалить книгу «{name}»? Локальные данные будут удалены без возможности восстановления.",

    input_book_name:"Введите имя книги.",
    must_create_book:"Сначала создайте книгу.",
    expr_invalid:"Неверное выражение",
    expr_invalid_alert:"Неверное выражение. Исправьте перед подтверждением.",
    cannot_future_short:"Будущие даты запрещены.",

    week_sun:"Вс", week_mon:"Пн", week_tue:"Вт", week_wed:"Ср", week_thu:"Чт", week_fri:"Пт", week_sat:"Сб"
  },

  ar: {
    lang_label:"اللغة",
    lang_hint:"تغيير اللغة يؤثر على الواجهة فقط؛ بياناتك المحفوظة لا تتغير.",

    book_current:"الدفتر الحالي", book_new:"جديد", book_delete:"حذف",
    book_hint:"كل دفتر يُحفظ بشكل مستقل؛ البيانات لا تختلط.",

    currency_current:"العملة",
    currency_hint:"تغيير العرض فقط (بدون تحويل عملات).",

    months_title:"الأشهر",
    months_tip:"يعرض الأشهر التي بها سجلات والشهر الحالي. انقر للعرض/التعديل.",

    legend_title:"الدليل",
    legend_green:"أخضر = مُعبّأ",
    legend_red:"أحمر = مُعدّل",
    legend_blue:"أزرق = اليوم",
    legend_white:"أبيض = فارغ",

    app_title:"المصروفات (إحصاءات بسيطة)",

    history_title:"تقويم السجل",
    history_tip_short:"ابحث عن أي تاريخ سابق",
    history_open:"فتح",
    history_note:"انقر على يوم للانتقال إلى ذلك التاريخ وتبديل الشهر تلقائياً (عرض/تعديل).",
    prev_month:"السابق",
    next_month:"التالي",
    go_today:"اليوم",

    tax_btn:"تذكير الضرائب",
    tax_title:"تذكير الضرائب (كندا)",
    tax_self_employed:"عمل حر",
    tax_hide_this_year:"إخفاء هذا العام",
    tax_restore:"استعادة",
    tax_note:"ملاحظة: تذكير بالمواعيد فقط. اتبع تحديثات CRA.",

    tax_line_1:"• يبدأ الموسم عادة في أواخر فبراير (NETFILE).",
    tax_line_2:"• الأفراد: الإقرار قبل {apr30}؛ وإذا كان عليك دفع، فقبل {apr30}.",
    tax_line_3:"• العمل الحر: الإقرار {jun15} لكن الدفع (إن وُجد) يبقى {apr30}.",
    tax_line_4:"• بعد الإقرار، راجع Notice of Assessment.",
    tax_countdown_before:"متبقي {n} يوم حتى الموعد النهائي",
    tax_countdown_window:"متبقي {n} يوم حتى نهاية الدفع",
    tax_countdown_done:"انتهت المواعيد الرئيسية لهذا العام",

    plan_label:"خطة الميزانية الشهرية",
    plan_ph:"مثال: 1000",
    edit_calc:"تعديل (آلة حاسبة)",
    undo:"تراجع",

    edit_date_label:"تعديل التاريخ",
    picker_hint:"يمكنك التعديل حتى اليوم فقط (لا تواريخ مستقبلية). طبّق عبر «تأكيد».",

    month_calendar_label:"تقويم الشهر",

    today_total_label:"مصروف اليوم",
    day_ph:"مثال: 35",

    confirm_edit:"تأكيد",
    cancel_edit:"إلغاء",

    tags_label:"وسوم (متعدد)",
    tag_parking:"مواقف",
    tag_grocery:"بقالة",
    tag_dining:"مطاعم",
    tag_gift:"هدايا",
    tag_transport:"نقل",
    tag_household:"منزل",
    tag_bills:"فواتير/اشتراكات",
    tag_medical:"صحة",
    tag_entertainment:"ترفيه",
    tag_other:"أخرى",

    save_day:"حفظ اليوم",
    saved:"تم الحفظ",

    avg_actual:"متوسط يومي (S ÷ d)",
    month_remaining:"المتبقي",

    month_list_title:"قائمة الأيام (الأحمر = مُعدّل)",
    no_records:"(لا توجد سجلات)",

    footer_note:"ملاحظة: العملة تغيّر العرض فقط (بدون تحويل). كل دفتر مستقل. التغييرات تُطبق بعد التأكيد.",

    gate_title:"أدخل اسم الدفتر",
    gate_desc:"أمثلة: a / Family / Yang / 2025. كل دفتر معزول.",
    gate_ph:"اسم الدفتر (إلزامي)",
    gate_enter:"دخول",
    gate_cancel:"إلغاء",
    gate_tip:"نصيحة: يُحفظ محلياً (بدون إنترنت). على جهاز مشترك استخدم أسماء مختلفة.",

    calc_title:"آلة حاسبة",
    close:"إغلاق",
    calc_clear:"مسح",
    calc_back:"رجوع",
    confirm:"موافق",
    cancel:"إلغاء",
    write_back:"إرجاع النتيجة",

    month_prefix:"الشهر: {ym}",
    spent_until:"المصروف حتى الآن",
    spent_month:"المصروف في الشهر",
    need_today:"لتجنب التجاوز: متوسط يومي بدءاً من الغد ≤",
    need_ended:"انتهى الشهر",
    edit_prefix:"تعديل: {ymd} ({wk})",

    cannot_future:"لا يُسمح بالتواريخ المستقبلية (مثل الغد).",
    cannot_future_month:"لا يمكن تعديل الأشهر المستقبلية.",

    delete_title:"حذف الدفتر",
    delete_note:"لتجنب الخطأ، زر التأكيد يتفعّل بعد 10 ثوانٍ.",
    delete_confirm_prefix:"حذف ({n}ث)",
    delete_confirm_ready:"حذف الآن",
    delete_text:"هل تريد حذف الدفتر «{name}»؟ ستُحذف البيانات المحلية ولا يمكن استعادتها.",

    input_book_name:"يرجى إدخال اسم الدفتر.",
    must_create_book:"يرجى إنشاء دفتر أولاً.",
    expr_invalid:"تعبير غير صالح",
    expr_invalid_alert:"تعبير غير صالح. صححه قبل التأكيد.",
    cannot_future_short:"لا تواريخ مستقبلية.",

    week_sun:"أحد", week_mon:"اثن", week_tue:"ثلث", week_wed:"أرب", week_thu:"خمس", week_fri:"جمع", week_sat:"سبت"
  }
};

function getSavedLang(){ return localStorage.getItem("budgetTool_lang") || "zh"; }
function setSavedLang(lang){ localStorage.setItem("budgetTool_lang", lang); }
function t(key, vars = {}){
  const lang = getSavedLang();
  const dict = I18N[lang] || I18N.zh;
  let s = (dict[key] ?? I18N.zh[key] ?? key);
  for (const [k, v] of Object.entries(vars)) s = s.replaceAll(`{${k}}`, String(v));
  return s;
}
function applyI18n(){
  document.documentElement.lang = getSavedLang();
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const key = el.getAttribute("data-i18n");
    el.textContent = t(key);
  });
  document.querySelectorAll("[data-i18n-placeholder]").forEach(el=>{
    const key = el.getAttribute("data-i18n-placeholder");
    el.setAttribute("placeholder", t(key));
  });

  renderTopLines?.();
  renderEditLine?.();
  renderTaxModalText?.();
  renderTaxCountdown?.();
  renderHistoryWeekRow?.();
  renderHistoryCalendar?.();
}

function initI18n(){
  const sel = document.getElementById("langSelect");
  if (!sel) return;
  sel.value = getSavedLang();
  sel.addEventListener("change", ()=>{
    setSavedLang(sel.value);
    applyI18n();
    renderStatsAndList?.();
    renderMonthCalendar?.();
    buildMonthList?.();
  });
  applyI18n();
}

/***********************
 * Tax Reminder (按钮 + 倒计时 + 可恢复)
 ***********************/
function taxYearKey(){
  const y = new Date().getFullYear();
  return `budgetTool_tax_hide_${y}`;
}
function isTaxHiddenForYear(){ return localStorage.getItem(taxYearKey()) === "1"; }
function setTaxHiddenForYear(v){ localStorage.setItem(taxYearKey(), v ? "1" : "0"); }
function ymdOf(month, day){
  const y = new Date().getFullYear();
  const mm = String(month).padStart(2,"0");
  const dd = String(day).padStart(2,"0");
  return `${y}-${mm}-${dd}`;
}
function daysBetween(aYmd, bYmd){
  // b - a, in days
  const a = new Date(aYmd + "T00:00:00");
  const b = new Date(bYmd + "T00:00:00");
  return Math.round((b - a) / (1000*60*60*24));
}

let taxCountdownTimer = null;

function renderTaxModalText(){
  const text = document.getElementById("taxReminderText");
  const selfToggle = document.getElementById("isSelfEmployedToggle");
  const hideToggle = document.getElementById("hideTaxReminderToggle");
  const unhideBtn = document.getElementById("taxUnhideBtn");
  if (!text || !selfToggle || !hideToggle || !unhideBtn) return;

  const apr30 = ymdOf(4,30);
  const jun15 = ymdOf(6,15);

  const lines = [
    t("tax_line_1"),
    t("tax_line_2", { apr30 }),
    t("tax_line_3", { jun15, apr30 }),
    t("tax_line_4")
  ];

  const isSE = !!selfToggle.checked;
  text.innerHTML = `
    <div>${lines[0]}</div>
    <div>${lines[1]}</div>
    <div style="${isSE ? "font-weight:900;" : ""}">${lines[2]}</div>
    <div>${lines[3]}</div>
  `;

  // 隐藏状态：仍可在弹窗内恢复
  const hidden = isTaxHiddenForYear();
  hideToggle.checked = hidden;
  unhideBtn.disabled = !hidden;
}

function renderTaxCountdown(){
  const out = document.getElementById("taxCountdownText");
  const selfToggle = document.getElementById("isSelfEmployedToggle");
  if (!out || !selfToggle) return;

  const today = new Date();
  const todayYmd = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,"0")}-${String(today.getDate()).padStart(2,"0")}`;

  // 这里按你的需求：倒计时始终显示在按钮旁边（不因为隐藏就没了）
  const filingDeadline = selfToggle.checked ? ymdOf(6,15) : ymdOf(4,30);
  const payDeadline = ymdOf(4,30);

  // 文案规则：
  // 1) 如果今天 < 申报截止（普通4/30，自雇6/15） -> “距离报税截止还有N天”
  // 2) 如果今天在 [4/30, 6/15] 且自雇 -> “距离纳税结束还有N天”（这里纳税结束按6/15）
  // 3) 其他情况 -> “本年度税务关键期限已过”
  const isSE = !!selfToggle.checked;

  if (todayYmd < filingDeadline) {
    const n = daysBetween(todayYmd, filingDeadline);
    out.innerHTML = `<strong>${t("tax_countdown_before",{n})}</strong>`;
    return;
  }

  if (isSE && todayYmd >= payDeadline && todayYmd <= ymdOf(6,15)) {
    const n = daysBetween(todayYmd, ymdOf(6,15));
    out.innerHTML = `<strong>${t("tax_countdown_window",{n})}</strong>`;
    return;
  }

  out.textContent = t("tax_countdown_done");
}

function openTax(){
  const mask = document.getElementById("taxMask");
  if (!mask) return;
  renderTaxModalText();
  renderTaxCountdown();
  mask.style.display = "flex";
  mask.setAttribute("aria-hidden","false");
}
function closeTax(){
  const mask = document.getElementById("taxMask");
  if (!mask) return;
  mask.style.display = "none";
  mask.setAttribute("aria-hidden","true");
}

function initTaxReminder(){
  const openBtn = document.getElementById("taxOpenBtn");
  const closeBtn = document.getElementById("taxClose");
  const okBtn = document.getElementById("taxOkBtn");
  const mask = document.getElementById("taxMask");
  const selfToggle = document.getElementById("isSelfEmployedToggle");
  const hideToggle = document.getElementById("hideTaxReminderToggle");
  const unhideBtn = document.getElementById("taxUnhideBtn");
  if (!openBtn || !closeBtn || !okBtn || !mask || !selfToggle || !hideToggle || !unhideBtn) return;

  openBtn.addEventListener("click", openTax);
  closeBtn.addEventListener("click", closeTax);
  okBtn.addEventListener("click", closeTax);
  mask.addEventListener("click",(e)=>{ if (e.target === mask) closeTax(); });

  selfToggle.addEventListener("change", ()=>{
    renderTaxModalText();
    renderTaxCountdown();
  });

  hideToggle.addEventListener("change", ()=>{
    setTaxHiddenForYear(hideToggle.checked);
    renderTaxModalText();
    // 注意：隐藏不影响“税务提醒按钮”存在；只是你自己可以选择今年不看弹窗内容
  });

  unhideBtn.addEventListener("click", ()=>{
    setTaxHiddenForYear(false);
    renderTaxModalText();
  });

  // 按钮旁倒计时每小时更新一次，避免跨天不刷新
  if (taxCountdownTimer) clearInterval(taxCountdownTimer);
  taxCountdownTimer = setInterval(renderTaxCountdown, 60*60*1000);
  renderTaxCountdown();
}

/***********************
 * 历史日历弹窗（解决问题1：点击无反应）
 ***********************/
const historyMask = document.getElementById("historyMask");
const historyOpenBtn = document.getElementById("historyOpenBtn");
const historyClose = document.getElementById("historyClose");
const histPrevBtn = document.getElementById("histPrevBtn");
const histNextBtn = document.getElementById("histNextBtn");
const histTodayBtn = document.getElementById("histTodayBtn");
const histYmText = document.getElementById("histYmText");
const histWeekRow = document.getElementById("histWeekRow");
const histCalendarGrid = document.getElementById("histCalendarGrid");

function parseYm(ymStr){ const [y,m] = ymStr.split("-").map(Number); return {y,m}; }
function pad2(n){ return String(n).padStart(2,"0"); }
function daysInMonth(y,m){ return new Date(y, m, 0).getDate(); }

let histYm = null; // 'YYYY-MM'
let _todayYmd = null;

function computeTodayYmd(){
  const d = new Date();
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
}
function addMonths(ymStr, delta){
  const {y,m} = parseYm(ymStr);
  const d = new Date(y, m-1, 1);
  d.setMonth(d.getMonth()+delta);
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
}

function renderHistoryWeekRow(){
  if (!histWeekRow) return;
  const lang = getSavedLang();
  const zh = ["日","一","二","三","四","五","六"].map((x,i)=> t(["week_sun","week_mon","week_tue","week_wed","week_thu","week_fri","week_sat"][i]));
  const en = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].map((x,i)=> t(["week_sun","week_mon","week_tue","week_wed","week_thu","week_fri","week_sat"][i]));
  const labels = (lang === "zh") ? zh : en;
  histWeekRow.innerHTML = labels.map(x=>`<div>${x}</div>`).join("");
}

function openHistory(){
  if (!historyMask) return;
  _todayYmd = computeTodayYmd();
  histYm = histYm || _todayYmd.slice(0,7);
  renderHistoryWeekRow();
  renderHistoryCalendar();
  historyMask.style.display="flex";
  historyMask.setAttribute("aria-hidden","false");
}
function closeHistory(){
  if (!historyMask) return;
  historyMask.style.display="none";
  historyMask.setAttribute("aria-hidden","true");
}

function renderHistoryCalendar(){
  if (!histYmText || !histCalendarGrid) return;
  if (!_todayYmd) _todayYmd = computeTodayYmd();

  histYmText.textContent = histYm;

  const {y,m} = parseYm(histYm);
  const firstDow = new Date(y, m-1, 1).getDay();
  const dim = daysInMonth(y,m);

  let html = "";
  for (let i=0;i<firstDow;i++) html += `<div class="day-cell day-pad"></div>`;

  // 这里会用到“当前账本的数据”：bookData / ensureMonth / normalizeRecord / monthRecordedDaysCount 等
  // 所以第3段里会保证这些变量/函数存在。
  const md = (typeof ensureMonth === "function" && window.bookData) ? ensureMonth(window.bookData, histYm) : null;

  for (let d=1; d<=dim; d++){
    const ymd = `${histYm}-${pad2(d)}`;
    const isFuture = ymd > _todayYmd;
    let cls = "day-empty";
    if (ymd === _todayYmd) cls = "day-today";

    if (md && md.days && md.days[ymd]) {
      const rec = (typeof normalizeRecord === "function") ? normalizeRecord(md.days[ymd]) : md.days[ymd];
      if (rec && rec.edited) cls = "day-edited";
      else if (rec && typeof rec.total === "number") cls = "day-recorded";
    }

    const dis = isFuture ? `style="opacity:.35;cursor:not-allowed;"` : "";
    html += `<div class="day-cell ${cls}" data-hdate="${ymd}" ${dis}>${d}</div>`;
  }

  histCalendarGrid.innerHTML = html;

  histCalendarGrid.querySelectorAll(".day-cell[data-hdate]").forEach(el=>{
    el.addEventListener("click", ()=>{
      const d = el.getAttribute("data-hdate");
      if (!d) return;
      if (d > _todayYmd) return;

      // 关键：点历史日历 -> 直接切换主界面的月份与编辑日
      if (typeof switchMonth === "function") switchMonth(d.slice(0,7), d);
      closeHistory();
    });
  });

  // future month 禁止右翻（超过当前月）
  const curYm = _todayYmd.slice(0,7);
  if (histNextBtn) histNextBtn.disabled = histYm >= curYm;
}

function initHistoryCalendar(){
  if (!historyOpenBtn || !historyClose || !historyMask || !histPrevBtn || !histNextBtn || !histTodayBtn) return;

  historyOpenBtn.addEventListener("click", openHistory);
  historyClose.addEventListener("click", closeHistory);
  historyMask.addEventListener("click",(e)=>{ if (e.target === historyMask) closeHistory(); });

  histPrevBtn.addEventListener("click", ()=>{
    histYm = addMonths(histYm, -1);
    renderHistoryCalendar();
  });
  histNextBtn.addEventListener("click", ()=>{
    const curYm = computeTodayYmd().slice(0,7);
    if (histYm >= curYm) return;
    histYm = addMonths(histYm, +1);
    renderHistoryCalendar();
  });
  histTodayBtn.addEventListener("click", ()=>{
    histYm = computeTodayYmd().slice(0,7);
    renderHistoryCalendar();
  });
}
<!-- =========================
最终版 · 第 3 / 3 段（收尾段）
内容：数据结构/本地存储（账本隔离）+ 主界面渲染 + 日历颜色规则(白/绿/红/蓝) + 计算器 + 删除账本(居中弹窗10秒) + 启动入口
说明：本段默认你已粘贴了第1段(HTML/CSS骨架)与第2段(i18n+税务+历史日历)
========================= -->

/***********************
 * 工具：安全 JSON 读写
 ***********************/
function safeJsonParse(s, fallback){
  try { return JSON.parse(s); } catch(e){ return fallback; }
}
function saveLocal(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
function loadLocal(key, fallback){ return safeJsonParse(localStorage.getItem(key), fallback); }

/***********************
 * 账本隔离：每个账本一个 key
 ***********************/
function bookKey(name){ return `budgetTool_book_${name}`; }
function getCurrentBookName(){ return localStorage.getItem("budgetTool_currentBook") || ""; }
function setCurrentBookName(name){ localStorage.setItem("budgetTool_currentBook", name); }

/***********************
 * 数据结构
 * bookData = {
 *   version: 1,
 *   currency: "CAD",
 *   months: {
 *     "YYYY-MM": {
 *       plan: number|null,
 *       days: {
 *         "YYYY-MM-DD": { total:number, tags: string[], edited:boolean, lastSaved:number }
 *       }
 *     }
 *   }
 * }
 ***********************/
function defaultBookData(){
  return { version: 1, currency: "CAD", months: {} };
}
function loadBookData(bookName){
  return loadLocal(bookKey(bookName), defaultBookData());
}
function saveBookData(bookName, data){
  saveLocal(bookKey(bookName), data);
}

function ensureMonth(bookData, ym){
  if (!bookData.months) bookData.months = {};
  if (!bookData.months[ym]) bookData.months[ym] = { plan: null, days: {} };
  if (!bookData.months[ym].days) bookData.months[ym].days = {};
  return bookData.months[ym];
}
function normalizeRecord(rec){
  if (!rec) return null;
  return {
    total: (typeof rec.total === "number") ? rec.total : Number(rec.total || 0),
    tags: Array.isArray(rec.tags) ? rec.tags : [],
    edited: !!rec.edited,
    lastSaved: rec.lastSaved || 0
  };
}

/***********************
 * 日期：今天 / 当前月份 / 当前编辑日
 ***********************/
function todayYmd(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${dd}`;
}
function currentYm(){
  return todayYmd().slice(0,7);
}
function isFuture(ymd){
  return ymd > todayYmd();
}

/***********************
 * DOM 引用（第1段里已有相应 id）
 ***********************/
const elAppTitle = document.getElementById("appTitle");
const elLangHint = document.getElementById("langHint");
const elBookHint = document.getElementById("bookHint");
const elCurrencyHint = document.getElementById("currencyHint");

const elBookName = document.getElementById("bookNameText");
const elBookNewBtn = document.getElementById("newBookBtn");
const elBookDelBtn = document.getElementById("deleteBookBtn");

const elCurrencySel = document.getElementById("currencySelect");

const elMonthSelect = document.getElementById("monthSelect");
const elMonthsTip = document.getElementById("monthsTip");

const elTopLines = document.getElementById("topLines");
const elEditLine = document.getElementById("editLine");

const elPlanInput = document.getElementById("planInput");
const elPlanCalcBtn = document.getElementById("planCalcBtn");

const elEditDateInput = document.getElementById("editDateInput");
const elConfirmEditBtn = document.getElementById("confirmEditBtn");
const elCancelEditBtn = document.getElementById("cancelEditBtn");

const elDayTotalInput = document.getElementById("dayTotalInput");
const elTagsWrap = document.getElementById("tagsWrap");

const elSaveDayBtn = document.getElementById("saveDayBtn");
const elSavedToast = document.getElementById("savedToast");

const elMonthCalGrid = document.getElementById("monthCalGrid");
const elDailyList = document.getElementById("dailyList");

const elUndoBtn = document.getElementById("undoBtn");

/***********************
 * 全局状态
 ***********************/
window.bookData = null;
let currentBook = "";
let selectedYm = currentYm();
let selectedYmd = todayYmd();

// 编辑缓冲：只有点“确认修改”才写入
let draft = {
  plan: null,
  dayTotal: null,
  tags: null
};
let originalSnapshot = null; // 用于撤销
let undoStack = [];          // 简单撤销：最近一次保存前快照

/***********************
 * 颜色规则（你要求的：白/绿/红/蓝）
 * - 蓝：今天
 * - 红：edited=true（该日曾修改）
 * - 绿：已填写（有 total）
 * - 白：未填写
 ***********************/
function getDayClass(ymd, rec){
  if (ymd === todayYmd()) return "day-today";      // 蓝优先
  if (rec && rec.edited) return "day-edited";      // 红
  if (rec && typeof rec.total === "number") return "day-recorded"; // 绿
  return "day-empty";                               // 白
}

/***********************
 * 月份列表：只显示“有记录的过往月份 + 当前月”
 ***********************/
function getMonthsToShow(bookData){
  const months = Object.keys(bookData.months || {});
  const cur = currentYm();
  const hasRecords = months.filter(ym=>{
    const md = bookData.months[ym];
    if (!md || !md.days) return false;
    return Object.keys(md.days).length > 0 || (typeof md.plan === "number");
  });
  const set = new Set(hasRecords);
  set.add(cur);
  // 只保留 <= 当前月
  const filtered = Array.from(set).filter(ym=> ym <= cur);
  filtered.sort(); // 升序
  return filtered;
}

function buildMonthList(){
  if (!elMonthSelect || !window.bookData) return;
  const list = getMonthsToShow(window.bookData);
  elMonthSelect.innerHTML = list.map(ym=>`<option value="${ym}">${ym}</option>`).join("");
  if (!list.includes(selectedYm)) selectedYm = currentYm();
  elMonthSelect.value = selectedYm;
}

/***********************
 * 顶部统计行（示例：月计划、已花、日均）
 * 你原来的逻辑我用“可解释、可维护”的方式补齐：
 ***********************/
function sumMonth(md){
  let sum = 0;
  const days = md?.days || {};
  for (const v of Object.values(days)) {
    const r = normalizeRecord(v);
    if (r && typeof r.total === "number") sum += r.total;
  }
  return sum;
}
function countRecordedDays(md){
  const days = md?.days || {};
  let c = 0;
  for (const v of Object.values(days)) {
    const r = normalizeRecord(v);
    if (r && typeof r.total === "number") c++;
  }
  return c;
}

function renderTopLines(){
  if (!elTopLines || !window.bookData) return;
  const md = ensureMonth(window.bookData, selectedYm);
  const spent = sumMonth(md);
  const dCount = countRecordedDays(md);
  const avg = dCount ? (spent / dCount) : 0;

  const plan = (typeof md.plan === "number") ? md.plan : null;
  const remaining = (plan === null) ? null : (plan - spent);

  const currency = window.bookData.currency || "CAD";
  const fmt = (n)=> `${n.toFixed(2)} ${currency}`;

  let html = "";
  html += `<div><strong>${t("month_prefix",{ym:selectedYm})}</strong></div>`;
  html += `<div>${t("spent_month")}: <strong>${fmt(spent)}</strong></div>`;
  html += `<div>${t("avg_actual")}: <strong>${fmt(avg)}</strong></div>`;
  if (plan !== null) html += `<div>${t("plan_label")}: <strong>${fmt(plan)}</strong> / ${t("month_remaining")}: <strong>${fmt(remaining)}</strong></div>`;
  elTopLines.innerHTML = html;
}

function renderEditLine(){
  if (!elEditLine) return;
  const wkMap = ["week_sun","week_mon","week_tue","week_wed","week_thu","week_fri","week_sat"];
  const d = new Date(selectedYmd + "T00:00:00");
  const wk = t(wkMap[d.getDay()]);
  elEditLine.textContent = t("edit_prefix",{ ymd:selectedYmd, wk });
}

/***********************
 * 主月日历渲染（白/绿/红/蓝）
 ***********************/
function daysInMonth(y,m){ return new Date(y, m, 0).getDate(); }
function renderMonthCalendar(){
  if (!elMonthCalGrid || !window.bookData) return;

  const {y,m} = (function(){
    const [yy,mm] = selectedYm.split("-").map(Number);
    return {y:yy,m:mm};
  })();

  const firstDow = new Date(y, m-1, 1).getDay();
  const dim = daysInMonth(y,m);
  const md = ensureMonth(window.bookData, selectedYm);

  let html = "";
  for (let i=0;i<firstDow;i++) html += `<div class="day-cell day-pad"></div>`;

  for (let d=1; d<=dim; d++){
    const ymd = `${selectedYm}-${String(d).padStart(2,"0")}`;
    const rec = md.days[ymd] ? normalizeRecord(md.days[ymd]) : null;

    const cls = getDayClass(ymd, rec);
    const disabled = (ymd > todayYmd()) ? `style="opacity:.35;cursor:not-allowed;"` : "";
    html += `<div class="day-cell ${cls}" data-date="${ymd}" ${disabled}>${d}</div>`;
  }

  elMonthCalGrid.innerHTML = html;

  elMonthCalGrid.querySelectorAll(".day-cell[data-date]").forEach(cell=>{
    cell.addEventListener("click", ()=>{
      const ymd = cell.getAttribute("data-date");
      if (!ymd) return;
      if (ymd > todayYmd()) return; // 未来不可点
      // 点击日历 -> 切换编辑日
      setSelectedDate(ymd);
    });
  });
}

/***********************
 * 每日列表（红=曾修改）
 ***********************/
function renderDailyList(){
  if (!elDailyList || !window.bookData) return;
  const md = ensureMonth(window.bookData, selectedYm);
  const days = Object.keys(md.days || {}).filter(k=>k.startsWith(selectedYm+"-"));
  days.sort();

  if (days.length === 0){
    elDailyList.innerHTML = `<div class="muted">${t("no_records")}</div>`;
    return;
  }

  const currency = window.bookData.currency || "CAD";
  const fmt = (n)=> `${n.toFixed(2)} ${currency}`;

  let html = "";
  for (const ymd of days){
    const r = normalizeRecord(md.days[ymd]);
    const cls = r.edited ? "list-item edited" : "list-item";
    const tags = (r.tags || []).join(", ");
    html += `
      <div class="${cls}" data-jump="${ymd}">
        <div class="li-left">
          <div class="li-date">${ymd}</div>
          <div class="li-tags">${tags || ""}</div>
        </div>
        <div class="li-right">${fmt(r.total)}</div>
      </div>
    `;
  }
  elDailyList.innerHTML = html;

  elDailyList.querySelectorAll("[data-jump]").forEach(row=>{
    row.addEventListener("click", ()=>{
      const ymd = row.getAttribute("data-jump");
      if (!ymd) return;
      setSelectedDate(ymd);
    });
  });
}

function renderStatsAndList(){
  renderTopLines();
  renderEditLine();
  renderMonthCalendar();
  renderDailyList();
}

/***********************
 * 标签 UI
 ***********************/
const TAG_KEYS = [
  ["tag_parking","parking"],
  ["tag_grocery","grocery"],
  ["tag_dining","dining"],
  ["tag_gift","gift"],
  ["tag_transport","transport"],
  ["tag_household","household"],
  ["tag_bills","bills"],
  ["tag_medical","medical"],
  ["tag_entertainment","entertainment"],
  ["tag_other","other"],
];

function renderTags(selected){
  if (!elTagsWrap) return;
  const set = new Set(selected || []);
  let html = "";
  for (const [labelKey, value] of TAG_KEYS){
    const on = set.has(value);
    html += `<button type="button" class="tag-btn ${on ? "on":""}" data-tag="${value}">${t(labelKey)}</button>`;
  }
  elTagsWrap.innerHTML = html;

  elTagsWrap.querySelectorAll(".tag-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const tag = btn.getAttribute("data-tag");
      if (!tag) return;
      const cur = new Set(draft.tags || getCurrentDayRecord().tags || []);
      if (cur.has(tag)) cur.delete(tag); else cur.add(tag);
      draft.tags = Array.from(cur);
      btn.classList.toggle("on");
      markDirty();
    });
  });
}

/***********************
 * 取当前日记录
 ***********************/
function getCurrentDayRecord(){
  const md = ensureMonth(window.bookData, selectedYm);
  const r = md.days[selectedYmd] ? normalizeRecord(md.days[selectedYmd]) : null;
  return r || { total: 0, tags: [], edited: false, lastSaved: 0 };
}

/***********************
 * 设置选中日期/月份（供主日历与历史日历共用）
 ***********************/
function switchMonth(ym, ymdToSelect){
  // ym 必须 <= 当前月
  if (ym > currentYm()) return;
  selectedYm = ym;
  buildMonthList();
  renderStatsAndList();

  if (ymdToSelect) setSelectedDate(ymdToSelect);
}

function setSelectedDate(ymd){
  if (isFuture(ymd)) {
    alert(t("cannot_future_short"));
    return;
  }
  const ym = ymd.slice(0,7);
  if (ym !== selectedYm) {
    // 切换月份时同步刷新
    switchMonth(ym, ymd);
    return;
  }
  selectedYmd = ymd;
  // 同步 date input
  if (elEditDateInput) elEditDateInput.value = ymd;

  // 载入该日记录到输入框（但不写入 draft，避免假脏）
  const r = getCurrentDayRecord();
  if (elDayTotalInput) elDayTotalInput.value = (r.total || 0).toString();
  renderTags(r.tags);

  // 清空 draft
  draft.plan = null;
  draft.dayTotal = null;
  draft.tags = null;
  originalSnapshot = null;
  setConfirmEnabled(false);
  renderEditLine();
}

/***********************
 * 确认按钮控制：只有产生修改才可点
 ***********************/
function setConfirmEnabled(on){
  if (!elConfirmEditBtn) return;
  elConfirmEditBtn.disabled = !on;
  elConfirmEditBtn.classList.toggle("enabled", !!on);
}
function markDirty(){
  // 只要 draft 任一字段非 null，就视为有修改
  const dirty = (draft.plan !== null) || (draft.dayTotal !== null) || (draft.tags !== null);
  setConfirmEnabled(dirty);
}

/***********************
 * 计划/当日输入框事件
 ***********************/
function initInputs(){
  if (elPlanInput){
    elPlanInput.addEventListener("input", ()=>{
      const v = elPlanInput.value.trim();
      if (v === "") { draft.plan = null; markDirty(); return; }
      const n = Number(v);
      if (!Number.isFinite(n)) { draft.plan = null; markDirty(); return; }
      draft.plan = n;
      markDirty();
    });
  }

  if (elDayTotalInput){
    elDayTotalInput.addEventListener("input", ()=>{
      const v = elDayTotalInput.value.trim();
      if (v === "") { draft.dayTotal = null; markDirty(); return; }
      const n = Number(v);
      if (!Number.isFinite(n)) { draft.dayTotal = null; markDirty(); return; }
      draft.dayTotal = n;
      markDirty();
    });
  }

  if (elEditDateInput){
    elEditDateInput.addEventListener("change", ()=>{
      const ymd = elEditDateInput.value;
      if (!ymd) return;
      if (isFuture(ymd)) {
        alert(t("cannot_future"));
        elEditDateInput.value = selectedYmd;
        return;
      }
      setSelectedDate(ymd);
    });
  }

  if (elMonthSelect){
    elMonthSelect.addEventListener("change", ()=>{
      const ym = elMonthSelect.value;
      // 未来月不可
      if (ym > currentYm()) {
        alert(t("cannot_future_month"));
        elMonthSelect.value = selectedYm;
        return;
      }
      selectedYm = ym;
      // 选中月份后默认选当月最后一个可编辑日（或今天）
      const pick = (ym === currentYm()) ? todayYmd() : `${ym}-${String(daysInMonth(...ym.split("-").map(Number))).padStart(2,"0")}`;
      renderStatsAndList();
      setSelectedDate(pick);
    });
  }
}

/***********************
 * 保存/确认/取消/撤销
 ***********************/
function pushUndoSnapshot(){
  // 保存前快照
  undoStack.push(JSON.stringify(window.bookData));
  if (undoStack.length > 10) undoStack.shift();
  if (elUndoBtn) elUndoBtn.disabled = false;
}

function applyDraftAndSave(){
  const md = ensureMonth(window.bookData, selectedYm);

  // 保存前快照（撤销用）
  pushUndoSnapshot();

  // 计划
  if (draft.plan !== null){
    md.plan = draft.plan;
  }

  // 日记录
  const existing = md.days[selectedYmd] ? normalizeRecord(md.days[selectedYmd]) : null;
  const base = existing || { total: 0, tags: [], edited: false, lastSaved: 0 };

  const next = { ...base };

  if (draft.dayTotal !== null) next.total = draft.dayTotal;
  if (draft.tags !== null) next.tags = draft.tags;

  // 判断是否“修改过”：如果已有记录且本次确认导致值变化 -> edited=true
  // 新增记录（原来没有）不算“修改”，保持 edited=false
  if (existing){
    const changed = (draft.dayTotal !== null && draft.dayTotal !== base.total)
                 || (draft.tags !== null && JSON.stringify(draft.tags) !== JSON.stringify(base.tags));
    if (changed) next.edited = true;
  }

  // 如果今天/过去：允许保存；如果未来：禁止（已在前面挡住）
  next.lastSaved = Date.now();
  md.days[selectedYmd] = next;

  // 币种持久化
  window.bookData.currency = elCurrencySel ? elCurrencySel.value : (window.bookData.currency || "CAD");

  saveBookData(currentBook, window.bookData);

  // 清空 draft
  draft.plan = null;
  draft.dayTotal = null;
  draft.tags = null;
  setConfirmEnabled(false);

  // UI 刷新
  buildMonthList();
  renderStatsAndList();
  renderTaxCountdown?.();
  renderHistoryCalendar?.();

  // toast
  if (elSavedToast){
    elSavedToast.textContent = t("saved");
    elSavedToast.style.opacity = "1";
    setTimeout(()=>{ elSavedToast.style.opacity="0"; }, 900);
  }
}

function cancelDraft(){
  // 取消：恢复当前日记录到输入框（不保存）
  const md = ensureMonth(window.bookData, selectedYm);
  const r = md.days[selectedYmd] ? normalizeRecord(md.days[selectedYmd]) : { total:0, tags:[], edited:false };
  if (elDayTotalInput) elDayTotalInput.value = (r.total || 0).toString();
  renderTags(r.tags);
  // 计划输入框：显示 md.plan（但不作为 draft）
  if (elPlanInput){
    elPlanInput.value = (typeof md.plan === "number") ? String(md.plan) : "";
  }

  draft.plan = null;
  draft.dayTotal = null;
  draft.tags = null;
  setConfirmEnabled(false);
}

function undoLast(){
  if (undoStack.length === 0) return;
  const snap = undoStack.pop();
  window.bookData = safeJsonParse(snap, window.bookData);
  saveBookData(currentBook, window.bookData);

  if (undoStack.length === 0 && elUndoBtn) elUndoBtn.disabled = true;

  buildMonthList();
  renderStatsAndList();
  // 当前日输入也同步
  setSelectedDate(selectedYmd);
  renderTaxCountdown?.();
  renderHistoryCalendar?.();
}

function initActions(){
  if (elConfirmEditBtn) elConfirmEditBtn.addEventListener("click", applyDraftAndSave);
  if (elCancelEditBtn) elCancelEditBtn.addEventListener("click", cancelDraft);
  if (elSaveDayBtn) elSaveDayBtn.addEventListener("click", applyDraftAndSave);
  if (elUndoBtn) elUndoBtn.addEventListener("click", undoLast);
}

/***********************
 * 计算器（写回到 plan 或 dayTotal）
 * 第1段里需要有：calcMask/calcDisplay/calcBtns...等 id
 ***********************/
const calcMask = document.getElementById("calcMask");
const calcClose = document.getElementById("calcClose");
const calcDisplay = document.getElementById("calcDisplay");
const calcPad = document.getElementById("calcPad");
const calcOk = document.getElementById("calcOkBtn");
const calcCancel = document.getElementById("calcCancelBtn");
const calcWriteBack = document.getElementById("calcWriteBackBtn");
let calcTarget = null; // "plan" | "day"

function openCalc(target){
  calcTarget = target;
  if (!calcMask || !calcDisplay) return;
  calcDisplay.value = "";
  calcMask.style.display="flex";
  calcMask.setAttribute("aria-hidden","false");
}
function closeCalc(){
  if (!calcMask) return;
  calcMask.style.display="none";
  calcMask.setAttribute("aria-hidden","true");
}
function evalExpr(expr){
  // 只允许数字与 + - * / . ( ) 空格
  if (!/^[0-9+\-*/().\s]+$/.test(expr)) return null;
  try{
    // eslint-disable-next-line no-new-func
    const v = Function(`"use strict"; return (${expr});`)();
    if (!Number.isFinite(v)) return null;
    return v;
  }catch(e){ return null; }
}
function initCalc(){
  if (!calcMask || !calcPad || !calcOk || !calcCancel || !calcWriteBack || !calcClose || !calcDisplay) return;

  calcClose.addEventListener("click", closeCalc);
  calcCancel.addEventListener("click", closeCalc);
  calcMask.addEventListener("click",(e)=>{ if(e.target===calcMask) closeCalc(); });

  calcPad.addEventListener("click",(e)=>{
    const btn = e.target.closest("button");
    if (!btn) return;
    const v = btn.getAttribute("data-v");
    if (!v) return;
    if (v === "C"){ calcDisplay.value = ""; return; }
    if (v === "B"){ calcDisplay.value = calcDisplay.value.slice(0,-1); return; }
    calcDisplay.value += v;
  });

  function writeResult(){
    const expr = calcDisplay.value.trim();
    const val = evalExpr(expr);
    if (val === null){
      alert(t("expr_invalid_alert"));
      return null;
    }
    return val;
  }

  calcOk.addEventListener("click", ()=>{
    // 只校验，不写回
    const v = writeResult();
    if (v === null) return;
    closeCalc();
  });

  calcWriteBack.addEventListener("click", ()=>{
    const v = writeResult();
    if (v === null) return;

    if (calcTarget === "plan" && elPlanInput){
      elPlanInput.value = String(v);
      draft.plan = v;
      markDirty();
    }
    if (calcTarget === "day" && elDayTotalInput){
      elDayTotalInput.value = String(v);
      draft.dayTotal = v;
      markDirty();
    }
    closeCalc();
  });
}

/***********************
 * 删除账本：居中弹窗 + 10秒倒计时确认
 * 第1段里需要：delMask/delClose/delText/delConfirmBtn/delCancelBtn/delTimerText
 ***********************/
const delMask = document.getElementById("delMask");
const delClose = document.getElementById("delClose");
const delText = document.getElementById("delText");
const delConfirmBtn = document.getElementById("delConfirmBtn");
const delCancelBtn = document.getElementById("delCancelBtn");
const delTimerText = document.getElementById("delTimerText");

let delTimer = null;
let delRemain = 10;

function openDeleteModal(){
  if (!delMask || !delText || !delConfirmBtn || !delCancelBtn) return;

  delRemain = 10;
  delConfirmBtn.disabled = true;
  delConfirmBtn.textContent = t("delete_confirm_prefix",{n:delRemain});
  if (delText) delText.textContent = t("delete_text",{name: currentBook});
  if (delTimerText) delTimerText.textContent = t("delete_note");

  delMask.style.display="flex";
  delMask.setAttribute("aria-hidden","false");

  if (delTimer) clearInterval(delTimer);
  delTimer = setInterval(()=>{
    delRemain -= 1;
    if (delRemain <= 0){
      clearInterval(delTimer);
      delTimer = null;
      delConfirmBtn.disabled = false;
      delConfirmBtn.textContent = t("delete_confirm_ready");
    } else {
      delConfirmBtn.textContent = t("delete_confirm_prefix",{n:delRemain});
    }
  }, 1000);
}
function closeDeleteModal(){
  if (!delMask) return;
  delMask.style.display="none";
  delMask.setAttribute("aria-hidden","true");
  if (delTimer) { clearInterval(delTimer); delTimer=null; }
}
function deleteCurrentBook(){
  // 删除 localStorage 中该账本 key
  localStorage.removeItem(bookKey(currentBook));
  // 清除当前账本名
  localStorage.removeItem("budgetTool_currentBook");
  closeDeleteModal();
  // 回到进入界面（第1段里通常会有 gateMask）
  openGate?.();
}

function initDeleteBook(){
  if (!elBookDelBtn || !delMask || !delClose || !delConfirmBtn || !delCancelBtn) return;

  elBookDelBtn.addEventListener("click", openDeleteModal);
  delClose.addEventListener("click", closeDeleteModal);
  delCancelBtn.addEventListener("click", closeDeleteModal);
  delMask.addEventListener("click",(e)=>{ if(e.target===delMask) closeDeleteModal(); });
  delConfirmBtn.addEventListener("click", deleteCurrentBook);
}

/***********************
 * 新建/切换账本（Gate：第1段里 gateMask/gateInput/gateEnter/gateCancel）
 ***********************/
const gateMask = document.getElementById("gateMask");
const gateInput = document.getElementById("gateInput");
const gateEnter = document.getElementById("gateEnterBtn");
const gateCancel = document.getElementById("gateCancelBtn");

function openGate(){
  if (!gateMask || !gateInput) return;
  gateInput.value = "";
  gateMask.style.display="flex";
  gateMask.setAttribute("aria-hidden","false");
  gateInput.focus();
}
function closeGate(){
  if (!gateMask) return;
  gateMask.style.display="none";
  gateMask.setAttribute("aria-hidden","true");
}
function enterBook(){
  const name = (gateInput?.value || "").trim();
  if (!name){
    alert(t("input_book_name"));
    return;
  }
  setCurrentBookName(name);
  closeGate();
  bootForBook(name);
}

function initGate(){
  if (!elBookNewBtn) return;
  elBookNewBtn.addEventListener("click", openGate);

  if (gateEnter) gateEnter.addEventListener("click", enterBook);
  if (gateCancel) gateCancel.addEventListener("click", closeGate);

  if (gateInput){
    gateInput.addEventListener("keydown",(e)=>{
      if (e.key === "Enter") enterBook();
      if (e.key === "Escape") closeGate();
    });
  }
}

/***********************
 * 币种选择
 ***********************/
function initCurrency(){
  if (!elCurrencySel) return;
  elCurrencySel.addEventListener("change", ()=>{
    window.bookData.currency = elCurrencySel.value;
    saveBookData(currentBook, window.bookData);
    renderStatsAndList();
  });
}

/***********************
 * 启动：加载当前账本 or 进入 gate
 ***********************/
function bootForBook(name){
  currentBook = name;
  window.bookData = loadBookData(name);

  // UI 文案（i18n 已在第2段）
  if (elBookName) elBookName.textContent = name;

  // 初始币种
  if (elCurrencySel){
    elCurrencySel.value = window.bookData.currency || "CAD";
  }

  // 当前月/日
  selectedYm = currentYm();
  selectedYmd = todayYmd();

  // 月份列表
  buildMonthList();

  // plan 输入框初值
  const md = ensureMonth(window.bookData, selectedYm);
  if (elPlanInput){
    elPlanInput.value = (typeof md.plan === "number") ? String(md.plan) : "";
  }

  // 日期输入初值
  if (elEditDateInput) elEditDateInput.value = selectedYmd;

  // 当前日输入初值
  const r = getCurrentDayRecord();
  if (elDayTotalInput) elDayTotalInput.value = (r.total || 0).toString();
  renderTags(r.tags);

  // 统计/日历/列表
  renderStatsAndList();

  // 历史日历初始对齐
  histYm = selectedYm;

  // 关闭 gate
  closeGate();

  // 撤销按钮
  if (elUndoBtn) elUndoBtn.disabled = (undoStack.length === 0);

  // 税务倒计时刷新
  renderTaxCountdown?.();
}

function initPlanCalcBtn(){
  if (!elPlanCalcBtn) return;
  elPlanCalcBtn.addEventListener("click", ()=>openCalc("plan"));
}
function initDayCalcShortcut(){
  // 如果你第1段里给 dayTotal 旁边也放了计算器按钮，就绑定一下（可选）
  const btn = document.getElementById("dayCalcBtn");
  if (!btn) return;
  btn.addEventListener("click", ()=>openCalc("day"));
}

/***********************
 * 总入口：DOMContentLoaded
 ***********************/
document.addEventListener("DOMContentLoaded", ()=>{
  // 语言
  initI18n?.();

  // Gate & Book
  initGate();
  initDeleteBook();

  // 输入与动作
  initInputs();
  initActions();

  // 计算器
  initCalc();
  initPlanCalcBtn();
  initDayCalcShortcut();

  // 币种
  initCurrency();

  // 历史日历
  initHistoryCalendar?.();

  // 税务提醒
  initTaxReminder?.();

  // 进入：有当前账本则直接加载，否则打开 gate
  const bn = getCurrentBookName();
  if (bn){
    bootForBook(bn);
  } else {
    openGate();
  }

  // i18n 应用一次（确保按钮/文字都对齐）
  applyI18n?.();
});
