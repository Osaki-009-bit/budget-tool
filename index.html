<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>轻松记账（离线版）</title>
  <style>
    :root {
      --bg: #0b0c10;
      --card: #11131a;
      --card2: #0f1117;
      --text: #e9ecf1;
      --muted: #aab2c0;
      --line: rgba(255,255,255,.08);
      --danger: #ff5a7a;
      --ok: #37d67a;
      --warn: #ffcc66;
      --btn: #1b1f2b;
      --btn2: #232a3c;
      --focus: rgba(120,160,255,.35);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: var(--sans);
      background: radial-gradient(1200px 800px at 15% 10%, rgba(90,120,255,.18), transparent 45%),
                  radial-gradient(900px 700px at 85% 20%, rgba(80,255,180,.10), transparent 40%),
                  linear-gradient(180deg, #0b0c10, #07080c);
      color: var(--text);
    }
    .wrap { max-width: 980px; margin: 0 auto; padding: 18px 14px 36px; }
    header {
      display: flex; align-items: center; justify-content: space-between;
      gap: 12px; padding: 10px 6px 16px;
    }
    .title {
      display: flex; flex-direction: column; gap: 4px;
    }
    .title h1 { margin: 0; font-size: 18px; letter-spacing: .2px; }
    .title .sub { font-size: 12px; color: var(--muted); }
    .pill {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 8px 10px; border: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 999px;
      box-shadow: 0 1px 0 rgba(255,255,255,.03) inset;
      white-space: nowrap;
    }
    .pill b { font-weight: 650; }
    .grid {
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 14px;
    }
    @media (max-width: 900px) {
      .grid { grid-template-columns: 1fr; }
    }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .card .hd {
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--line);
      display: flex; align-items: baseline; justify-content: space-between; gap: 10px;
      background: rgba(0,0,0,.12);
    }
    .card .hd h2 { margin: 0; font-size: 14px; }
    .card .hd .hint { font-size: 12px; color: var(--muted); }
    .card .bd { padding: 14px; }
    .row { display: flex; gap: 10px; }
    .row > * { flex: 1; }
    label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    input, textarea, select {
      width: 100%;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline: none;
    }
    textarea { min-height: 74px; resize: vertical; }
    input:focus, textarea:focus, select:focus {
      border-color: rgba(120,160,255,.55);
      box-shadow: 0 0 0 4px var(--focus);
    }
    .btns { display: flex; gap: 10px; flex-wrap: wrap; }
    button {
      cursor: pointer;
      border: 1px solid var(--line);
      background: linear-gradient(180deg, var(--btn2), var(--btn));
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      transition: transform .03s ease, filter .15s ease;
      user-select: none;
    }
    button:active { transform: translateY(1px); }
    button.secondary { background: rgba(255,255,255,.03); }
    button.danger { border-color: rgba(255,90,122,.35); background: rgba(255,90,122,.10); }
    button.ok { border-color: rgba(55,214,122,.35); background: rgba(55,214,122,.10); }
    .kpi {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 520px) { .kpi { grid-template-columns: 1fr; } }
    .kpi .box {
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(0,0,0,.12);
    }
    .kpi .box .t { font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    .kpi .box .v { font-family: var(--mono); font-size: 16px; }
    .list {
      display: flex; flex-direction: column; gap: 10px;
    }
    .item {
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(0,0,0,.12);
      padding: 10px 12px;
      display: grid;
      grid-template-columns: 120px 1fr auto;
      gap: 10px;
      align-items: center;
    }
    @media (max-width: 520px) {
      .item { grid-template-columns: 1fr; }
      .item .right { justify-content: flex-start; }
    }
    .item .amt { font-family: var(--mono); font-size: 16px; }
    .item .note { color: var(--text); font-size: 13px; line-height: 1.35; }
    .item .meta { font-size: 12px; color: var(--muted); margin-top: 4px; }
    .item .right { display: flex; gap: 8px; justify-content: flex-end; }
    .empty {
      border: 1px dashed rgba(255,255,255,.16);
      border-radius: 14px;
      padding: 14px;
      color: var(--muted);
      background: rgba(0,0,0,.08);
    }
    .toast {
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      background: rgba(15,18,26,.95);
      border: 1px solid var(--line);
      padding: 10px 12px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      color: var(--text);
      font-size: 13px;
      display: none;
      max-width: 92vw;
    }
    .footer {
      margin-top: 14px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.5;
      padding: 0 6px;
    }
    .footer code { font-family: var(--mono); font-size: 12px; }
    .split {
      height: 1px;
      background: var(--line);
      margin: 12px 0;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>轻松记账（离线版）</h1>
        <div class="sub">不联网 · 单文件 · 数据只保存在本机浏览器</div>
      </div>
      <div class="pill" title="当前账户（本机隔离存储）">
        账户：<b id="who">-</b>
        <button class="secondary" id="switchUserBtn" style="padding:6px 10px;border-radius:999px;">切换</button>
      </div>
    </header>

    <div class="grid">
      <!-- 左侧：新增 -->
      <section class="card">
        <div class="hd">
          <h2>新增记录</h2>
          <div class="hint">填完点“保存”，立刻写入本机</div>
        </div>
        <div class="bd">
          <div class="row">
            <div>
              <label for="date">日期</label>
              <input id="date" type="date" />
            </div>
            <div>
              <label for="amount">金额（可正可负）</label>
              <input id="amount" type="text" inputmode="decimal" placeholder="例如：12.5 或 -8" />
            </div>
          </div>

          <div style="margin-top:10px;">
            <label for="note">备注</label>
            <textarea id="note" placeholder="例如：午饭 / 地铁 / 购物"></textarea>
          </div>

          <div class="btns" style="margin-top:12px;">
            <button class="ok" id="saveBtn">保存</button>
            <button class="secondary" id="clearBtn">清空输入</button>
          </div>

          <div class="split"></div>

          <div class="btns">
            <button id="exportBtn">导出备份（JSON）</button>
            <button id="importBtn">导入备份（JSON）</button>
            <input id="importFile" type="file" accept="application/json" style="display:none" />
          </div>

          <div class="split"></div>

          <div class="btns">
            <button class="danger" id="wipeDayBtn" title="只删除当前日期的记录">清空当天</button>
            <button class="danger" id="wipeAllBtn" title="删除该账户所有数据（不可恢复）">清空全部</button>
          </div>

          <div class="footer">
            隐私说明：本程序不联网，不上传。数据存储在浏览器 <code>localStorage</code> 中；换电脑/换浏览器会看不到原数据，建议定期“导出备份”。
          </div>
        </div>
      </section>

      <!-- 右侧：查看 -->
      <section class="card">
        <div class="hd">
          <h2>按日期查看</h2>
          <div class="hint">选择日期即可查看当天账目</div>
        </div>
        <div class="bd">
          <div class="row">
            <div>
              <label for="viewDate">查看日期</label>
              <input id="viewDate" type="date" />
            </div>
            <div>
              <label for="search">搜索备注（当日）</label>
              <input id="search" type="text" placeholder="输入关键词过滤" />
            </div>
          </div>

          <div class="kpi">
            <div class="box">
              <div class="t">当天条数</div>
              <div class="v" id="kCount">0</div>
            </div>
            <div class="box">
              <div class="t">当天合计</div>
              <div class="v" id="kSum">0.00</div>
            </div>
            <div class="box">
              <div class="t">本账户总条数</div>
              <div class="v" id="kAll">0</div>
            </div>
          </div>

          <div class="split"></div>

          <div class="list" id="list"></div>
        </div>
      </section>
    </div>

    <div class="toast" id="toast"></div>
  </div>

<script>
(() => {
  // ---------- Utilities ----------
  const $ = (id) => document.getElementById(id);
  const todayISO = () => {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  };
  const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);
  const toast = (msg) => {
    const t = $("toast");
    t.textContent = msg;
    t.style.display = "block";
    clearTimeout(toast._timer);
    toast._timer = setTimeout(() => (t.style.display = "none"), 1800);
  };
  const safeJSONParse = (s, fallback) => {
    try { return JSON.parse(s); } catch { return fallback; }
  };
  const formatMoney = (n) => {
    const x = Number(n);
    if (!Number.isFinite(x)) return "0.00";
    return x.toFixed(2);
  };
  const parseAmount = (raw) => {
    // 允许： 12 / 12.5 / -8 / +3.2 / 1,234.56
    const s = String(raw || "").trim().replace(/,/g, "");
    if (!s) return NaN;
    const n = Number(s);
    return Number.isFinite(n) ? n : NaN;
  };

  // ---------- Account isolation ----------
  const KEY_USER = "LJZ_OFFLINE_USER_V1";
  const KEY_DATA_PREFIX = "LJZ_OFFLINE_DATA_V1::"; // + username

  const getUser = () => localStorage.getItem(KEY_USER) || "";
  const setUser = (u) => localStorage.setItem(KEY_USER, u);

  const dataKey = (user) => KEY_DATA_PREFIX + user;

  const loadData = (user) => {
    const raw = localStorage.getItem(dataKey(user));
    const obj = safeJSONParse(raw, { entries: [] });
    if (!obj || !Array.isArray(obj.entries)) return { entries: [] };
    return obj;
  };

  const saveData = (user, obj) => {
    localStorage.setItem(dataKey(user), JSON.stringify(obj));
  };

  const ensureUser = () => {
    let u = getUser();
    while (!u) {
      u = prompt("请输入账户名称（用于隔离数据，例如：A / 妈妈 / 张三）。\n不联网，仅在本机使用。") || "";
      u = u.trim();
      if (!u) alert("账户名称不能为空。");
    }
    setUser(u);
    return u;
  };

  // ---------- State ----------
  let user = ensureUser();
  $("who").textContent = user;

  const initDates = () => {
    const t = todayISO();
    $("date").value = t;
    $("viewDate").value = t;
  };

  // ---------- Rendering ----------
  const render = () => {
    const d = loadData(user);
    const viewDate = $("viewDate").value || todayISO();
    const q = ($("search").value || "").trim().toLowerCase();

    const allEntries = d.entries.slice().sort((a, b) => (a.date > b.date ? -1 : 1));
    const dayEntries = allEntries.filter(e => e.date === viewDate)
      .filter(e => !q || (String(e.note || "").toLowerCase().includes(q)));

    // KPIs
    $("kAll").textContent = String(allEntries.length);
    $("kCount").textContent = String(dayEntries.length);
    const sum = dayEntries.reduce((acc, e) => acc + (Number(e.amount) || 0), 0);
    $("kSum").textContent = formatMoney(sum);

    // List
    const list = $("list");
    list.innerHTML = "";
    if (dayEntries.length === 0) {
      const div = document.createElement("div");
      div.className = "empty";
      div.textContent = q ? "当天没有匹配的记录。" : "当天暂无记录。";
      list.appendChild(div);
      return;
    }

    dayEntries.forEach(e => {
      const item = document.createElement("div");
      item.className = "item";

      const left = document.createElement("div");
      left.innerHTML = `
        <div class="amt">${formatMoney(e.amount)}</div>
        <div class="meta">${e.date}</div>
      `;

      const mid = document.createElement("div");
      const note = (e.note || "").trim() || "（无备注）";
      mid.innerHTML = `<div class="note"></div><div class="meta"></div>`;
      mid.querySelector(".note").textContent = note;
      mid.querySelector(".meta").textContent = `ID: ${e.id}`;

      const right = document.createElement("div");
      right.className = "right";

      const delBtn = document.createElement("button");
      delBtn.className = "danger";
      delBtn.textContent = "删除";
      delBtn.onclick = () => {
        const ok = confirm("确定删除这条记录吗？");
        if (!ok) return;
        const cur = loadData(user);
        cur.entries = cur.entries.filter(x => x.id !== e.id);
        saveData(user, cur);
        toast("已删除");
        render();
      };

      right.appendChild(delBtn);

      item.appendChild(left);
      item.appendChild(mid);
      item.appendChild(right);

      list.appendChild(item);
    });
  };

  // ---------- Actions ----------
  const onSave = () => {
    const date = ($("date").value || "").trim();
    const amount = parseAmount($("amount").value);
    const note = ($("note").value || "").trim();

    if (!date) { toast("请选择日期"); return; }
    if (!Number.isFinite(amount)) { toast("金额格式不对"); return; }

    const cur = loadData(user);
    cur.entries.push({
      id: uid(),
      date,
      amount,
      note,
      createdAt: Date.now()
    });
    saveData(user, cur);

    // 同步查看日期到刚保存的日期
    $("viewDate").value = date;

    // 清理输入（保留日期，方便连续记账）
    $("amount").value = "";
    $("note").value = "";

    toast("已保存");
    render();
  };

  const onClearInput = () => {
    $("amount").value = "";
    $("note").value = "";
    toast("已清空输入");
  };

  const onSwitchUser = () => {
    let u = prompt("输入要切换到的账户名称（不存在则新建）。", user) || "";
    u = u.trim();
    if (!u) return;
    user = u;
    setUser(u);
    $("who").textContent = user;
    toast("已切换账户");
    render();
  };

  const onWipeDay = () => {
    const day = $("viewDate").value || todayISO();
    const ok = confirm(`确定清空 ${day} 的所有记录吗？（不可恢复）`);
    if (!ok) return;
    const cur = loadData(user);
    cur.entries = cur.entries.filter(e => e.date !== day);
    saveData(user, cur);
    toast("已清空当天");
    render();
  };

  const onWipeAll = () => {
    const ok = confirm(`确定清空账户「${user}」的全部数据吗？（不可恢复）`);
    if (!ok) return;
    saveData(user, { entries: [] });
    toast("已清空全部");
    render();
  };

  const onExport = () => {
    const cur = loadData(user);
    const payload = {
      app: "轻松记账（离线版）",
      version: 1,
      user,
      exportedAt: new Date().toISOString(),
      data: cur
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
    const a = document.createElement("a");
    const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g, "-");
    a.href = URL.createObjectURL(blob);
    a.download = `轻松记账_备份_${user}_${stamp}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    toast("已导出备份");
  };

  const onImportPick = () => $("importFile").click();

  const onImportFile = async (file) => {
    try {
      const text = await file.text();
      const payload = JSON.parse(text);

      // 兼容：允许直接导入 {entries:[]} 或 payload.data
      let imported = null;
      if (payload && payload.data && Array.isArray(payload.data.entries)) imported = payload.data;
      else if (payload && Array.isArray(payload.entries)) imported = payload;

      if (!imported) {
        alert("导入失败：文件格式不正确。");
        return;
      }

      const ok = confirm(
        "导入会把“当前账户”的数据与文件中的数据合并（不会覆盖）。\n确定继续吗？"
      );
      if (!ok) return;

      const cur = loadData(user);
      // 去重：按 id 去重
      const exist = new Set(cur.entries.map(e => e.id));
      const toAdd = imported.entries.filter(e => e && e.id && !exist.has(e.id));
      cur.entries = cur.entries.concat(toAdd);

      saveData(user, cur);
      toast(`已导入 ${toAdd.length} 条`);
      render();
    } catch (e) {
      alert("导入失败：无法读取该文件。");
    }
  };

  // ---------- Wire up ----------
  $("saveBtn").addEventListener("click", onSave);
  $("clearBtn").addEventListener("click", onClearInput);
  $("switchUserBtn").addEventListener("click", onSwitchUser);

  $("viewDate").addEventListener("change", render);
  $("search").addEventListener("input", render);

  $("wipeDayBtn").addEventListener("click", onWipeDay);
  $("wipeAllBtn").addEventListener("click", onWipeAll);

  $("exportBtn").addEventListener("click", onExport);
  $("importBtn").addEventListener("click", onImportPick);
  $("importFile").addEventListener("change", (e) => {
    const f = e.target.files && e.target.files[0];
    if (f) onImportFile(f);
    e.target.value = "";
  });

  // Enter to save (when focus in amount)
  $("amount").addEventListener("keydown", (e) => {
    if (e.key === "Enter") onSave();
  });

  // Init
  initDates();
  render();
})();
</script>
</body>
</html>
