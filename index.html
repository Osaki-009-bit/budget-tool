<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>轻记账｜客观统计工具</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#f6f7fb;}
    .wrap{max-width:680px;margin:0 auto;padding:16px;}
    .card{background:#fff;border-radius:16px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.06);}
    h1{font-size:18px;margin:0 0 6px;}
    .sub{color:#666;font-size:13px;margin:0 0 14px;line-height:1.5;}
    label{display:block;font-size:14px;margin:12px 0 6px;}
    input{width:100%;font-size:16px;padding:12px;border:1px solid #ddd;border-radius:12px;box-sizing:border-box;}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
    .btn{font-size:14px;padding:10px 12px;border:0;border-radius:12px;background:#eef0f7;cursor:pointer;}
    .btn-primary{background:#111;color:#fff;flex:1;min-width:160px;}
    .btn-mini{font-size:12px;padding:6px 10px;border-radius:10px;}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px;}
    .chip{padding:8px 10px;border-radius:999px;border:1px solid #ddd;background:#fff;font-size:13px;cursor:pointer;}
    .chip.on{background:#111;color:#fff;border-color:#111;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px;}
    .box{background:#fafbff;border:1px solid #eef0ff;border-radius:12px;padding:10px;}
    .k{color:#666;font-size:13px;}
    .v{font-size:18px;font-weight:800;margin-top:2px;}
    details{margin-top:14px;}
    summary{cursor:pointer;font-size:14px;}
    .muted{color:#666;font-size:13px;line-height:1.5;margin-top:12px;}

    /* 保存提示：有未确认修改时，按钮变色提示 */
    .btn-primary.dirty{ background:#c62828 !important; }   /* 红：请保存 */
    .btn-primary.saved{ background:#2e7d32 !important; }   /* 绿：已保存 */

    /* ===== 计算器弹窗 ===== */
    .modal-mask{
      position:fixed; inset:0;
      background:rgba(0,0,0,.35);
      display:none; align-items:center; justify-content:center;
      padding:16px;
    }
    .modal{
      width:min(520px, 100%);
      background:#fff;
      border-radius:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.18);
      padding:14px;
    }
    .modal-hd{display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .modal-title{font-weight:800;}
    .modal-close{border:0;background:#eef0f7;border-radius:12px;padding:8px 10px;cursor:pointer;}
    .calc-screen{
      margin-top:10px;
      border:1px solid #ddd;
      border-radius:12px;
      padding:10px;
      background:#fafafa;
    }
    .calc-expr{font-size:14px; color:#666; min-height:18px; word-break:break-all;}
    .calc-val{font-size:22px; font-weight:900; margin-top:4px; min-height:28px;}
    .calc-grid{
      margin-top:10px;
      display:grid;
      grid-template-columns:repeat(4, 1fr);
      gap:8px;
    }
    .calc-btn{
      border:0; border-radius:12px;
      padding:14px 10px;
      background:#eef0f7;
      font-size:16px;
      cursor:pointer;
    }
    .calc-btn.op{background:#111;color:#fff;}
    .calc-btn.warn{background:#ffe9e9;}
    .calc-actions{display:flex; gap:10px; margin-top:10px;}
    .calc-actions .btn-primary{flex:1;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>轻记账（客观统计）</h1>
      <p class="sub" id="dateLine">本月：—</p>

      <label>本月计划花销总数（CAD）</label>
      <input id="planInput" type="number" inputmode="decimal" placeholder="例如 1000" />
      <div class="row">
        <button class="btn btn-mini" id="planEditBtn" type="button">修改（计算器）</button>
        <button class="btn btn-mini" id="planUndoBtn" type="button">撤销</button>
      </div>

      <label>编辑日期（回改某一天）</label>
      <input id="datePicker" type="date" />
      <div class="sub" id="pickerHint" style="margin:6px 0 0;">选择日期后，下方输入框会切换到该日期。</div>

      <label>当天花销总数（CAD）</label>
      <input id="dayInput" type="number" inputmode="decimal" placeholder="例如 35" />
      <div class="sub" id="dayLine" style="margin:6px 0 0;">编辑：—</div>
      <div class="row">
        <button class="btn btn-mini" id="dayEditBtn" type="button">修改（计算器）</button>
        <button class="btn btn-mini" id="dayUndoBtn" type="button">撤销</button>
      </div>

      <label>当日花销内容标签（可多选）</label>
      <div class="chips">
        <button class="chip" type="button">停车费</button>
        <button class="chip" type="button">超市购物</button>
        <button class="chip" type="button">外出吃饭</button>
        <button class="chip" type="button">礼物</button>
        <button class="chip" type="button">油费/交通</button>
        <button class="chip" type="button">生活用品</button>
        <button class="chip" type="button">账单/订阅</button>
        <button class="chip" type="button">医疗/药品</button>
        <button class="chip" type="button">娱乐/休闲</button>
        <button class="chip" type="button">其他</button>
      </div>

      <div class="row" style="margin-top:12px;">
        <button class="btn btn-primary" id="recordBtn" type="button">保存这天</button>
      </div>

      <div class="grid">
        <div class="box"><div class="k">截至目前已花</div><div class="v" id="spentVal">—</div></div>
        <div class="box"><div class="k">日均实际（S ÷ d）</div><div class="v" id="avgVal">—</div></div>
        <div class="box"><div class="k">本月剩余</div><div class="v" id="balanceVal">—</div></div>
        <div class="box"><div class="k">为不超支：从明天起后续日均需 ≤</div><div class="v" id="needVal">—</div></div>
      </div>

      <details>
        <summary>本月每日列表（将来展开显示每天金额 + 标签）</summary>
        <div class="muted" id="monthList">（暂无记录）</div>
      </details>

      <details>
        <summary>历史月份（将来展开回看）</summary>
        <div class="muted">这里后面会列出历史月份列表。</div>
      </details>

      <p class="muted">说明：当前版本以“日期”为唯一基准：选中哪一天，就编辑哪一天；清零也会被统计进天数（金额=0）。</p>
    </div>
  </div>

  <!-- ===== 计算器弹窗 ===== -->
  <div class="modal-mask" id="calcMask" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="calcTitle">
      <div class="modal-hd">
        <div class="modal-title" id="calcTitle">计算器修改</div>
        <button class="modal-close" id="calcClose" type="button">关闭</button>
      </div>

      <div class="calc-screen">
        <div class="calc-expr" id="calcExpr">—</div>
        <div class="calc-val" id="calcVal">—</div>
      </div>

      <div class="calc-grid">
        <button class="calc-btn warn" data-k="C" type="button">清零</button>
        <button class="calc-btn warn" data-k="BS" type="button">退格</button>
        <button class="calc-btn op" data-k="/" type="button">÷</button>
        <button class="calc-btn op" data-k="*" type="button">×</button>

        <button class="calc-btn" data-k="7" type="button">7</button>
        <button class="calc-btn" data-k="8" type="button">8</button>
        <button class="calc-btn" data-k="9" type="button">9</button>
        <button class="calc-btn op" data-k="-" type="button">−</button>

        <button class="calc-btn" data-k="4" type="button">4</button>
        <button class="calc-btn" data-k="5" type="button">5</button>
        <button class="calc-btn" data-k="6" type="button">6</button>
        <button class="calc-btn op" data-k="+" type="button">+</button>

        <button class="calc-btn" data-k="1" type="button">1</button>
        <button class="calc-btn" data-k="2" type="button">2</button>
        <button class="calc-btn" data-k="3" type="button">3</button>
        <button class="calc-btn" data-k="." type="button">.</button>

        <button class="calc-btn" data-k="0" type="button">0</button>
        <button class="calc-btn" data-k="00" type="button">00</button>
        <button class="calc-btn op" data-k="=" type="button">=</button>
        <button class="calc-btn op" id="calcOk" type="button">确认</button>
      </div>

      <div class="calc-actions">
        <button class="btn" id="calcCancel" type="button">取消</button>
        <button class="btn btn-primary" id="calcUse" type="button">把结果写回</button>
      </div>
    </div>
  </div>

  <script>
  // ====== 日期工具：避免时区问题（不要直接 new Date('YYYY-MM-DD')）======
  const weekMap = ['周日','周一','周二','周三','周四','周五','周六'];
  function parseYmd(ymdStr){
    const [y,m,d] = ymdStr.split('-').map(Number);
    return new Date(y, (m||1)-1, d||1);
  }
  function weekdayOf(ymdStr){
    const dt = parseYmd(ymdStr);
    return weekMap[dt.getDay()];
  }
  function pad2(n){ return String(n).padStart(2,'0'); }

  // ====== 今日 / 本月信息 ======
  const now = new Date();
  const Y = now.getFullYear();
  const M = pad2(now.getMonth() + 1);
  const D = pad2(now.getDate());
  const ym = `${Y}-${M}`;
  const todayYmd = `${Y}-${M}-${D}`;
  const daysInMonth = new Date(Y, now.getMonth() + 1, 0).getDate(); // 本月天数
  const dayIndex = now.getDate(); // 今天是本月第几天（1..D）

  // ====== 本地存储结构 ======
  const STORAGE_KEY = 'budgetTool:v2';
  function loadAll(){
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); }
    catch { return {}; }
  }
  function saveAll(all){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(all));
  }
  function ensureMonth(all, ym){
    all.months = all.months || {};
    if (!all.months[ym]) {
      all.months[ym] = {
        plan: null,
        days: {},                 // { 'YYYY-MM-DD': { total: number, tags: string[] } }
        undo: { plan: [], day: [] },  // day: [{date, prevTotal, prevTags}]
        startFrom: null,          // 用于屏蔽“更早的测试数据”
        started: false
      };
    } else {
      // 兼容旧字段
      all.months[ym].undo = all.months[ym].undo || { plan: [], day: [] };
      all.months[ym].undo.plan = all.months[ym].undo.plan || [];
      all.months[ym].undo.day = all.months[ym].undo.day || [];
      all.months[ym].startFrom = all.months[ym].startFrom || null;
      all.months[ym].started = all.months[ym].started || false;
    }
    return all.months[ym];
  }

  const all = loadAll();
  const monthData = ensureMonth(all, ym);

  // 本月未开始时：默认从今天起统计（防止旧测试数据突然冒出来）
  if (!monthData.started && (!monthData.startFrom || !String(monthData.startFrom).startsWith(ym + '-'))) {
    monthData.startFrom = todayYmd;
    saveAll(all);
  }

  // ====== DOM 获取 ======
  const dateLine = document.getElementById('dateLine');
  const datePicker = document.getElementById('datePicker');
  const dayLine = document.getElementById('dayLine');

  const planInput = document.getElementById('planInput');
  const dayInput = document.getElementById('dayInput');

  const planUndoBtn = document.getElementById('planUndoBtn');
  const dayUndoBtn = document.getElementById('dayUndoBtn');
  const recordBtn = document.getElementById('recordBtn');

  const spentVal = document.getElementById('spentVal');
  const avgVal = document.getElementById('avgVal');
  const balanceVal = document.getElementById('balanceVal');
  const needVal = document.getElementById('needVal');

  const monthList = document.getElementById('monthList');
  const chipButtons = Array.from(document.querySelectorAll('.chip'));

  // ====== 保存按钮提示状态 ======
  let saveState = 'idle'; // idle | dirty | saved
  let savedToastTimer = null;

  function setSaveState(state){
    saveState = state;

    if (savedToastTimer) { clearTimeout(savedToastTimer); savedToastTimer = null; }

    recordBtn.classList.remove('dirty','saved');

    if (state === 'dirty') {
      recordBtn.classList.add('dirty');
      recordBtn.textContent = '请保存';
    } else if (state === 'saved') {
      recordBtn.classList.add('saved');
      recordBtn.textContent = '已保存';
      savedToastTimer = setTimeout(()=>{
        recordBtn.classList.remove('saved');
        recordBtn.textContent = '保存这天';
        saveState = 'idle';
      }, 1200);
    } else {
      recordBtn.textContent = '保存这天';
    }
  }
  function markDirty(){ if (saveState !== 'dirty') setSaveState('dirty'); }
  function markSaved(){ setSaveState('saved'); }

  // ====== 工具函数 ======
  const fmt = (n) => {
    if (n === null || n === undefined || Number.isNaN(n)) return '—';
    const v = Math.round(n * 100) / 100;
    return `${v.toFixed(2)} CAD`;
  };

  function getDayRecord(dateStr){
    return monthData.days[dateStr] || { total: null, tags: [] };
  }

  function getSelectedTags(){
    return chipButtons
      .filter(b => b.classList.contains('on'))
      .map(b => b.textContent.trim());
  }
  function setSelectedTags(tags){
    const set = new Set(tags || []);
    chipButtons.forEach(b => b.classList.toggle('on', set.has(b.textContent.trim())));
  }

  // ====== 编辑日期状态 ======
  let editYmd = todayYmd;

  function renderTopLines(){
    if (dateLine) dateLine.textContent = `本月：${ym}`;
  }

  function renderEditLine(){
    const w = weekdayOf(editYmd);
    dayLine.textContent = `编辑：${editYmd}（${w}）`;
  }

  function switchEditDate(newYmd){
    // 切换前：若有未保存改动，先强制落盘
    flushSaveNow();

    // 仅允许编辑本月（后面做历史月份时再放开）
    if (!newYmd || !String(newYmd).startsWith(ym + '-')) {
      alert('当前版本只支持编辑本月日期。');
      datePicker.value = editYmd;
      return;
    }

    editYmd = newYmd;

    // 恢复该日期数据到输入框与标签
    const rec = getDayRecord(editYmd);
    dayInput.value = (rec.total ?? '') === null ? '' : (rec.total ?? '');
    setSelectedTags(rec.tags || []);

    renderEditLine();
    renderStatsAndList();
    setSaveState('idle');
  }

  // ====== 统计计算：只统计 startFrom（开始日）及今天（<= todayYmd） ======
  function calcSpentAndRecordedDaysUpToToday(){
    let sum = 0;
    let days = 0;
    const start = monthData.startFrom || `${ym}-01`;

    for (const [dateStr, rec] of Object.entries(monthData.days)) {
      if (!dateStr.startsWith(ym + '-')) continue;
      if (dateStr < start) continue;      // 屏蔽更早测试数据
      if (dateStr > todayYmd) continue;   // “截至目前”只算到今天
      if (rec && typeof rec.total === 'number') {
        sum += rec.total;
        days += 1; // 注意：0 也是 number，会被计入天数（清零也算一天）
      }
    }
    return { sum, days };
  }

  function setBalanceDisplay(balance){
    if (balance === null) {
      balanceVal.textContent = '—';
      balanceVal.style.color = '#111';
      return;
    }
    const abs = Math.abs(balance);
    if (balance > 0) {
      balanceVal.textContent = `${abs.toFixed(2)} CAD  剩余`;
      balanceVal.style.color = '#2e7d32';
    } else if (balance < 0) {
      balanceVal.textContent = `${abs.toFixed(2)} CAD  超支`;
      balanceVal.style.color = '#c62828';
    } else {
      balanceVal.textContent = `0.00 CAD  平衡`;
      balanceVal.style.color = '#111';
    }
  }

  function renderStatsAndList(){
    const P = (typeof monthData.plan === 'number') ? monthData.plan : null;

    const { sum: S, days: d } = calcSpentAndRecordedDaysUpToToday();
    const A = (d > 0) ? (S / d) : null;

    const B = (P === null) ? null : (P - S);

    const remainingDays = daysInMonth - dayIndex;
    const R = (P === null || remainingDays <= 0) ? null : Math.max(0, (P - S) / remainingDays);

    spentVal.textContent = fmt(S);
    avgVal.textContent = fmt(A);
    setBalanceDisplay(B);
    needVal.textContent = (R === null) ? '—' : fmt(R);

    const keys = Object.keys(monthData.days).filter(k => k.startsWith(ym+'-')).sort();
    if (!keys.length) {
      monthList.textContent = '（暂无记录）';
      return;
    }
    const rows = keys.map(k => {
      const rec = monthData.days[k];
      const money = (typeof rec.total === 'number') ? `${rec.total.toFixed(2)} CAD` : '—';
      const tags = (rec.tags && rec.tags.length) ? rec.tags.join(' / ') : '（无标签）';
      return `<div style="padding:6px 0;border-bottom:1px dashed #eee;">
                <strong>${k}</strong> ｜ ${money}<br/>
                <span style="color:#666;font-size:13px;">${tags}</span>
              </div>`;
    }).join('');
    monthList.innerHTML = rows;
  }

  // ====== 写入与撤销 ======
  function commitPlan(newVal){
    const prev = monthData.plan;
    monthData.undo.plan.push(prev);
    if (monthData.undo.plan.length > 30) monthData.undo.plan.shift();

    monthData.plan = newVal;

    saveAll(all);
    renderStatsAndList();
  }

  function commitDay(dateStr, newTotal, newTags){
    const existing = monthData.days[dateStr] || { total: null, tags: [] };

    // undo：按日期保存上一次状态
    monthData.undo.day.push({
      date: dateStr,
      prevTotal: (typeof existing.total === 'number') ? existing.total : null,
      prevTags: Array.isArray(existing.tags) ? existing.tags.slice() : []
    });
    if (monthData.undo.day.length > 80) monthData.undo.day.shift();

    const rec = { total: newTotal, tags: Array.isArray(newTags) ? newTags.slice() : [] };
    monthData.days[dateStr] = rec;

    // 本月开始与开始日：第一次写入即开始；开始日取“最早写入日期”
    monthData.started = true;
    if (!monthData.startFrom || dateStr < monthData.startFrom) monthData.startFrom = dateStr;

    saveAll(all);
    renderStatsAndList();
    markSaved();
  }

  function popUndoForDate(dateStr){
    for (let i = monthData.undo.day.length - 1; i >= 0; i--) {
      if (monthData.undo.day[i].date === dateStr) {
        return monthData.undo.day.splice(i, 1)[0];
      }
    }
    return null;
  }

  // ====== 防抖 ======
  function debounce(fn, wait=300){
    let t = null;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), wait);
    };
  }

  const savePlanDebounced = debounce((n) => commitPlan(n), 300);
  const saveDayDebounced = debounce((dateStr, n, tags) => commitDay(dateStr, n, tags), 300);

  planInput.addEventListener('input', () => {
    const v = planInput.value.trim();
    const n = v === '' ? null : Number(v);
    if (v !== '' && Number.isNaN(n)) return;
    savePlanDebounced(n);
  });

  dayInput.addEventListener('input', () => {
    const v = dayInput.value.trim();
    const n = v === '' ? null : Number(v);
    if (v !== '' && Number.isNaN(n)) return;

    markDirty();
    // 自动保存：金额改动后 300ms 落盘
    saveDayDebounced(editYmd, n, getSelectedTags());
  });

  // 标签点亮：同步保存到“当前编辑日期”
  chipButtons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      btn.classList.toggle('on');
      markDirty();

      const rec = getDayRecord(editYmd);
      const currentTotal = (typeof rec.total === 'number') ? rec.total : null;
      saveDayDebounced(editYmd, currentTotal, getSelectedTags());
    });
  });

  // 保存按钮：明确落盘（覆盖当前编辑日期）
  recordBtn.addEventListener('click', ()=>{
    const v = dayInput.value.trim();
    const n = v === '' ? null : Number(v);
    if (v !== '' && Number.isNaN(n)) return;

    commitDay(editYmd, n, getSelectedTags());
  });

  // 撤销
  planUndoBtn.addEventListener('click', ()=>{
    if (!monthData.undo.plan.length) return;
    const prev = monthData.undo.plan.pop();
    monthData.plan = prev;
    planInput.value = (prev ?? '') === null ? '' : (prev ?? '');
    saveAll(all);
    renderStatsAndList();
  });

  dayUndoBtn.addEventListener('click', ()=>{
    const u = popUndoForDate(editYmd);
    if (!u) return;

    monthData.days[editYmd] = { total: u.prevTotal, tags: u.prevTags };
    saveAll(all);

    dayInput.value = (u.prevTotal ?? '') === null ? '' : (u.prevTotal ?? '');
    setSelectedTags(u.prevTags || []);
    renderStatsAndList();
    markSaved();
  });

  // 切后台/关闭页面时强制保存一次（避免用户“没点保存就走了”）
  function flushSaveNow(){
    if (saveState !== 'dirty') return;

    const v = dayInput.value.trim();
    const n = v === '' ? null : Number(v);
    if (v !== '' && Number.isNaN(n)) return;

    commitDay(editYmd, n, getSelectedTags());
  }
  window.addEventListener('pagehide', flushSaveNow);
  document.addEventListener('visibilitychange', ()=> { if (document.hidden) flushSaveNow(); });

  // ====== 日期选择器：切换编辑日期 ======
  datePicker.addEventListener('change', ()=>{
    const picked = datePicker.value;
    if (!picked) return;
    switchEditDate(picked);
  });

  // ====== 计算器弹窗：用于“修改（计算器）” ======
  const calcMask = document.getElementById('calcMask');
  const calcClose = document.getElementById('calcClose');
  const calcCancel = document.getElementById('calcCancel');
  const calcUse = document.getElementById('calcUse');
  const calcOk = document.getElementById('calcOk');
  const calcExprEl = document.getElementById('calcExpr');
  const calcValEl = document.getElementById('calcVal');

  let calcTarget = null;   // 'plan' | 'day'
  let expr = '';
  let lastValue = null;

  function showCalc(target){
    calcTarget = target;
    const base = target === 'plan'
      ? (planInput.value.trim() || (typeof monthData.plan === 'number' ? String(monthData.plan) : ''))
      : (dayInput.value.trim() || (getDayRecord(editYmd).total != null ? String(getDayRecord(editYmd).total) : ''));

    expr = (base === '' ? '0' : base);
    renderCalc();
    calcMask.style.display = 'flex';
    calcMask.setAttribute('aria-hidden', 'false');
  }

  function hideCalc(){
    calcMask.style.display = 'none';
    calcMask.setAttribute('aria-hidden', 'true');
    calcTarget = null;
  }

  function safeEval(s){
    const ok = /^[0-9+\-*/().\s]+$/.test(s);
    if (!ok) return null;
    try {
      const out = Function(`"use strict"; return (${s});`)();
      if (typeof out !== 'number' || !isFinite(out)) return null;
      return Math.round(out * 100) / 100;
    } catch {
      return null;
    }
  }

  function renderCalc(){
    calcExprEl.textContent = expr;
    const v = safeEval(expr);
    lastValue = v;
    calcValEl.textContent = (v === null) ? '表达式无效' : `${v.toFixed(2)} CAD`;
  }

  function appendKey(k){
    if (k === 'C') { expr = '0'; renderCalc(); return; }
    if (k === 'BS') { expr = expr.length <= 1 ? '0' : expr.slice(0, -1); renderCalc(); return; }
    if (k === '=') { renderCalc(); return; }

    if (expr === '0' && /^[0-9]$/.test(k)) expr = k;
    else expr += k;
    renderCalc();
  }

  calcMask.addEventListener('click', (e)=>{ if (e.target === calcMask) hideCalc(); });
  calcClose.addEventListener('click', hideCalc);
  calcCancel.addEventListener('click', hideCalc);

  document.querySelectorAll('.calc-btn[data-k]').forEach(btn=>{
    btn.addEventListener('click', ()=> appendKey(btn.dataset.k));
  });

  function applyCalcResult(){
    if (lastValue === null) { alert('表达式无效，请修改后再确认'); return; }

    if (calcTarget === 'plan') {
      planInput.value = String(lastValue);
      commitPlan(lastValue);
    } else if (calcTarget === 'day') {
      dayInput.value = String(lastValue);
      markDirty();
      commitDay(editYmd, lastValue, getSelectedTags());
    }
    hideCalc();
  }

  calcOk.addEventListener('click', applyCalcResult);
  calcUse.addEventListener('click', applyCalcResult);

  document.getElementById('planEditBtn').addEventListener('click', ()=> showCalc('plan'));
  document.getElementById('dayEditBtn').addEventListener('click', ()=> showCalc('day'));

  // ====== 首次加载：恢复 UI ======
  function hydrateUI(){
    renderTopLines();

    planInput.value = (monthData.plan ?? '') === null ? '' : (monthData.plan ?? '');

    // 初始化日期选择器为今天（可随时切换）
    editYmd = todayYmd;
    datePicker.value = editYmd;

    const rec = getDayRecord(editYmd);
    dayInput.value = (rec.total ?? '') === null ? '' : (rec.total ?? '');
    setSelectedTags(rec.tags || []);

    renderEditLine();
    renderStatsAndList();
    setSaveState('idle');
  }

  hydrateUI();
  </script>
</body>
</html>
