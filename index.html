<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>轻记账｜客观统计工具</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#f6f7fb;}
    .wrap{max-width:980px;margin:0 auto;padding:16px;}
    .layout{display:flex;gap:12px;align-items:flex-start;}
    .sidebar{
      width:170px;flex:0 0 170px;
      position:sticky;top:12px;
      background:#fff;border-radius:16px;padding:12px;
      box-shadow:0 6px 18px rgba(0,0,0,.06);
    }
    .side-title{font-weight:800;font-size:14px;margin:2px 0 10px;}
    .month-nav{display:flex;flex-direction:column;gap:6px;}
    .month-item{
      border:1px solid #e6e6e6;background:#fff;border-radius:12px;
      padding:10px 10px;cursor:pointer;text-align:left;
      display:flex;justify-content:space-between;align-items:center;gap:8px;
      font-size:14px;
    }
    .month-item small{color:#666;font-size:12px;}
    .month-item.active{border-color:#111;background:#111;color:#fff;}
    .month-item.active small{color:#ddd;}
    .main{flex:1;min-width:0;}

    .card{background:#fff;border-radius:16px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.06); position:relative;}
    h1{font-size:18px;margin:0 0 6px;}
    .sub{color:#666;font-size:13px;margin:0 0 14px;line-height:1.5;}
    label{display:block;font-size:14px;margin:12px 0 6px;}
    input,select{width:100%;font-size:16px;padding:12px;border:1px solid #ddd;border-radius:12px;box-sizing:border-box;background:#fff;}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
    .btn{font-size:14px;padding:10px 12px;border:0;border-radius:12px;background:#eef0f7;cursor:pointer;}
    .btn-primary{background:#111;color:#fff;flex:1;min-width:160px;}
    .btn-danger{background:#c62828;color:#fff;}
    .btn-mini{font-size:12px;padding:6px 10px;border-radius:10px;}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px;}
    .chip{padding:8px 10px;border-radius:999px;border:1px solid #ddd;background:#fff;font-size:13px;cursor:pointer;}
    .chip.on{background:#111;color:#fff;border-color:#111;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px;}
    .box{background:#fafbff;border:1px solid #eef0ff;border-radius:12px;padding:10px;}
    .k{color:#666;font-size:13px;}
    .v{font-size:18px;font-weight:800;margin-top:2px;}
    details{margin-top:14px;}
    summary{cursor:pointer;font-size:14px;}
    .muted{color:#666;font-size:13px;line-height:1.5;margin-top:12px;}

    /* 保存提示 */
    .btn-primary.dirty{ background:#c62828 !important; }   /* 红：请保存 */
    .btn-primary.saved{ background:#2e7d32 !important; }   /* 绿：已保存 */

    /* 日期输入框标红：曾修改过 */
    #datePicker.edited{ color:#c62828; border-color:#c62828; font-weight:700; }

    /* 顶部锁定按钮 */
    .lockbar{position:absolute; right:12px; top:12px; display:flex; gap:8px;}
    .lockbar .btn{padding:8px 10px; font-size:12px; border-radius:10px;}

    /* 计算器弹窗 */
    .modal-mask{
      position:fixed; inset:0;
      background:rgba(0,0,0,.35);
      display:none; align-items:center; justify-content:center;
      padding:16px;
      z-index:20;
    }
    .modal{
      width:min(520px, 100%);
      background:#fff;
      border-radius:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.18);
      padding:14px;
    }
    .modal-hd{display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .modal-title{font-weight:800;}
    .modal-close{border:0;background:#eef0f7;border-radius:12px;padding:8px 10px;cursor:pointer;}
    .calc-screen{
      margin-top:10px;
      border:1px solid #ddd;
      border-radius:12px;
      padding:10px;
      background:#fafafa;
    }
    .calc-expr{font-size:14px; color:#666; min-height:18px; word-break:break-all;}
    .calc-val{font-size:22px; font-weight:900; margin-top:4px; min-height:28px;}
    .calc-grid{
      margin-top:10px;
      display:grid;
      grid-template-columns:repeat(4, 1fr);
      gap:8px;
    }
    .calc-btn{
      border:0; border-radius:12px;
      padding:14px 10px;
      background:#eef0f7;
      font-size:16px;
      cursor:pointer;
    }
    .calc-btn.op{background:#111;color:#fff;}
    .calc-btn.warn{background:#ffe9e9;}
    .calc-actions{display:flex; gap:10px; margin-top:10px;}
    .calc-actions .btn-primary{flex:1;}

    /* 手机端：侧边栏变成顶部横向月份条 */
    @media (max-width: 820px){
      .wrap{max-width:720px;}
      .layout{flex-direction:column;}
      .sidebar{width:100%;flex:0 0 auto;position:static;}
      .month-nav{flex-direction:row;overflow:auto;gap:8px;padding-bottom:2px;}
      .month-item{white-space:nowrap;min-width:140px;}
      .lockbar{position:static; justify-content:flex-end; margin:6px 0 10px;}
    }

    /* 登录/注册遮罩 */
    .auth-mask{
      position:fixed; inset:0;
      background:rgba(246,247,251,.98);
      display:flex; align-items:center; justify-content:center;
      padding:16px;
      z-index:30;
    }
    .auth-card{
      width:min(520px, 100%);
      background:#fff;
      border-radius:18px;
      box-shadow:0 12px 36px rgba(0,0,0,.12);
      padding:16px;
    }
    .auth-title{font-size:18px;font-weight:900;margin:0 0 8px;}
    .auth-sub{color:#666;font-size:13px;line-height:1.5;margin:0 0 12px;}
    .auth-row{display:flex;gap:10px;flex-wrap:wrap;}
    .auth-row .btn{flex:1;min-width:160px;}
    .auth-warn{color:#c62828;font-size:13px;line-height:1.5;margin-top:10px;}
    .auth-ok{color:#2e7d32;font-size:13px;line-height:1.5;margin-top:10px;}
    .auth-small{color:#666;font-size:12px;line-height:1.5;margin-top:10px;}
  
    /* ===== 自定义日历（用于标色：灰/绿/红）===== */
    .cal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:flex-end;justify-content:center;padding:18px;z-index:9999;}
    .cal-overlay.hidden{display:none;}

    /* 日历：内嵌展开模式（替代遮罩弹窗） */
    .cal-overlay.cal-inline{position:static;inset:auto;background:transparent;align-items:stretch;justify-content:stretch;padding:0;z-index:auto;display:block;}
    .cal-overlay.cal-inline .cal{max-width:none;width:100%;box-shadow:none;border:1px solid #e6e6e6;}
    .cal-overlay.cal-inline #calClose{display:none;}

    .cal{background:#fff;border-radius:16px;max-width:520px;width:100%;box-shadow:0 12px 30px rgba(0,0,0,.18);padding:12px;}
    .cal-head{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:6px 4px;}
    .cal-title{font-size:14px;font-weight:800;}
    .cal-nav{display:flex;gap:8px;}
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;padding:10px 4px 6px;}
    .cal-wd{font-size:12px;color:#666;text-align:center;padding:4px 0;}
    .cal-day{border:1px solid #ddd;border-radius:12px;padding:10px 0;text-align:center;cursor:pointer;font-size:14px;background:#f3f3f3;}
    .cal-day.empty{background:transparent;border-color:transparent;cursor:default;}
    .cal-day.recorded{background:#e8f5e9;border-color:#2e7d32;}
    .cal-day.edited{background:#ffebee;border-color:#c62828;}
    .cal-day.selected{outline:2px solid #111;outline-offset:1px;}
    .cal-day.disabled{background:#f2f2f2;border-color:#e5e5e5;color:#bbb;cursor:not-allowed;}
    .cal-foot{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:8px 4px 4px;}
    .cal-legend{font-size:12px;color:#666;padding:0 4px 8px;line-height:1.5;}
    .datepick-row{display:flex;gap:10px;align-items:center;margin:6px 0 0;}
    .datepick-row .muted{margin:0;}
</style>
</head>

<body>
  <!-- 注册/登录遮罩（没有密码时=创建；有密码时=解锁） -->
  <div class="auth-mask" id="authMask" style="display:none;">
    <div class="auth-card">
      <div class="auth-title" id="authTitle">解锁账本</div>
      <p class="auth-sub" id="authSub">
        为了隐私，本账本数据会加密保存在本机浏览器里。没有任何上传、没有服务器。
      </p>

      <label id="authLabel">密码</label>
      <input id="authPass" type="password" placeholder="输入密码" autocomplete="current-password" />

      <div class="auth-row" style="margin-top:12px;">
        <button class="btn btn-primary" id="authPrimary" type="button">解锁</button>
        <button class="btn" id="authSecondary" type="button" style="display:none;">创建新账本</button>
      </div>


      <div class="auth-small">
        重要：请妥善保存密码；忘记后无法恢复旧数据（本地加密、无后台找回）。
      </div>
      <div class="auth-warn" id="authMsg" style="display:none;"></div>
      <div class="auth-ok" id="authOk" style="display:none;"></div>
    </div>
  </div>

  <div class="wrap" id="appRoot" style="visibility:hidden;">
    <div class="layout">

      <aside class="sidebar">
        <div class="side-title">月份</div>
        <div class="month-nav" id="monthNav"></div>
        <div class="muted" style="margin-top:10px;">
          点击月份可回看/修改该月数据。未来月份不可编辑。
        </div>
      </aside>

      <main class="main">
        <div class="card">
          <div class="lockbar">
            <button class="btn" id="lockBtn" type="button">锁定</button>
          </div>

          <h1>轻记账（客观统计）</h1>
          <p class="sub" id="dateLine">月份：—</p>

          <label id="planLabel">本月计划花销金额</label>
          <input id="planInput" type="number" inputmode="decimal" placeholder="例如 1000" />
          <div class="row">
            <button class="btn btn-mini" id="planEditBtn" type="button">修改（计算器）</button>
            <button class="btn btn-mini" id="planUndoBtn" type="button">撤销</button>
          </div>

          <label>币种</label>
          <select id="currencySelect">
            <option value="CAD">加币 CAD</option>
            <option value="USD">美元 USD</option>
            <option value="JPY">日元 JPY</option>
            <option value="CNY">人民币 CNY</option>
          </select>

          <label>编辑日期（回改某一天）</label>
          
<div class="datepick-row">
  <p class="muted" id="calHint">可修改历史日期；已记录=绿色框，修改过=红色框；无记录=灰色框；未来日期不可选</p>
  <input id="datePicker" type="date" style="display:none" />
</div>
<!-- 自定义日历弹窗（用于标色） -->
<div id="calOverlay" class="cal-overlay cal-inline" role="dialog" aria-modal="true" aria-label="选择日期">
  <div class="cal">
    <div class="cal-head">
      <div class="cal-nav">
        <button id="calPrev" class="btn btn-mini" type="button">上月</button>
        <button id="calNext" class="btn btn-mini" type="button">下月</button>
      </div>
      <div class="cal-title" id="calTitle">—</div>
      <button id="calClose" class="btn btn-mini" type="button">关闭</button>
    </div>
    <div class="cal-grid" style="padding-top:0;">
      <div class="cal-wd">一</div><div class="cal-wd">二</div><div class="cal-wd">三</div><div class="cal-wd">四</div><div class="cal-wd">五</div><div class="cal-wd">六</div><div class="cal-wd">日</div>
    </div>
    <div id="calGrid" class="cal-grid"></div>
    <div class="cal-foot">
      <button id="calToday" class="btn btn-mini" type="button">今天</button>
      <div class="cal-legend">灰：无记录；绿：已记录；红：修改过。未来日期不可选。</div>
    </div>
  </div>
</div>

          <div class="sub" id="pickerHint" style="margin:6px 0 0;">
            只能编辑到今天（不能写未来）。曾被修改过的日期会标红。
          </div>

          <label id="dayLabel">今日花销</label>
          <input id="dayInput" type="number" inputmode="decimal" placeholder="例如 35" />
          <div class="sub" id="dayLine" style="margin:6px 0 0;">编辑：—</div>
          <div class="row">
            <button class="btn btn-mini" id="dayEditBtn" type="button">修改（计算器）</button>
            <button class="btn btn-mini" id="dayUndoBtn" type="button">撤销</button>
          </div>

          <label>当日花销内容标签（可多选）</label>
          <div class="chips">
            <button class="chip" type="button">停车费</button>
            <button class="chip" type="button">超市购物</button>
            <button class="chip" type="button">外出吃饭</button>
            <button class="chip" type="button">礼物</button>
            <button class="chip" type="button">油费/交通</button>
            <button class="chip" type="button">生活用品</button>
            <button class="chip" type="button">账单/订阅</button>
            <button class="chip" type="button">医疗/药品</button>
            <button class="chip" type="button">娱乐/休闲</button>
            <button class="chip" type="button">保险</button>
            <button class="chip" type="button">其他</button>
          </div>

          <label>备注（可选，可自己写）</label>
          <input id="noteInput" type="text" placeholder="例如：公交月票 / 保险续费 / 临时大额支出" />

          <div class="row" style="margin-top:12px;">
            <button class="btn btn-primary" id="recordBtn" type="button">保存这天</button>
          </div>

          <div class="grid">
            <div class="box">
              <div class="k" id="spentLabel">截至目前已花</div>
              <div class="v" id="spentVal">—</div>
            </div>
            <div class="box">
              <div class="k">日均实际（S ÷ d）</div>
              <div class="v" id="avgVal">—</div>
            </div>
            <div class="box">
              <div class="k">本月剩余</div>
              <div class="v" id="balanceVal">—</div>
            </div>
            <div class="box">
              <div class="k" id="needLabel">为不超支：从明天起后续日均需 ≤</div>
              <div class="v" id="needVal">—</div>
            </div>
          </div>

          <details open>
            <summary>本月每日列表（红色=曾修改）</summary>
            <div class="muted" id="monthList">（暂无记录）</div>
          </details>

          <p class="muted">
            说明：以“日期”为唯一基准；选中哪一天就编辑哪一天；金额=0 也会算作“已记录天数”。未来日期被禁止写入。数据仅加密保存在本机浏览器。
          </p>
        </div>
      </main>

    </div>
  </div>

  <!-- 计算器弹窗 -->
  <div class="modal-mask" id="calcMask" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="calcTitle">
      <div class="modal-hd">
        <div class="modal-title" id="calcTitle">计算器修改</div>
        <button class="modal-close" id="calcClose" type="button">关闭</button>
      </div>

      <div class="calc-screen">
        <div class="calc-expr" id="calcExpr">—</div>
        <div class="calc-val" id="calcVal">—</div>
      </div>

      <div class="calc-grid">
        <button class="calc-btn warn" data-k="C" type="button">清零</button>
        <button class="calc-btn warn" data-k="BS" type="button">退格</button>
        <button class="calc-btn op" data-k="/" type="button">÷</button>
        <button class="calc-btn op" data-k="*" type="button">×</button>

        <button class="calc-btn" data-k="7" type="button">7</button>
        <button class="calc-btn" data-k="8" type="button">8</button>
        <button class="calc-btn" data-k="9" type="button">9</button>
        <button class="calc-btn op" data-k="-" type="button">−</button>

        <button class="calc-btn" data-k="4" type="button">4</button>
        <button class="calc-btn" data-k="5" type="button">5</button>
        <button class="calc-btn" data-k="6" type="button">6</button>
        <button class="calc-btn op" data-k="+" type="button">+</button>

        <button class="calc-btn" data-k="1" type="button">1</button>
        <button class="calc-btn" data-k="2" type="button">2</button>
        <button class="calc-btn" data-k="3" type="button">3</button>
        <button class="calc-btn" data-k="." type="button">.</button>

        <button class="calc-btn" data-k="0" type="button">0</button>
        <button class="calc-btn" data-k="00" type="button">00</button>
        <button class="calc-btn op" data-k="=" type="button">=</button>
        <button class="calc-btn op" id="calcOk" type="button">确认</button>
      </div>

      <div class="calc-actions">
        <button class="btn" id="calcCancel" type="button">取消</button>
        <button class="btn btn-primary" id="calcUse" type="button">把结果写回</button>
      </div>
    </div>
  </div>

  <script>
  // ============================================================
  // 0) 本地“注册/登录”：AES-GCM 加密存储（无服务器、无上传）
  // ============================================================
  const AUTH_KEY = 'budgetTool:auth:v1';
  const DATA_KEY = 'budgetTool:data:v1';
  const LEGACY_KEY = 'budgetTool:v3'; // 兼容旧版明文

  let cryptoKey = null;
  let saveChain = Promise.resolve();

  const te = new TextEncoder();
  const td = new TextDecoder();

  function b64encode(bytes){
    let s = '';
    bytes.forEach(b => s += String.fromCharCode(b));
    return btoa(s);
  }
  function b64decode(b64){
    const s = atob(b64);
    const out = new Uint8Array(s.length);
    for (let i=0;i<s.length;i++) out[i] = s.charCodeAt(i);
    return out;
  }
  function randBytes(n){
    const a = new Uint8Array(n);
    crypto.getRandomValues(a);
    return a;
  }

  async function deriveAesKey(password, salt){
    const baseKey = await crypto.subtle.importKey(
      'raw', te.encode(password), 'PBKDF2', false, ['deriveKey']
    );
    return crypto.subtle.deriveKey(
      { name:'PBKDF2', salt, iterations: 150000, hash:'SHA-256' },
      baseKey,
      { name:'AES-GCM', length: 256 },
      false,
      ['encrypt','decrypt']
    );
  }

  async function aesEncrypt(key, plaintext){
    const iv = randBytes(12);
    const ct = await crypto.subtle.encrypt(
      { name:'AES-GCM', iv },
      key,
      te.encode(plaintext)
    );
    return { iv: b64encode(iv), ct: b64encode(new Uint8Array(ct)) };
  }

  async function aesDecrypt(key, ivB64, ctB64){
    const iv = b64decode(ivB64);
    const ct = b64decode(ctB64);
    const pt = await crypto.subtle.decrypt(
      { name:'AES-GCM', iv },
      key,
      ct
    );
    return td.decode(pt);
  }

  function getAuthRecord(){
    try { return JSON.parse(localStorage.getItem(AUTH_KEY) || 'null'); }
    catch { return null; }
  }
  function setAuthRecord(obj){
    localStorage.setItem(AUTH_KEY, JSON.stringify(obj));
  }

  async function hasPassword(){
    return !!getAuthRecord();
  }

  async function createPassword(password){
    const salt = randBytes(16);
    const key = await deriveAesKey(password, salt);
    const test = await aesEncrypt(key, 'OK');
    setAuthRecord({ salt: b64encode(salt), testIv: test.iv, testCt: test.ct, v: 1 });
    cryptoKey = key;

    // 兼容：如有旧明文数据，创建密码后自动迁移并删除明文
    const legacy = localStorage.getItem(LEGACY_KEY);
    if (legacy && !localStorage.getItem(DATA_KEY)) {
      try {
        const parsed = JSON.parse(legacy);
        await saveAll(parsed);
        localStorage.removeItem(LEGACY_KEY);
      } catch {
        // 如果旧数据损坏，就不迁移
      }
    }
  }

  async function unlockWithPassword(password){
    const rec = getAuthRecord();
    if (!rec) return false;
    const salt = b64decode(rec.salt);
    const key = await deriveAesKey(password, salt);

    try {
      const ok = await aesDecrypt(key, rec.testIv, rec.testCt);
      if (ok !== 'OK') return false;
      cryptoKey = key;
      return true;
    } catch {
      return false;
    }
  }

  function lockNow(){
    cryptoKey = null;
  }

  async function loadAll(){
    // 未解锁时不返回任何数据
    if (!cryptoKey) return {};
    const raw = localStorage.getItem(DATA_KEY);
    if (!raw) return {};
    try {
      const obj = JSON.parse(raw);
      const json = await aesDecrypt(cryptoKey, obj.iv, obj.ct);
      return JSON.parse(json);
    } catch {
      return {};
    }
  }

  function saveAll(allObj){
    // 排队保存，避免并发覆盖
    if (!cryptoKey) return Promise.resolve();
    const json = JSON.stringify(allObj);
    saveChain = saveChain.then(async ()=>{
      const enc = await aesEncrypt(cryptoKey, json);
      localStorage.setItem(DATA_KEY, JSON.stringify(enc));
    }).catch(()=>{});
    return saveChain;
  }

  function wipeAllData(){
    localStorage.removeItem(AUTH_KEY);
    localStorage.removeItem(DATA_KEY);
    localStorage.removeItem(LEGACY_KEY);
  }

  // ============================================================
  // 1) 业务逻辑（原记账程序）
  // ============================================================

  // ===== 日期工具 =====
  const weekMap = ['周日','周一','周二','周三','周四','周五','周六'];
  function pad2(n){ return String(n).padStart(2,'0'); }
  function parseYm(ymStr){
    const [y,m] = ymStr.split('-').map(Number);
    return { y, m };
  }
  function daysInMonthOf(ymStr){
    const { y, m } = parseYm(ymStr);
    return new Date(y, m, 0).getDate();
  }
  function parseYmd(ymdStr){
    const [y,m,d] = ymdStr.split('-').map(Number);
    return new Date(y, (m||1)-1, d||1);
  }
  function weekdayOf(ymdStr){
    return weekMap[parseYmd(ymdStr).getDay()];
  }
  function monthEndYmd(ymStr){
    return `${ymStr}-${pad2(daysInMonthOf(ymStr))}`;
  }

  // ===== 今日（真实） =====
  const now = new Date();
  const currentYm = `${now.getFullYear()}-${pad2(now.getMonth()+1)}`;
  const todayYmd = `${now.getFullYear()}-${pad2(now.getMonth()+1)}-${pad2(now.getDate())}`;
  const currentDayIndex = now.getDate();

  // ===== 运行时数据 =====
  let all = {};
  let activeYm = currentYm;
  let monthData = null;

  // ===== DOM =====
  const appRoot = document.getElementById('appRoot');
  const authMask = document.getElementById('authMask');
  const authTitle = document.getElementById('authTitle');
  const authSub = document.getElementById('authSub');
  const authLabel = document.getElementById('authLabel');
  const authPass = document.getElementById('authPass');
  const authPrimary = document.getElementById('authPrimary');
  const authSecondary = document.getElementById('authSecondary');
  const authMsg = document.getElementById('authMsg');
  const authOk = document.getElementById('authOk');

  const monthNav = document.getElementById('monthNav');
  const dateLine = document.getElementById('dateLine');
  const spentLabel = document.getElementById('spentLabel');
  const needLabel = document.getElementById('needLabel');

  const datePicker = document.getElementById('datePicker');

  // ===== 自定义日历（用于标色：灰/绿/红）=====
  const openCalBtn = document.getElementById('openCalBtn');
  const calOverlay = document.getElementById('calOverlay');
  const calGrid = document.getElementById('calGrid');
  const calTitle = document.getElementById('calTitle');
  const calPrev = document.getElementById('calPrev');
  const calNext = document.getElementById('calNext');
  const calClose = document.getElementById('calClose');
  const calTodayBtn = document.getElementById('calToday');

  let calYm = null; // 当前日历显示的月份：YYYY-MM

  function pad2(n){ return String(n).padStart(2,'0'); }

  function ymAdd(ym, delta){
    const [y0,m0] = ym.split('-').map(Number);
    let y = y0, m = m0 + delta;
    while (m <= 0) { m += 12; y -= 1; }
    while (m >= 13) { m -= 12; y += 1; }
    return `${y}-${pad2(m)}`;
  }

  function daysInMonth(y, m){ return new Date(y, m, 0).getDate(); } // m: 1-12

  function ymdOf(ym, d){
    return `${ym}-${pad2(d)}`;
  }

  function dayFlags(ym, d){
    const dateStr = ymdOf(ym, d);
    const md = ensureMonth(ym); // 不存在则创建空月
    const rec = normalizeRecord(md.days[dateStr]);
    const recorded = (rec.total !== null) || (Array.isArray(rec.tags) && rec.tags.length > 0);
    const edited = !!rec.edited;
    const future = isFutureDate(dateStr);
    return { dateStr, recorded, edited, future };
  }

  function renderCalendar(ym){
    if (!calGrid) return;
    calYm = ym;
    const [y,m] = ym.split('-').map(Number);
    calTitle.textContent = `${y}年${pad2(m)}月`;

    // 下月按钮：不能超过当前月份
    const nextYm = ymAdd(ym, 1);
    calNext.disabled = (typeof currentYm === 'string' && nextYm > currentYm);

    calGrid.innerHTML = '';

    // 计算本月 1 号是星期几（以周一为第一列）
    const first = new Date(y, m-1, 1); // JS: 月从0开始
    let wd = first.getDay(); // 0=周日..6=周六
    wd = (wd === 0) ? 7 : wd; // 1..7（周一..周日）
    const leading = wd - 1;

    for (let i=0;i<leading;i++){
      const div = document.createElement('div');
      div.className = 'cal-day empty';
      div.textContent = '';
      calGrid.appendChild(div);
    }

    const dim = daysInMonth(y, m);
    for (let d=1; d<=dim; d++){
      const {dateStr, recorded, edited, future} = dayFlags(ym, d);
      const btn = document.createElement('div');
      btn.className = 'cal-day';
      if (recorded) btn.classList.add('recorded');
      if (edited) btn.classList.add('edited');
      if (future) btn.classList.add('disabled');
      if (dateStr === editYmd) btn.classList.add('selected');

      btn.textContent = String(d);

      if (!future){
        btn.addEventListener('click', ()=>{
          closeCalendar();
          switchEditDate(dateStr);
        });
      }
      calGrid.appendChild(btn);
    }
  }

  function openCalendar(){
    const baseYm = (editYmd && String(editYmd).slice(0,7)) || activeYm;
    renderCalendar(baseYm);
    // 内嵌模式：不需要显示/隐藏遮罩
    if (!calOverlay.classList.contains('cal-inline')) {
      calOverlay.classList.remove('hidden');
    }
  }

  function closeCalendar(){
    if (!calOverlay.classList.contains('cal-inline')) {
      calOverlay.classList.add('hidden');
    }
  }

  if (openCalBtn && calOverlay){
    openCalBtn.addEventListener('click', openCalendar);
    calClose.addEventListener('click', closeCalendar);
    calOverlay.addEventListener('click', (e)=>{ if (e.target === calOverlay) closeCalendar(); });
    calTodayBtn.addEventListener('click', ()=>{ closeCalendar(); switchEditDate(todayYmd); });

    calPrev.addEventListener('click', ()=>{ renderCalendar(ymAdd(calYm || activeYm, -1)); });
    calNext.addEventListener('click', ()=>{
      const target = ymAdd(calYm || activeYm, 1);
      if (typeof currentYm === 'string' && target > currentYm) return;
      renderCalendar(target);
    });
  }

  const dayLine = document.getElementById('dayLine');

  const planInput = document.getElementById('planInput');
  const dayInput = document.getElementById('dayInput');

  const planUndoBtn = document.getElementById('planUndoBtn');
  const dayUndoBtn = document.getElementById('dayUndoBtn');
  const recordBtn = document.getElementById('recordBtn');

  const spentVal = document.getElementById('spentVal');
  const avgVal = document.getElementById('avgVal');
  const balanceVal = document.getElementById('balanceVal');
  const needVal = document.getElementById('needVal');

  const monthList = document.getElementById('monthList');
  const chipButtons = Array.from(document.querySelectorAll('.chip'));
  const noteInput = document.getElementById('noteInput');
  const currencySelect = document.getElementById('currencySelect');
  const planLabelEl = document.getElementById('planLabel');
  const dayLabelEl = document.getElementById('dayLabel');

  const lockBtn = document.getElementById('lockBtn');

  // ===== 存储结构 =====
  function ensureMonth(ym){
    all.months = all.months || {};
    if (!all.months[ym]) {
      all.months[ym] = {
        plan: null,
        days: {},
        undo: { plan: [], day: [] },
        startFrom: null,
        started: false
      };
    } else {
      all.months[ym].undo = all.months[ym].undo || { plan: [], day: [] };
      all.months[ym].undo.plan = all.months[ym].undo.plan || [];
      all.months[ym].undo.day = all.months[ym].undo.day || [];
      all.months[ym].startFrom = all.months[ym].startFrom || null;
      all.months[ym].started = all.months[ym].started || false;
    }
    return all.months[ym];
  }

  // ===== 保存按钮提示状态 =====
  let saveState = 'idle'; // idle | dirty | saved
  let savedToastTimer = null;
  function setSaveState(state){
    saveState = state;
    if (savedToastTimer) { clearTimeout(savedToastTimer); savedToastTimer = null; }
    recordBtn.classList.remove('dirty','saved');
    if (state === 'dirty') {
      recordBtn.classList.add('dirty');
      recordBtn.textContent = '请保存';
    } else if (state === 'saved') {
      recordBtn.classList.add('saved');
      recordBtn.textContent = '已保存';
      savedToastTimer = setTimeout(()=>{
        recordBtn.classList.remove('saved');
        recordBtn.textContent = '保存这天';
        saveState = 'idle';
      }, 1200);
    } else {
      recordBtn.textContent = '保存这天';
    }
  }
  function markDirty(){ if (saveState !== 'dirty') setSaveState('dirty'); }
  function markSaved(){ setSaveState('saved'); }

  // ===== 工具 =====
  function getCurrency(){
    all.settings = all.settings || {};
    all.settings.currency = all.settings.currency || 'CAD';
    return all.settings.currency;
  }
  function decimalsForCurrency(cur){
    return (cur === 'JPY') ? 0 : 2;
  }
  const fmt = (n) => {
    if (n === null || n === undefined || Number.isNaN(n)) return '—';
    const cur = getCurrency();
    const dec = decimalsForCurrency(cur);
    const v = Number(n);
    return `${v.toFixed(dec)} ${cur}`;
  };
  function updateCurrencyUI(){
    const cur = getCurrency();
    if (currencySelect) currencySelect.value = cur;
    if (planLabelEl) planLabelEl.textContent = `本月计划花销金额（${cur}）`;
    if (dayLabelEl) dayLabelEl.textContent = `今日花销（${cur}）`;
  }
  function isFutureDate(ymdStr){
    return ymdStr > todayYmd; // YYYY-MM-DD 字符串可直接比
  }
  function getSelectedTags(){
    return chipButtons.filter(b => b.classList.contains('on')).map(b => b.textContent.trim());
  }
  function setSelectedTags(tags){
    const set = new Set(tags || []);
    chipButtons.forEach(b => b.classList.toggle('on', set.has(b.textContent.trim())));
  }
  function normalizeRecord(rec){
    if (!rec) return { total: null, tags: [], note: '', createdAt: null, updatedAt: null, edited: false };
    return {
      total: (typeof rec.total === 'number') ? rec.total : (rec.total ?? null),
      tags: Array.isArray(rec.tags) ? rec.tags : [],
      note: (typeof rec.note === 'string') ? rec.note : (rec.note ?? ''),
      createdAt: rec.createdAt ?? null,
      updatedAt: rec.updatedAt ?? null,
      edited: !!rec.edited
    };
  }
  function getDayRecord(dateStr){
    return normalizeRecord(monthData.days[dateStr]);
  }

  // ===== 编辑日期 =====
  let editYmd = todayYmd;

  function updateDatePickerRange(){
    // 允许选择任意历史日期，但禁止未来日期
    datePicker.min = '2000-01-01';
    datePicker.max = todayYmd;
  }

  function renderTopLines(){
    dateLine.textContent = `月份：${activeYm}`;
    if (activeYm === currentYm) {
      spentLabel.textContent = '截至目前已花';
      needLabel.textContent = '为不超支：从明天起后续日均需 ≤';
    } else {
      spentLabel.textContent = '本月已花';
      needLabel.textContent = '该月已结束';
    }
  }

  function renderEditLine(){
    const rec = getDayRecord(editYmd);
    datePicker.classList.toggle('edited', !!rec.edited);
    const datePart = rec.edited
      ? `<span style="color:#c62828;font-weight:700;">${editYmd}</span>`
      : `<span>${editYmd}</span>`;
    dayLine.innerHTML = `编辑：${datePart}（${weekdayOf(editYmd)}）`;
  }

  function flushSaveNow(){
    if (saveState !== 'dirty') return;
    const v = dayInput.value.trim();
    const n = v === '' ? null : Number(v);
    if (v !== '' && Number.isNaN(n)) return;
    commitDay(editYmd, n, getSelectedTags(), (noteInput ? noteInput.value : ""));
  }

  function switchEditDate(newYmd){
    flushSaveNow();

    if (!newYmd) { datePicker.value = editYmd; return; }
    if (isFutureDate(newYmd)) {
      alert('不能填写未来日期（例如明天）。');
      datePicker.value = editYmd;
      return;
    }

    const ym = newYmd.slice(0,7);
    if (ym !== activeYm) {
      if (ym > currentYm) {
        alert('未来月份不可编辑。');
        datePicker.value = editYmd;
        return;
      }
      switchMonth(ym, newYmd);
      return;
    }

    editYmd = newYmd;
    const rec = getDayRecord(editYmd);
    dayInput.value = (rec.total ?? '') === null ? '' : (rec.total ?? '');
    setSelectedTags(rec.tags || []);
    if (noteInput) noteInput.value = rec.note || "";
    renderEditLine();
    // 日历保持展开：每次刷新 UI 都重绘当前月份
    if (calOverlay && calOverlay.classList.contains('cal-inline')) { openCalendar(); }
    renderStatsAndList();
    setSaveState('idle');
  }

  // ===== 统计 =====
  function cutoffYmdForActiveMonth(){
    return (activeYm === currentYm) ? todayYmd : monthEndYmd(activeYm);
  }

  function calcSpentAndRecordedDays(){
    let sum = 0;
    let days = 0;
    const start = monthData.startFrom || `${activeYm}-01`;
    const cutoff = cutoffYmdForActiveMonth();

    for (const [dateStr, rec0] of Object.entries(monthData.days)) {
      if (!dateStr.startsWith(activeYm + '-')) continue;
      if (dateStr < start) continue;
      if (dateStr > cutoff) continue;

      const rec = normalizeRecord(rec0);
      if (typeof rec.total === 'number') {
        sum += rec.total;
        days += 1;
      }
    }
    return { sum, days };
  }

  function setBalanceDisplay(balance){
    if (balance === null) {
      balanceVal.textContent = '—';
      balanceVal.style.color = '#111';
      return;
    }
    const abs = Math.abs(balance);
    if (balance > 0) {
      balanceVal.textContent = `${fmt(abs)}  剩余`;
      balanceVal.style.color = '#2e7d32';
    } else if (balance < 0) {
      balanceVal.textContent = `${fmt(abs)}  超支`;
      balanceVal.style.color = '#c62828';
    } else {
      balanceVal.textContent = `${fmt(0)}  平衡`;
      balanceVal.style.color = '#111';
    }
  }

  function renderStatsAndList(){
    const P = (typeof monthData.plan === 'number') ? monthData.plan : null;
    const { sum: S, days: d } = calcSpentAndRecordedDays();
    const A = (d > 0) ? (S / d) : null;
    const B = (P === null) ? null : (P - S);

    spentVal.textContent = fmt(S);
    avgVal.textContent = fmt(A);
    setBalanceDisplay(B);

    if (activeYm === currentYm) {
      const remainingDays = daysInMonthOf(activeYm) - currentDayIndex;
      const R = (P === null || remainingDays <= 0) ? null : Math.max(0, (P - S) / remainingDays);
      needVal.textContent = (R === null) ? '—' : fmt(R);
    } else {
      needVal.textContent = '—';
    }

    const keys = Object.keys(monthData.days).filter(k => k.startsWith(activeYm+'-')).sort();
    if (!keys.length) {
      monthList.textContent = '（暂无记录）';
      return;
    }

    monthList.innerHTML = keys.map(k => {
      const rec = normalizeRecord(monthData.days[k]);
      const money = (typeof rec.total === 'number') ? fmt(rec.total) : '—';
      const tags = (rec.tags && rec.tags.length) ? rec.tags.join(' / ') : '（无标签）';
      const note = (rec.note && String(rec.note).trim()) ? String(rec.note).trim() : '';
      const dateHtml = rec.edited
        ? `<span style="color:#c62828;font-weight:700;">${k}</span>`
        : `<span>${k}</span>`;
      const editedBadge = rec.edited ? ` <span style="color:#c62828;">（已改）</span>` : '';
      return `<div style="padding:6px 0;border-bottom:1px dashed #eee;">
                <strong>${dateHtml}</strong>${editedBadge} ｜ ${money}<br/>
                <span style="color:#666;font-size:13px;">${tags}</span>${note ? `<div style="color:#666;font-size:13px;margin-top:2px;">备注：${escapeHtml(note)}</div>` : ``}
              </div>`;
    }).join('');
  }

  // ===== 写入与撤销 =====
  function commitPlan(newVal){
    const prev = monthData.plan;
    monthData.undo.plan.push(prev);
    if (monthData.undo.plan.length > 30) monthData.undo.plan.shift();
    monthData.plan = newVal;
    saveAll(all);
    renderStatsAndList();
  }

  function commitDay(dateStr, newTotal, newTags, newNote){
    if (isFutureDate(dateStr)) {
      alert('不能填写未来日期（例如明天）。');
      return;
    }

    const existing0 = monthData.days[dateStr];
    const existing = normalizeRecord(existing0);

    monthData.undo.day.push({
      date: dateStr,
      prev: { ...existing, tags: existing.tags.slice() }
    });
    if (monthData.undo.day.length > 120) monthData.undo.day.shift();

    const nowTs = Date.now();
    const isFirstWrite = !existing0 || existing.createdAt === null;
    const edited = isFirstWrite ? false : true;

    monthData.days[dateStr] = {
      total: newTotal,
      tags: Array.isArray(newTags) ? newTags.slice() : [],
      note: (newNote || "").trim(),
      createdAt: isFirstWrite ? nowTs : existing.createdAt,
      updatedAt: nowTs,
      edited: existing.edited || edited
    };

    monthData.started = true;
    if (!monthData.startFrom || dateStr < monthData.startFrom) monthData.startFrom = dateStr;

    saveAll(all);
    renderStatsAndList();
    renderEditLine();
    markSaved();
    if (typeof calOverlay !== 'undefined' && calOverlay && !calOverlay.classList.contains('hidden')) {
      try { renderCalendar(calYm || activeYm); } catch(e) {}
    }
  }

  function popUndoForDate(dateStr){
    for (let i = monthData.undo.day.length - 1; i >= 0; i--) {
      if (monthData.undo.day[i].date === dateStr) {
        return monthData.undo.day.splice(i, 1)[0];
      }
    }
    return null;
  }

  // ===== 防抖 =====
  function debounce(fn, wait=300){
    let t = null;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), wait);
    };
  }
  const savePlanDebounced = debounce((n) => commitPlan(n), 300);
  const saveDayDebounced = debounce((dateStr, n, tags, note) => commitDay(dateStr, n, tags, note), 300);

  // ===== 输入监听 =====
  if (currencySelect) {
    currencySelect.addEventListener('change', ()=>{
      all.settings = all.settings || {};
      all.settings.currency = currencySelect.value || 'CAD';
      saveAll(all);
      updateCurrencyUI();
      renderStatsAndList();
    });
  }

  planInput.addEventListener('input', () => {
    const v = planInput.value.trim();
    const n = v === '' ? null : Number(v);
    if (v !== '' && Number.isNaN(n)) return;
    savePlanDebounced(n);
  });

  dayInput.addEventListener('input', () => {
    if (isFutureDate(editYmd)) return;
    const v = dayInput.value.trim();
    const n = v === '' ? null : Number(v);
    if (v !== '' && Number.isNaN(n)) return;
    markDirty();
    saveDayDebounced(editYmd, n, getSelectedTags(), (noteInput ? noteInput.value : ""));
  });

  if (noteInput) {
    noteInput.addEventListener('input', () => {
      if (isFutureDate(editYmd)) return;
      markDirty();
      const v = dayInput.value.trim();
      const n = v === '' ? null : Number(v);
      if (v !== '' && Number.isNaN(n)) return;
      saveDayDebounced(editYmd, n, getSelectedTags(), noteInput.value);
    });
  }

  chipButtons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if (isFutureDate(editYmd)) return;

      btn.classList.toggle('on');
      markDirty();
      const rec = getDayRecord(editYmd);
      const currentTotal = (typeof rec.total === 'number') ? rec.total : null;
      saveDayDebounced(editYmd, currentTotal, getSelectedTags(), (noteInput ? noteInput.value : ""));
    });
  });

  recordBtn.addEventListener('click', ()=>{
    if (isFutureDate(editYmd)) return;

    const v = dayInput.value.trim();
    const n = v === '' ? null : Number(v);
    if (v !== '' && Number.isNaN(n)) return;
    commitDay(editYmd, n, getSelectedTags(), (noteInput ? noteInput.value : ""));
  });

  planUndoBtn.addEventListener('click', ()=>{
    if (!monthData.undo.plan.length) return;
    const prev = monthData.undo.plan.pop();
    monthData.plan = prev;
    planInput.value = (prev ?? '') === null ? '' : (prev ?? '');
    saveAll(all);
    renderStatsAndList();
  });

  dayUndoBtn.addEventListener('click', ()=>{
    const u = popUndoForDate(editYmd);
    if (!u) return;

    monthData.days[editYmd] = u.prev;
    saveAll(all);

    const rec = normalizeRecord(u.prev);
    dayInput.value = (rec.total ?? '') === null ? '' : (rec.total ?? '');
    setSelectedTags(rec.tags || []);
    if (noteInput) noteInput.value = rec.note || "";
    renderStatsAndList();
    renderEditLine();
    markSaved();
  });

  window.addEventListener('pagehide', flushSaveNow);
  document.addEventListener('visibilitychange', ()=> { if (document.hidden) flushSaveNow(); });

  datePicker.addEventListener('change', ()=>{
    const picked = datePicker.value;
    if (!picked) return;
    if (isFutureDate(picked)) {
      alert('不能填写未来日期（例如明天）。');
      datePicker.value = editYmd;
      return;
    }
    switchEditDate(picked);
  });

  // ===== 月份侧边栏 =====
  function monthRecordedDaysCount(ymStr){
    const md = ensureMonth(ymStr);
    let c = 0;
    for (const [k, rec0] of Object.entries(md.days)) {
      if (!k.startsWith(ymStr + '-')) continue;
      const rec = normalizeRecord(rec0);
      if (typeof rec.total === 'number') c++;
    }
    return c;
  }

  function buildMonthList(){
    const months = new Set(Object.keys((all.months || {})));
    months.add(currentYm);

    const arr = Array.from(months)
      .filter(m => m <= currentYm)
      .sort((a,b)=> (a>b ? -1 : 1));

    monthNav.innerHTML = arr.map(m=>{
      const d = monthRecordedDaysCount(m);
      const active = (m === activeYm) ? 'active' : '';
      return `<button class="month-item ${active}" data-ym="${m}" type="button">
                <span>${m}</span>
                <small>${d}天</small>
              </button>`;
    }).join('');

    monthNav.querySelectorAll('.month-item').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const target = btn.getAttribute('data-ym');
        if (!target) return;
        switchMonth(target);
      });
    });
  }

  function pickDefaultEditDateForMonth(ymStr){
    const md = ensureMonth(ymStr);
    const keys = Object.keys(md.days)
      .filter(k => k.startsWith(ymStr+'-') && typeof normalizeRecord(md.days[k]).total === 'number')
      .sort();
    if (keys.length) return keys[keys.length - 1];
    return (ymStr === currentYm) ? todayYmd : `${ymStr}-01`;
  }

  function switchMonth(newYm, desiredYmd = null){
    flushSaveNow();

    if (newYm > currentYm) {
      alert('未来月份不可编辑。');
      return;
    }

    activeYm = newYm;
    monthData = ensureMonth(activeYm);
    updateCurrencyUI();

    if (!monthData.started && (!monthData.startFrom || !String(monthData.startFrom).startsWith(activeYm + '-'))) {
      monthData.startFrom = `${activeYm}-01`;
      saveAll(all);
    }

    planInput.value = (monthData.plan ?? '') === null ? '' : (monthData.plan ?? '');

    updateDatePickerRange();

    if (desiredYmd && String(desiredYmd).startsWith(activeYm + '-')) {
      editYmd = desiredYmd;
    } else {
      editYmd = pickDefaultEditDateForMonth(activeYm);
    }

    if (isFutureDate(editYmd)) editYmd = todayYmd;

    datePicker.value = editYmd;

    const rec = getDayRecord(editYmd);
    dayInput.value = (rec.total ?? '') === null ? '' : (rec.total ?? '');
    setSelectedTags(rec.tags || []);
    if (noteInput) noteInput.value = rec.note || "";

    renderTopLines();
    renderEditLine();
    // 日历保持展开：每次刷新 UI 都重绘当前月份
    if (calOverlay && calOverlay.classList.contains('cal-inline')) { openCalendar(); }
    renderStatsAndList();
    setSaveState('idle');
    buildMonthList();
  }

  // ===== 计算器 =====
  const calcMask = document.getElementById('calcMask');
  const calcClose = document.getElementById('calcClose');
  const calcCancel = document.getElementById('calcCancel');
  const calcUse = document.getElementById('calcUse');
  const calcOk = document.getElementById('calcOk');
  const calcExprEl = document.getElementById('calcExpr');
  const calcValEl = document.getElementById('calcVal');

  let calcTarget = null;   // 'plan' | 'day'
  let expr = '';
  let lastValue = null;

  function showCalc(target){
    calcTarget = target;
    const base = target === 'plan'
      ? (planInput.value.trim() || (typeof monthData.plan === 'number' ? String(monthData.plan) : ''))
      : (dayInput.value.trim() || (getDayRecord(editYmd).total != null ? String(getDayRecord(editYmd).total) : ''));
    expr = (base === '' ? '0' : base);
    renderCalc();
    calcMask.style.display = 'flex';
    calcMask.setAttribute('aria-hidden', 'false');
  }
  function hideCalc(){
    calcMask.style.display = 'none';
    calcMask.setAttribute('aria-hidden', 'true');
    calcTarget = null;
  }
  function safeEval(s){
    const ok = /^[0-9+\-*/().\s]+$/.test(s);
    if (!ok) return null;
    try {
      const out = Function(`"use strict"; return (${s});`)();
      if (typeof out !== 'number' || !isFinite(out)) return null;
      return Math.round(out * 100) / 100;
    } catch { return null; }
  }
  function renderCalc(){
    calcExprEl.textContent = expr;
    const v = safeEval(expr);
    lastValue = v;
    calcValEl.textContent = (v === null) ? '表达式无效' : fmt(v);
  }
  function appendKey(k){
    if (k === 'C') { expr = '0'; renderCalc(); return; }
    if (k === 'BS') { expr = expr.length <= 1 ? '0' : expr.slice(0, -1); renderCalc(); return; }
    if (k === '=') { renderCalc(); return; }
    if (expr === '0' && /^[0-9]$/.test(k)) expr = k;
    else expr += k;
    renderCalc();
  }

  calcMask.addEventListener('click', (e)=>{ if (e.target === calcMask) hideCalc(); });
  calcClose.addEventListener('click', hideCalc);
  calcCancel.addEventListener('click', hideCalc);
  document.querySelectorAll('.calc-btn[data-k]').forEach(btn=>{
    btn.addEventListener('click', ()=> appendKey(btn.dataset.k));
  });

  function applyCalcResult(){
    if (lastValue === null) { alert('表达式无效，请修改后再确认'); return; }
    if (calcTarget === 'plan') {
      planInput.value = String(lastValue);
      commitPlan(lastValue);
    } else if (calcTarget === 'day') {
      if (isFutureDate(editYmd)) { alert('不能填写未来日期。'); return; }
      dayInput.value = String(lastValue);
      markDirty();
      commitDay(editYmd, lastValue, getSelectedTags());
    }
    hideCalc();
  }
  calcOk.addEventListener('click', applyCalcResult);
  calcUse.addEventListener('click', applyCalcResult);

  document.getElementById('planEditBtn').addEventListener('click', ()=> showCalc('plan'));
  document.getElementById('dayEditBtn').addEventListener('click', ()=> showCalc('day'));

  // ===== 锁定 =====
  lockBtn.addEventListener('click', ()=>{
    flushSaveNow();
    lockNow();
    showAuth();
  });

  // ===== 初始化 =====
  function hydrateUI(){
    monthData = ensureMonth(activeYm);

    if (!monthData.started && (!monthData.startFrom || !String(monthData.startFrom).startsWith(activeYm + '-'))) {
      monthData.startFrom = todayYmd;
      saveAll(all);
    }

    buildMonthList();
    updateDatePickerRange();

    editYmd = todayYmd;
    datePicker.value = editYmd;

    planInput.value = (monthData.plan ?? '') === null ? '' : (monthData.plan ?? '');
    const rec = getDayRecord(editYmd);
    dayInput.value = (rec.total ?? '') === null ? '' : (rec.total ?? '');
    setSelectedTags(rec.tags || []);

    renderTopLines();
    renderEditLine();
    // 日历保持展开：每次刷新 UI 都重绘当前月份
    if (calOverlay && calOverlay.classList.contains('cal-inline')) { openCalendar(); }
    renderStatsAndList();
    setSaveState('idle');
  }

  // ============================================================
  // 2) 登录/注册交互
  // ============================================================
  function showAuth(msg='', okMsg=''){
    authMsg.style.display = msg ? 'block' : 'none';
    authMsg.textContent = msg;
    authOk.style.display = okMsg ? 'block' : 'none';
    authOk.textContent = okMsg;

    authPass.value = '';
    authMask.style.display = 'flex';
    appRoot.style.visibility = 'hidden';
    authPass.focus();
  }

  function hideAuth(){
    authMask.style.display = 'none';
    appRoot.style.visibility = 'visible';
  }

  async function setupAuthUI(){
    const exist = await hasPassword();
    if (exist) {
      authTitle.textContent = '解锁账本';
      authLabel.textContent = '密码';
      authPass.placeholder = '输入密码';
      authPrimary.textContent = '解锁';
      authSecondary.style.display = 'none';
      authSub.textContent = '为隐私，本账本数据会加密保存在本机浏览器里。没有任何上传、没有服务器。';
    } else {
      authTitle.textContent = '创建账本密码';
      authLabel.textContent = '设置密码';
      authPass.placeholder = '设置一个密码（请记住）';
      authPrimary.textContent = '创建并进入';
      authSecondary.style.display = 'none';
      authSub.textContent = '首次使用请设置密码。以后每次打开都需要解锁，避免同设备/同浏览器被别人看到。';
    }
  }

  authPrimary.addEventListener('click', async ()=>{
    const pwd = authPass.value || '';
    if (pwd.length < 4) {
      showAuth('密码至少 4 位。');
      return;
    }
    const exist = await hasPassword();
    if (!exist) {
      try {
        await createPassword(pwd);
        all = await loadAll();
        activeYm = currentYm;
        hydrateUI();
        hideAuth();
      } catch {
        showAuth('创建失败，请重试。');
      }
    } else {
      const ok = await unlockWithPassword(pwd);
      if (!ok) {
        showAuth('密码错误。');
        return;
      }
      all = await loadAll();
      activeYm = currentYm;
      hydrateUI();
      hideAuth();
    }
  });

  authPass.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter') authPrimary.click();
  });

  // ============================================================
  // 3) 启动
  // ============================================================
  async function boot(){
    if (!window.crypto || !crypto.subtle) {
      alert('此浏览器不支持加密功能（Web Crypto）。请用 Chrome / Safari / Edge 的最新版。');
      appRoot.style.visibility = 'visible';
      return;
    }

    await setupAuthUI();

    const exist = await hasPassword();
    if (!exist) {
      showAuth('', '');
      return;
    }

    // 有密码：先显示解锁
    showAuth('', '');
  }

  boot();
  </script>
</body>
</html>
